{# app/views/events/appointment #}

{% extends 'layout-app.html' %}

{% set gridColumn = "nhsuk-grid-column-full" %}

{% set referrerChain = currentUrl %}

{% set back = {
  href: "/clinics/" + clinicId,
  text: "Back to clinic"
} %}

{% block pageContent %}

  {# Banner if event is in progress by someone else #}
  {% if (event | isInProgress) and not event | startedByCurrentUser %}
    {% set notificationBannerHtml %}
      <p class="nhsuk-notification-banner__heading">
        This appointment is currently being run by {{ event.sessionDetails.startedBy | getUsername({
          format: 'short',
          identifyCurrentUser: true
        }) }}.
      </p>
    {% endset %}

    {{ notificationBanner({
      html: notificationBannerHtml,
      type: "information"
    }) }}
  {% endif %}


  <div class="app-header-with-status">
    <h1 class="nhsuk-heading-l">
      <span class="nhsuk-caption-l">
        {{ clinic.clinicType | sentenceCase }} appointment
      </span>
      {{ (pageHeading | default(participant | getFullName)) | safe }}
    </h1>

    <div class="app-header-with-status__status-tag">
      {% set statusTagId = "status-tag-" + event.id %}
      {{ event.status | toTag({
        id: statusTagId,
        classes: "nhsuk-u-margin-bottom-2"
      }) }}

      {% if event.status == 'event_scheduled' %}
        {{ appCheckIn({
          clinicId: clinicId,
          event: event,
          participant: participant,
          confirmIdentityOnCheckIn: true if data.settings.screening.confirmIdentityOnCheckIn == 'true' else false,
          statusTagId: statusTagId
        }) }}

      {% endif %}
      {# {{ statusHtml | safe }} #}
      <br>
      {{ buttonMenu({
        items: [

          {
            text: "Reschedule appointment",
            href: "#" | urlWithReferrer(currentUrl),
            classes: "nhsuk-button--secondary"
          },
          {
            text: "Cancel appointment",
            href: "#" | urlWithReferrer(currentUrl),
            classes: "nhsuk-button--secondary"
          },
          {
            text: "Make this appointment a special appointment" if not event | isSpecialAppointment else "Change special appointment details",
            href: eventId ~ "/special-appointment/edit" | urlWithReferrer(currentUrl),
            classes: "nhsuk-button--secondary"
          }
        ],
        button: {
          text: "Appointment actions",
          classes: "nhsuk-button--secondary"
        },
        alignMenu: "right"
      }) }}
    </div>
  </div>

  <p class="app-text-grey">
    <span>NHS Number: {{ participant.medicalInformation.nhsNumber | formatNhsNumber }}</span>
    {# <span class="nhsuk-u-margin-left-4">SX Number: {{ participant.sxNumber }}</span> #}
  </p>

  {# {% set appointmentTimeHtml -%}
    <p>{{ clinic.date | formatDate }} ({{ clinic.date | formatRelativeDate }})</p>
    <p>{{ event.timing.startTime | formatTimeString }} ({{ event.timing.duration }} minutes)</p>
  {% endset %}

  {{ appointmentTimeHtml }} #}

  <p>
    {{ event.timing.startTime | formatTimeString }} ({{ event.timing.duration }} minutes) - {{ clinic.date | formatDate }} ({{ clinic.date | formatRelativeDate }})
    {# <span class="nhsuk-u-margin-left-3">
      <a href="#">Reschedule appointment</a>
    </span> #}
  </p>

  <p class="nhsuk-u-margin-bottom-4"><a href="{{ '/participants/' + participant.id | urlWithReferrer(currentUrl) }}">View participant record</a></p>

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      {% if event | hasNotStarted and currentUser | isClinician %}
        {{ appHiddenInput({
          name: "event[workflowStatus][appointment]",
          value: "started"
        }) }}
        {{ button({
          text: "Start this appointment",
          classes: ""
        }) }}
      {% endif %}
    </div>
  </div>

  {% include "event-navigation.njk" %}

  {% block tabContent %}
  {% endblock tabContent %}

{% endblock %}