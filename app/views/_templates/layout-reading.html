{# app/views/_templates/layout-reading.html #}
{# Layout for reading pages - extends layout-app with reading-specific features #}

{% extends "layout-app.html" %}

{% set gridColumn = gridColumn or "nhsuk-grid-column-full" %}

{# Script to show loading state in PACS viewer when navigating away, and inspect panel (press I) #}
{% block bodyEnd %}
  {{ super() }}
  {% if isReadingWorkflow and participant %}
    <script>
      (function() {
        if (typeof BroadcastChannel === 'undefined') return
        var ch = new BroadcastChannel('mammogram-viewer')
        var currentEventId = document.querySelector('meta[name="mammogram-event-id"]')?.getAttribute('content')

        // Send loading message when clicking navigation links
        document.addEventListener('click', function(e) {
          var link = e.target.closest('a[href]')
          if (!link) return
          var href = link.getAttribute('href')
          // Only for internal navigation that might change the case
          if (href && href.startsWith('/reading/') && !href.includes('#')) {
            ch.postMessage({ type: 'loading', fromEventId: currentEventId, timestamp: Date.now() })
          }
        })
      })()
    </script>

    {# Inspect panel: press 'i' to show debug info about the current mammogram set #}
    {% if event.mammogramData %}
      {% set inspectImages = getImagesForEvent(eventId, "diagrams", { event: event }) %}
      {% set inspectContext = extractEventContext(event) %}
    {% endif %}

    <div id="reading-inspect-panel" style="display:none; position:fixed; bottom:16px; right:16px; background:#1a1a1a; color:#fff; font-family:monospace; font-size:13px; padding:16px; border-radius:6px; border:1px solid #444; z-index:9999; min-width:320px; max-width:480px; box-shadow:0 4px 16px rgba(0,0,0,0.5);">
      <div style="font-size:11px; color:#888; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px;">Inspect – mammogram set</div>

      {% if event.mammogramData %}
        <div style="margin-bottom:6px;">
          <span style="color:#888;">selectedSetId: </span>
          <span style="color:#fff; font-weight:bold;">{{ event.mammogramData.selectedSetId or "not set" }}</span>
        </div>

        {% if inspectImages and inspectImages.set %}
          <div style="margin-bottom:6px;">
            <span style="color:#888;">resolved set id: </span>
            <span style="color:#fff; font-weight:bold;">{{ inspectImages.set.id }}</span>
            {% if inspectImages.set.id != event.mammogramData.selectedSetId %}
              <span style="color:#ff6b6b;"> ≠ stored</span>
            {% endif %}
          </div>
          <div style="margin-bottom:6px;">
            <span style="color:#888;">tag: </span>
            {% if inspectImages.set.tag == "normal" %}
              <span style="display:inline-block; padding:2px 8px; border-radius:3px; font-size:11px; text-transform:uppercase; background:#0a5; color:#fff;">{{ inspectImages.set.tag }}</span>
            {% elseif inspectImages.set.tag == "abnormal" %}
              <span style="display:inline-block; padding:2px 8px; border-radius:3px; font-size:11px; text-transform:uppercase; background:#d00; color:#fff;">{{ inspectImages.set.tag }}</span>
            {% elseif inspectImages.set.tag == "technical" %}
              <span style="display:inline-block; padding:2px 8px; border-radius:3px; font-size:11px; text-transform:uppercase; background:#c80; color:#000;">{{ inspectImages.set.tag }}</span>
            {% elseif inspectImages.set.tag == "indeterminate" %}
              <span style="display:inline-block; padding:2px 8px; border-radius:3px; font-size:11px; text-transform:uppercase; background:#666; color:#fff;">{{ inspectImages.set.tag }}</span>
            {% else %}
              <span style="color:#888;">{{ inspectImages.set.tag or "–" }}</span>
            {% endif %}
          </div>
          <div style="margin-bottom:6px;">
            <span style="color:#888;">description: </span>
            <span style="color:#ccc;">{{ inspectImages.set.description or "–" }}</span>
          </div>
        {% endif %}

        {% if inspectContext %}
          <div style="margin-top:10px; color:#888; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px;">Context</div>
          <div style="margin-bottom:3px;">
            <span style="display:inline-block; padding:2px 6px; border-radius:3px; font-size:11px; background:{{ '#06c' if inspectContext.hasSymptoms else '#444' }}; color:#fff;">symptoms</span>
            <span style="color:{{ '#fff' if inspectContext.hasSymptoms else '#666' }};">
              {{ 'yes' if inspectContext.hasSymptoms else 'no' }}
              {% if inspectContext.hasSymptoms and inspectContext.symptomSides and inspectContext.symptomSides.length %}
                ({{ inspectContext.symptomSides | join(", ") }})
              {% endif %}
            </span>
          </div>
          <div style="margin-bottom:3px;">
            <span style="display:inline-block; padding:2px 6px; border-radius:3px; font-size:11px; background:{{ '#06c' if inspectContext.hasImplants else '#444' }}; color:#fff;">implants</span>
            <span style="color:{{ '#fff' if inspectContext.hasImplants else '#666' }};"> {{ 'yes' if inspectContext.hasImplants else 'no' }}</span>
          </div>
          <div>
            <span style="display:inline-block; padding:2px 6px; border-radius:3px; font-size:11px; background:{{ '#06c' if inspectContext.isImperfect else '#444' }}; color:#fff;">imperfect</span>
            <span style="color:{{ '#fff' if inspectContext.isImperfect else '#666' }};"> {{ 'yes' if inspectContext.isImperfect else 'no' }}</span>
          </div>
        {% endif %}

        {% if event.mammogramData.machineRoom %}
          <div style="margin-top:8px; color:#888;">machine room: <span style="color:#fff;">{{ event.mammogramData.machineRoom }}</span></div>
        {% endif %}
      {% else %}
        <div style="color:#888;">No mammogramData on event</div>
      {% endif %}

      <div style="margin-top:12px; color:#555; font-size:11px;">Press I to close</div>
    </div>

    <script>
      (function() {
        var STORAGE_KEY = "reading-inspect-panel-open"
        var panel = document.getElementById("reading-inspect-panel")
        if (!panel) return

        // BroadcastChannel to sync with PACS viewer
        var channel = typeof BroadcastChannel !== "undefined"
          ? new BroadcastChannel("mammogram-viewer")
          : null

        var setInspectState = function(open, broadcast) {
          panel.style.display = open ? "block" : "none"
          sessionStorage.setItem(STORAGE_KEY, open ? "true" : "false")
          if (broadcast && channel) {
            channel.postMessage({ type: "inspect-toggle", open: open, timestamp: Date.now() })
          }
        }

        // Restore state from session storage
        setInspectState(sessionStorage.getItem(STORAGE_KEY) === "true", false)

        // Toggle on 'i' and broadcast to PACS viewer
        document.addEventListener("keydown", function(e) {
          if (e.key !== "i" && e.key !== "I") return
          if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT" || e.target.isContentEditable) return
          setInspectState(panel.style.display === "none", true)
        })

        // Sync state from PACS viewer (don't re-broadcast)
        if (channel) {
          channel.addEventListener("message", function(event) {
            if (event.data.type === "inspect-toggle") {
              setInspectState(event.data.open, false)
            }
          })
        }
      })()
    </script>
  {% endif %}
{% endblock bodyEnd %}

{# Workflow mode adds status bar and workflow navigation #}
{# {% if isReadingWorkflow %}
  {% set mainClasses = "nhsuk-u-padding-top-3" %}
{% endif %} #}

{% block head %}
  {{ super() }}

  {# Meta tags for PACS viewer - only in workflow mode with participant #}
  {% if isReadingWorkflow and participant %}
    {% set mammogramImages = getImagesForEvent(eventId, "diagrams", { event: event }) %}
    <meta name="mammogram-event-id" content="{{ eventId }}">
    <meta name="mammogram-participant-name" content="{{ participant | getFullName }}">
    <meta name="mammogram-nhs-number" content="{{ participant.medicalInformation.nhsNumber | formatNhsNumber }}">
    <meta name="mammogram-sx-number" content="{{ participant.sxNumber }}">
    <meta name="mammogram-date-of-birth" content="{{ participant.demographicInformation.dateOfBirth | formatDate }} ({{ participant | getAge }} years)">
    <meta name="mammogram-auto-open" content="{{ 'true' if data.settings.reading.autoOpenPacsViewer | falsify else 'false' }}">
    {% if mammogramImages and mammogramImages.paths %}
      {# Pass image paths - util filters to only include views present in mammogram data #}
      <meta name="mammogram-image-rcc" content="{{ mammogramImages.paths.rcc or '' }}">
      <meta name="mammogram-image-lcc" content="{{ mammogramImages.paths.lcc or '' }}">
      <meta name="mammogram-image-rmlo" content="{{ mammogramImages.paths.rmlo or '' }}">
      <meta name="mammogram-image-lmlo" content="{{ mammogramImages.paths.lmlo or '' }}">
      {# Pass all image paths for additional images view #}
      <meta name="mammogram-all-paths" content="{{ mammogramImages.allPaths | dump | escape }}">
      <meta name="mammogram-has-additional" content="{{ 'true' if mammogramImages.hasAdditionalImages else 'false' }}">
      {# Pass set info for debugging #}
      <meta name="mammogram-set-id" content="{{ mammogramImages.set.id }}">
      <meta name="mammogram-set-description" content="{{ mammogramImages.set.description }}">
      <meta name="mammogram-set-tag" content="{{ mammogramImages.set.tag }}">
      {# Pass context info for debugging #}
      {% set eventContext = extractEventContext(event) %}
      <meta name="mammogram-context" content="{{ eventContext | dump | escape }}">
    {% endif %}

    {# Broadcast to PACS viewer immediately - don't wait for DOMContentLoaded #}
    <script>
      (function() {
        if (typeof BroadcastChannel === 'undefined') return
        var ch = new BroadcastChannel('mammogram-viewer')
        var getMeta = function(name) {
          var el = document.querySelector('meta[name="' + name + '"]')
          return el ? el.getAttribute('content') : null
        }
        var eventId = getMeta('mammogram-event-id')
        var participantName = getMeta('mammogram-participant-name')
        if (!eventId || !participantName) return
        var allPathsRaw = getMeta('mammogram-all-paths')
        var contextRaw = getMeta('mammogram-context')
        ch.postMessage({
          type: 'show',
          eventId: eventId,
          participantName: participantName,
          nhsNumber: getMeta('mammogram-nhs-number'),
          sxNumber: getMeta('mammogram-sx-number'),
          dateOfBirth: getMeta('mammogram-date-of-birth'),
          images: {
            rcc: getMeta('mammogram-image-rcc') || null,
            lcc: getMeta('mammogram-image-lcc') || null,
            rmlo: getMeta('mammogram-image-rmlo') || null,
            lmlo: getMeta('mammogram-image-lmlo') || null
          },
          allPaths: allPathsRaw ? JSON.parse(allPathsRaw) : null,
          hasAdditionalImages: getMeta('mammogram-has-additional') === 'true',
          setId: getMeta('mammogram-set-id'),
          setDescription: getMeta('mammogram-set-description'),
          setTag: getMeta('mammogram-set-tag'),
          context: contextRaw ? JSON.parse(contextRaw) : null,
          timestamp: Date.now()
        })
      })()
    </script>
  {% endif %}
{% endblock head %}

{% block header %}
  {{ super() }}

  {# Reading-specific debug logging #}
  {% if isReadingWorkflow %}
    {{ data.imageReadingTemp | log("imageReadingTemp") }}
  {% endif %}
  {% if batchId %}
    {{ batch | log("Batch") }}
  {% endif %}


  {# Show status bar only in workflow mode #}
  {% if isReadingWorkflow %}
    {% include "_includes/reading/reading-status-bar.njk" %}
  {% endif %}
{% endblock header %}

{% block beforeContent %}
  {% if isReadingWorkflow and showWorkflowNav %}
    {# Workflow navigation: prev/next case - only on main opinion page #}
    {% include "_includes/reading/workflow-navigation.njk" %}
  {% else %}
    {# Standard back link - can be hidden or customised per page #}
    {% if not hideBackLink %}
      {{ backLink({
        href: back.href or "javascript:history.back();",
        text: back.text or "Back"
      }) }}
    {% endif %}
  {% endif %}
{% endblock %}

{% block pageNavigation %}
  {# Override this block in pages that need custom navigation #}
{% endblock pageNavigation %}

