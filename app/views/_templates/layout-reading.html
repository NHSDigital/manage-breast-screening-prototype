{# app/views/_templates/layout-reading.html #}
{# Layout for reading pages - extends layout-app with reading-specific features #}

{% extends "layout-app.html" %}

{% set gridColumn = gridColumn or "nhsuk-grid-column-full" %}

{# Script to show loading state in PACS viewer when navigating away #}
{% block bodyEnd %}
  {{ super() }}
  {% if isReadingWorkflow and participant %}
    <script>
      (function() {
        if (typeof BroadcastChannel === 'undefined') return
        var ch = new BroadcastChannel('mammogram-viewer')
        var currentEventId = document.querySelector('meta[name="mammogram-event-id"]')?.getAttribute('content')
        
        // Send loading message when clicking navigation links
        document.addEventListener('click', function(e) {
          var link = e.target.closest('a[href]')
          if (!link) return
          var href = link.getAttribute('href')
          // Only for internal navigation that might change the case
          if (href && href.startsWith('/reading/') && !href.includes('#')) {
            ch.postMessage({ type: 'loading', fromEventId: currentEventId, timestamp: Date.now() })
          }
        })
      })()
    </script>
  {% endif %}
{% endblock bodyEnd %}

{# Workflow mode adds status bar and workflow navigation #}
{# {% if isReadingWorkflow %}
  {% set mainClasses = "nhsuk-u-padding-top-3" %}
{% endif %} #}

{% block head %}
  {{ super() }}

  {# Meta tags for PACS viewer - only in workflow mode with participant #}
  {% if isReadingWorkflow and participant %}
    {% set mammogramImages = getImagesForEvent(eventId, "diagrams", { event: event }) %}
    <meta name="mammogram-event-id" content="{{ eventId }}">
    <meta name="mammogram-participant-name" content="{{ participant | getFullName }}">
    <meta name="mammogram-nhs-number" content="{{ participant.medicalInformation.nhsNumber | formatNhsNumber }}">
    <meta name="mammogram-sx-number" content="{{ participant.sxNumber }}">
    <meta name="mammogram-date-of-birth" content="{{ participant.demographicInformation.dateOfBirth | formatDate }} ({{ participant | getAge }} years)">
    <meta name="mammogram-auto-open" content="{{ 'true' if data.settings.reading.autoOpenPacsViewer | falsify else 'false' }}">
    {% if mammogramImages and mammogramImages.paths %}
      {# Pass image paths - util filters to only include views present in mammogram data #}
      <meta name="mammogram-image-rcc" content="{{ mammogramImages.paths.rcc or '' }}">
      <meta name="mammogram-image-lcc" content="{{ mammogramImages.paths.lcc or '' }}">
      <meta name="mammogram-image-rmlo" content="{{ mammogramImages.paths.rmlo or '' }}">
      <meta name="mammogram-image-lmlo" content="{{ mammogramImages.paths.lmlo or '' }}">
      {# Pass all image paths for additional images view #}
      <meta name="mammogram-all-paths" content="{{ mammogramImages.allPaths | dump | escape }}">
      <meta name="mammogram-has-additional" content="{{ 'true' if mammogramImages.hasAdditionalImages else 'false' }}">
      {# Pass set info for debugging #}
      <meta name="mammogram-set-id" content="{{ mammogramImages.set.id }}">
      <meta name="mammogram-set-description" content="{{ mammogramImages.set.description }}">
      <meta name="mammogram-set-tag" content="{{ mammogramImages.set.tag }}">
      {# Pass context info for debugging #}
      {% set eventContext = extractEventContext(event) %}
      <meta name="mammogram-context" content="{{ eventContext | dump | escape }}">
    {% endif %}

    {# Broadcast to PACS viewer immediately - don't wait for DOMContentLoaded #}
    <script>
      (function() {
        if (typeof BroadcastChannel === 'undefined') return
        var ch = new BroadcastChannel('mammogram-viewer')
        var getMeta = function(name) {
          var el = document.querySelector('meta[name="' + name + '"]')
          return el ? el.getAttribute('content') : null
        }
        var eventId = getMeta('mammogram-event-id')
        var participantName = getMeta('mammogram-participant-name')
        if (!eventId || !participantName) return
        var allPathsRaw = getMeta('mammogram-all-paths')
        var contextRaw = getMeta('mammogram-context')
        ch.postMessage({
          type: 'show',
          eventId: eventId,
          participantName: participantName,
          nhsNumber: getMeta('mammogram-nhs-number'),
          sxNumber: getMeta('mammogram-sx-number'),
          dateOfBirth: getMeta('mammogram-date-of-birth'),
          images: {
            rcc: getMeta('mammogram-image-rcc') || null,
            lcc: getMeta('mammogram-image-lcc') || null,
            rmlo: getMeta('mammogram-image-rmlo') || null,
            lmlo: getMeta('mammogram-image-lmlo') || null
          },
          allPaths: allPathsRaw ? JSON.parse(allPathsRaw) : null,
          hasAdditionalImages: getMeta('mammogram-has-additional') === 'true',
          setId: getMeta('mammogram-set-id'),
          setDescription: getMeta('mammogram-set-description'),
          setTag: getMeta('mammogram-set-tag'),
          context: contextRaw ? JSON.parse(contextRaw) : null,
          timestamp: Date.now()
        })
      })()
    </script>
  {% endif %}
{% endblock head %}

{% block header %}
  {{ super() }}

  {# Reading-specific debug logging #}
  {% if isReadingWorkflow %}
    {{ data.imageReadingTemp | log("imageReadingTemp") }}
  {% endif %}
  {% if batchId %}
    {{ batch | log("Batch") }}
  {% endif %}


  {# Show status bar only in workflow mode #}
  {% if isReadingWorkflow %}
    {% include "_includes/reading/reading-status-bar.njk" %}
  {% endif %}
{% endblock header %}

{% block beforeContent %}
  {% if isReadingWorkflow and showWorkflowNav %}
    {# Workflow navigation: prev/next case - only on main opinion page #}
    {% include "_includes/reading/workflow-navigation.njk" %}
  {% else %}
    {# Standard back link - can be hidden or customised per page #}
    {% if not hideBackLink %}
      {{ backLink({
        href: back.href or "javascript:history.back();",
        text: back.text or "Back"
      }) }}
    {% endif %}
  {% endif %}
{% endblock %}

{% block pageNavigation %}
  {# Override this block in pages that need custom navigation #}
{% endblock pageNavigation %}

