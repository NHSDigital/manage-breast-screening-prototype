{# app/views/_includes/event-workflow.njk #}

{# Tracking of status #}
{% set identityStageCompleted = true if data.event.workflowStatus['identity'] == 'completed' else false %}
{% set medicalInformationStageCompleted = true if data.event.workflowStatus['record-medical-information'] == 'completed' else false %}
{% set awaitingImagesStageCompleted = true if data.event.workflowStatus['awaiting-images'] == 'completed' else false %}
{% set imagesStageCompleted = true if data.event.workflowStatus['images'] == 'completed' else false %}

{# Build secondary nav #}
{% set secondaryNavItems = [] %}

  {# { id: 'appointment', label: 'Appointment' }, #}

{% for item in [
  { id: 'participant', label: 'Participant' },
  { id: 'medical-information', label: 'Medical information' },
  { id: 'images', label: 'Images' },
  { id: 'review', label: 'Review' }
] %}
  {% set href -%}
    /clinics/{{ clinicId }}/events/{{event.id}}{{ ("/" + item.id) if item.id !== 'all' }}
  {% endset %}

    {# { id: 'eligibility', label: 'Eligibility' }, #}

  {# SVG copied from https://service-manual.nhs.uk/design-system/components/do-and-dont-lists #}
  {% set tickSvg %}
    <svg class="app-icon app-icon--tick" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" d="M18.4 7.8l-8.5 8.4L5.6 12"></path>
    </svg>
  {% endset %}

  {% set workflowStatus %}
    {% if data.event.workflowStatus[item.id] == 'completed' %}
      {{ tickSvg | safe }}
    {% endif %}
  {% endset %}

  {% set isDisabled = false %}

  {# Disable images tab until other stages are completed #}
  {% if item.id == 'images' %}
    {% set isDisabled = true %}
    {% if identityStageCompleted and medicalInformationStageCompleted %}
      {% set isDisabled = false %}
    {% endif %}
  {% endif %}

  {% if item.id == 'review' %}
    {% set isDisabled = true %}
    {% if identityStageCompleted and medicalInformationStageCompleted and awaitingImagesStageCompleted and imagesStageCompleted %}
      {% set isDisabled = false %}
    {% endif %}
  {% endif %}

  {% set secondaryNavItems = secondaryNavItems | push({
    text: workflowStatus ~ item.label,
    href: href | trim,
    current: true if item.id == activeTab,
    disabled: isDisabled
  }) %}

{% endfor %}



<div class="app-header-with-status">
  <h1 class="nhsuk-heading-l">
    {# <span class="nhsuk-caption-l">
      {{ participant | getFullName }}
    </span> #}
    {{ pageHeading | safe }}
  </h1>

  {% set statusHtml %}
    {# Status tag with check-in link #}
    {{ eventStatus({
      clinicId: clinicId,
      event: event,
      participant: participant,
      participantUrl: "/participants/" + participant.id | urlWithReferrer(currentUrl),
      referrerChain: currentUrl,
      confirmIdentityOnCheckIn: true if data.settings.screening.confirmIdentityOnCheckIn == 'true' else false

    })}}
  {% endset %}

  {# <div class="app-header-with-status__status-tag">
    {{ statusHtml | safe }}
    {% if event | isSpecialAppointment %}
    <br>
      {{ tag({
        text: "Special appointment",
        classes: "nhsuk-tag--yellow nhsuk-u-margin-top-1"
      })}}
    {% endif %}

  </div> #}
</div>

{# {{ appSecondaryNavigation({
  visuallyHiddenTitle: "Secondary menu",
  items: secondaryNavItems
}) }} #}