{# app/views/_includes/medical-information/medical-history/index.njk #}

{# Need to manually inmport these as this is an include #}
{% from '_components/summary-list/macro.njk' import appSummaryList as summaryList %}
{% from '_components/summary-list/macro.njk' import appSummaryListRow as summaryListRow %}

{# ============================================================ #}
{# MACROS - Reusable components for medical history display    #}
{# ============================================================ #}

{# Macro: Left/Right Breast Display Grid
   Creates a two-column layout for displaying left and right breast information
   @param rightContent - HTML content for right breast column
   @param leftContent - HTML content for left breast column
#}
{% macro leftRightBreastDisplay(rightContent, leftContent) %}
  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-one-half">
      <p class="nhsuk-u-font-weight-bold nhsuk-u-margin-bottom-1">Right breast</p>
      {{ rightContent | safe }}
    </div>
    <div class="nhsuk-grid-column-one-half">
      <p class="nhsuk-u-font-weight-bold nhsuk-u-margin-bottom-1">Left breast</p>
      {{ leftContent | safe }}
    </div>
  </div>
{% endmacro %}

{# Macro: Breast Items List
   Creates a list of items for a single breast, handling arrays, single values, and empty states
   @param items - Array or single item to display
   @param emptyText - Text to show when no items (e.g., "No surgery", "No procedure")
#}
{# Todo: should this be a standardised filter / macro? #}
{% macro breastItemsList(items, emptyText) %}
  <ul class="nhsuk-list">
    {% if items %}
      {% if items | isArray %}
        {% for item in items %}
          <li>{{ item }}</li>
        {% else %}
          <li>{{ emptyText or "None" }}</li>
        {% endfor %}
      {% else %}
        <li>{{ items }}</li>
      {% endif %}
    {% else %}
      <li>{{ emptyText or "None" }}</li>
    {% endif %}
  </ul>
{% endmacro %}

{# ============================================================ #}
{# MEDICAL HISTORY DISPLAY                                      #}
{# ============================================================ #}

{# Check if there is any medical history data #}
{% set hasAnyMedicalHistoryData = false %}

{% for typeData in data.medicalHistoryTypes %}

  {# Create a shortened name for the data #}
  {% set historyItemArray = data.event.medicalInformation.medicalHistory[typeData.type] %}

  {# Only run if we have some medical historythe #}
  {% if historyItemArray and historyItemArray | length %}

    {% set hasAnyMedicalHistoryData = true %}
    <h3 class="nhsuk-u-margin-bottom-2">{{ typeData.name }}</h3>

    {% for historyItem in historyItemArray %}

      {% set changeHref = contextUrl + "/medical-information/medical-history/" + typeData.slug + "/edit/" + historyItem.id | urlWithReferrer(referrerChain | appendReferrer(currentUrl), scrollTo) %}

      {# Attribution text #}
      {% set addedByText %}
        Added by {{ historyItem.addedBy | getUsername }} on {{ historyItem.dateAdded | formatDate }} ({{ historyItem.dateAdded | formatRelativeDate }})
      {% endset %}

      {# ============================================================ #}
      {# SUMMARY LIST ROWS - Field HTML and row definitions          #}
      {# ============================================================ #}

      {# Type field - used by implanted medical devices, other procedures #}
      {% set typeHtml %}
        {% if historyItem.type %}
          {% if historyItem.type | isArray %}
            {% if historyItem.type | length > 1 %}
              <ul class="nhsuk-list">
                {% for item in historyItem.type %}
                  <li>
                    {% if item | startsWith("Other") %}
                      {{ item }}: {{ historyItem.typeOtherDetails }}
                    {% else %}
                      {{ item }}
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p>
                {% if historyItem.type[0] | startsWith("Other") %}
                  {{ historyItem.type[0] }}: {{ historyItem.typeOtherDetails }}
                {% else %}
                  {{ historyItem.type[0] }}
                {% endif %}
              </p>
            {% endif %}
          {% else %}
            <p>
              {% if historyItem.type | startsWith("Other") %}
                {{ historyItem.type }}: {{ historyItem.typeOtherDetails }}
              {% else %}
                {{ historyItem.type }}
                {# Grab other details used by other procedures #}
                {% set otherDetails = historyItem[(historyItem.type | camelCase) ~ "Details"] %}
                {% if otherDetails %}
                  <br>
                  Details: {{ otherDetails }}
                {% endif %}
              {% endif %}
            </p>
          {% endif %}
        {% endif %}

        {% if historyItem.deviceRemoved %}
          <p>
            {{ historyItem.deviceRemoved }}
            {% if historyItem.removalDetails %}
              <br>
              Details: {{ historyItem.removalDetails }}
            {% endif %}
          </p>
        {% endif %}
      {% endset %}

      {% set typeRow %}
        {% if historyItem.type %}
          {{ summaryListRow({
            key: {
              text: "Types" if (historyItem.type | isArray and historyItem.type | length > 1) else "Type"
            },
            value: {
              html: typeHtml
            }
          }) }}
        {% endif %}
      {% endset %}

      {# Cancer location #}
      {% set cancerLocationText %}
        {% if historyItem.cancerLocation | includes("Right breast") and historyItem.cancerLocation | includes("Left breast") %}
          Both breasts
        {% else %}
          {{ historyItem.cancerLocation[0] }}
        {% endif %}
      {% endset %}

      {% set cancerLocationRow %}
        {% if historyItem.cancerLocation %}
          {{ summaryListRow({
            key: {
              text: "Cancer location"
            },
            value: {
              text: cancerLocationText
            }
          }) }}
        {% endif %}
      {% endset %}

      {# Surgery - breast cancer #}
      {% set surgeryHtml %}
        {% set rightBreastContent %}
          {{ breastItemsList(historyItem.surgeryRightBreast, "No surgery") }}
        {% endset %}
        {% set leftBreastContent %}
          {{ breastItemsList(historyItem.surgeryLeftBreast, "No surgery") }}
        {% endset %}
        {{ leftRightBreastDisplay(rightBreastContent, leftBreastContent) }}
      {% endset %}

      {% set surgeryRow %}
        {% if historyItem.surgeryRightBreast or historyItem.surgeryLeftBreast %}
          {{ summaryListRow({
            key: {
              text: "Surgery"
            },
            value: {
              html: surgeryHtml
            }
          }) }}
        {% endif %}
      {% endset %}

      {# Treatment - breast cancer #}
      {% set treatmentHtml %}
        {% set rightBreastContent %}
          {{ breastItemsList(historyItem.treatmentRightBreast, "No treatment") }}
        {% endset %}
        {% set leftBreastContent %}
          {{ breastItemsList(historyItem.treatmentLeftBreast, "No treatment") }}
        {% endset %}
        {{ leftRightBreastDisplay(rightBreastContent, leftBreastContent) }}

        {% if historyItem.systemicTreatments %}
          <p class="nhsuk-u-font-weight-bold nhsuk-u-margin-bottom-1">Systemic treatments</p>
          {% for treatment in historyItem.systemicTreatments %}
            <p>{{ treatment }}</p>
          {% endfor %}
        {% endif %}
      {% endset %}

      {% set treatmentRow %}
        {% if historyItem.treatmentRightBreast or historyItem.treatmentLeftBreast %}
          {{ summaryListRow({
            key: {
              text: "Treatment"
            },
            value: {
              html: treatmentHtml
            }
          }) }}
        {% endif %}
      {% endset %}

      {# Procedures - used by breast implants, lump removal and biopsy, mastectomy lumpectomy #}
      {% set proceduresHtml %}
        {% set rightBreastContent %}
          <ul class="nhsuk-list">
            {% if historyItem.proceduresRightBreast %}
              {% if historyItem.proceduresRightBreast | isArray %}
                {% for procedure in historyItem.proceduresRightBreast %}
                  <li>
                    {{ procedure }}
                    {%- if (procedure | startsWith("Other")) and historyItem.proceduresRightBreastOtherDetails -%}
                    : {{ historyItem.proceduresRightBreastOtherDetails }}
                    {% endif %}
                  </li>
                {% else %}
                  <li>No procedure</li>
                {% endfor %}
              {% else %}
                <li>{{ historyItem.proceduresRightBreast }}</li>
              {% endif %}
            {% else %}
              <li>No procedure</li>
            {% endif %}
          </ul>
        {% endset %}
        {% set leftBreastContent %}
          {{ breastItemsList(historyItem.proceduresLeftBreast, "No procedures recorded") }}
        {% endset %}
        {{ leftRightBreastDisplay(rightBreastContent, leftBreastContent) }}

        {# Used by breast implants and augmentation only #}
        {% if historyItem.implantsRemoved | falsify %}
          <p>
            {{ historyItem.implantsRemoved }}
            {% if historyItem.removalDetails %}
              <br>
              Details: {{ historyItem.removalDetails }}
            {% endif %}
          </p>
        {% endif %}

        {# Used by mastectomy lumpectomy only #}
        {% if historyItem.hasHadReconstructionCheckbox | falsify %}
          <p>
            {% if historyItem.hadReconstruction %}
              {{ historyItem.hadReconstruction }}
            {% else %}
              Has not had reconstruction or symmetrisation surgery
            {% endif %}
          </p>
        {% endif %}
      {% endset %}

      {% set proceduresRow %}
        {% if historyItem.proceduresRightBreast or historyItem.proceduresLeftBreast %}
          {{ summaryListRow({
            key: {
              text: "Procedures"
            },
            value: {
              html: proceduresHtml
            }
          }) }}
        {% endif %}
      {% endset %}

      {# Other surgery - used by breast cancer #}
      {% set otherSurgeryHtml %}
        {% set rightBreastContent %}
          {{ breastItemsList(historyItem.otherSurgeryRightBreast, "No surgery") }}
        {% endset %}
        {% set leftBreastContent %}
          {{ breastItemsList(historyItem.otherSurgeryLeftBreast, "No surgery") }}
        {% endset %}
        {{ leftRightBreastDisplay(rightBreastContent, leftBreastContent) }}
      {% endset %}

      {% set otherSurgeryRow %}
        {% if historyItem.otherSurgeryRightBreast or historyItem.otherSurgeryLeftBreast %}
          {{ summaryListRow({
            key: {
              text: "Other surgery"
            },
            value: {
              html: otherSurgeryHtml
            }
          }) }}
        {% endif %}
      {% endset %}

      {# Cysts treatment #}
      {% set cystsTreatmentRow %}
        {% if historyItem.cystsStatus %}
          {{ summaryListRow({
            key: {
              text: "Treatment"
            },
            value: {
              html: historyItem.cystsStatus
            }
          }) }}
        {% endif %}
      {% endset %}

      {# Surgery reason - Mastectomy and lumpectomy #}
      {% set mastectomyLumpectomySurgeryReasonHtml %}
        {{ historyItem.mastectomyLumpectomySurgeryReason }}
        {% if historyItem.mastectomyLumpectomySurgeryReason | startsWith("Other") %}
          <br>
          Details: {{ historyItem.mastectomyLumpectomySurgeryReasonDetails }}
        {% endif %}
      {% endset %}

      {% set surgeryReasonRow %}
        {% if historyItem.mastectomyLumpectomySurgeryReason %}
          {{ summaryListRow({
            key: {
              text: "Surgery reason"
            },
            value: {
              html: mastectomyLumpectomySurgeryReasonHtml
            }
          }) }}
        {% endif %}
      {% endset %}

      {# Date field - general or specific date #}
      {% set dateText %}
        {% if historyItem.generalDate %}
          {% if historyItem.generalDate == "Specific date" %}
            {% if historyItem.specificDate | isValidDate %}
              {{ historyItem.specificDate | formatDate }} ({{ historyItem.specificDate | formatRelativeDate }})
            {% endif %}
          {% else %}
            {{ historyItem.generalDate }}
          {% endif %}
        {% endif %}
      {% endset %}

      {% set dateRow %}
        {% if historyItem.generalDate %}
          {{ summaryListRow({
            key: {
              text: "Date"
            },
            value: {
              text: dateText
            }
          }) }}
        {% endif %}
      {% endset %}

      {# Year field - with optional removal year #}
      {% set yearText %}
        {% set isRemoved = historyItem.deviceRemoved or historyItem.implantsRemoved %}
        {% if isRemoved %}
          Implanted in
        {% endif %}{{ historyItem.year }} ({{ historyItem.year | relativeYear }})
        {% if isRemoved %}
          <br>Device removed {% if historyItem.yearRemoved %} in {{ historyItem.yearRemoved }} ({{ historyItem.yearRemoved | relativeYear }}){% endif %}
        {% endif %}
      {% endset %}

      {% set yearRow %}
        {% if historyItem.year %}
          {{ summaryListRow({
            key: {
              text: typeData.yearLabel or "Year"
            },
            value: {
              html: yearText
            }
          }) }}
        {% endif %}
      {% endset %}

      {# Diagnosis date field #}
      {# {% set diagnosisDateText %}
        {% if historyItem.diagnosisDate %}
          {% if historyItem.diagnosisDate == "Specific date" %}
            {% if historyItem.diagnosisDateSpecific | isValidDate %}
              {{ historyItem.diagnosisDateSpecific | formatDate }} ({{ historyItem.diagnosisDateSpecific | formatRelativeDate }})
            {% endif %}
          {% else %}
            {{ historyItem.diagnosisDate }}
          {% endif %}
        {% endif %}
      {% endset %} #}

      {# {% set diagnosisDateRow %}
        {% if historyItem.diagnosisDate %}
          {{ summaryListRow({
            key: {
              text: "Diagnosis date"
            },
            value: {
              text: diagnosisDateText
            }
          }) }}
        {% endif %}
      {% endset %} #}

      {# Treatment location #}
      {% set locationHtml %}
        {% macro otherLocation(item) %}
          <br>
          {% if item %}
            Details: {{ item }}
          {% else %}
            Details not provided
          {% endif %}
        {% endmacro %}

        {{ historyItem.location }}
        
        {% switch historyItem.location %}
          {% case 'At an NHS hospital' %}
            {{ otherLocation(historyItem.locationNhsHospitalDetails) }}
          {% case 'At a private clinic in the UK' %}
            {{ otherLocation(historyItem.locationPrivateClinicDetails) }}
          {% case 'Outside the UK' %}
            {{ otherLocation(historyItem.locationOutsideUkDetails) }}
          {% case 'In multiple locations' %}
            {{ otherLocation(historyItem.locationMultipleLocationsDetails) }}
          {% case 'Exact location unknown' %}
            {{ otherLocation(historyItem.locationUnknownLocationDetails) }}
        {% endswitch %}
      {% endset %}

      {% set locationRow %}
        {% if historyItem.location | falsify %}
          {{ summaryListRow({
            key: {
              text: "Treatment location"
            },
            value: {
              html: locationHtml
            }
          }) }}
        {% endif %}
      {% endset %}

      {# Consent for imaging #}
      {% set consentRow %}
        {% if historyItem.consentGiven == 'yes' %}
          {{ summaryListRow({
            key: {
              text: "Consent for imaging"
            },
            value: {
              text: "Consent given"
            }
          }) }}
        {% endif %}
      {% endset %}

      {# Additional details #}
      {% set additionalDetailsRow %}
        {% if historyItem.additionalDetails %}
          {{ summaryListRow({
            key: {
              text: "Additional details"
            },
            value: {
              text: historyItem.additionalDetails
            }
          }) }}
        {% endif %}
      {% endset %}

      {# ============================================================ #}
      {# SUMMARY LIST - Assemble rows based on history type          #}
      {# ============================================================ #}

      {% set historyItemContents %}
        {% call summaryList() %}

          {# Breast cancer #}
          {% if typeData.type == 'breastCancer' %}
            {{ cancerLocationRow | safe }}
            {{ yearRow | safe }}
            {{ surgeryRow | safe }}
            {{ proceduresRow | safe }}
            {{ otherSurgeryRow | safe }}
            {{ treatmentRow | safe }}
            {# {{ diagnosisDateRow | safe }} #}
            {{ locationRow | safe }}

          {# Implanted medical device #}
          {% elseif typeData.type == 'implantedMedicalDevice' %}
            {{ typeRow | safe }}
            {{ yearRow | safe }}

          {# Breast implants or augmentation #}
          {% elseif typeData.type == 'breastImplantsAugmentation' %}
            {{ proceduresRow | safe }}
            {{ yearRow | safe }}
            {{ locationRow | safe }}
            {{ consentRow | safe }}

          {# Mastectomy or lumpectomy #}
          {% elseif typeData.type == 'mastectomyLumpectomy' %}
            {{ proceduresRow | safe }}
            {{ otherSurgeryRow | safe }}
            {{ yearRow | safe }}
            {{ surgeryReasonRow | safe }}
            {{ locationRow | safe }}

          {# Cysts #}
          {% elseif typeData.type == 'cysts' %}
            {{ cystsTreatmentRow | safe }}
            {{ dateRow | safe }}

          {# Benign lumps #}
          {% elseif typeData.type == 'benignLumps' %}
            {{ proceduresRow | safe }}
            {{ yearRow | safe }}
            {{ locationRow | safe }}

          {# Other procedures #}
          {% elseif typeData.type == 'otherProcedures' %}
            {{ typeRow | safe }}
            {{ yearRow | safe }}
          {% endif %}

          {# Additional details - common to all types #}
          {{ additionalDetailsRow | safe }}

        {% endcall %}

        {# Only show attribution if added by someone else, or added by current user before today #}
        {% if not (historyItem.addedBy | isCurrentUser) or (historyItem.dateAdated | isPast) %}
          <p class="nhsuk-u-margin-bottom-0">
            {{ addedByText | asHint }}
          </p>
        {% endif %}
      {% endset %}

      {# Container for history item #}
      <div class="nhsuk-u-margin-bottom-4">
        {% call appSummaryCard({
          title: {
            text: "Item " ~ loop.index,
            headingLevel: 4
          } if historyItemArray | length > 1,
          classes: "nhsuk-summary-card--compact nhsuk-u-margin-bottom-2",
          actions: {
            items: [
              {
                href: changeHref,
                text: "Change",
                visuallyHiddenText: typeData.name ~ " item " ~ loop.index
              }
            ]
          }
        }) %}
          {{ historyItemContents | safe }}
        {% endcall %}
      </div>

    {% endfor %}

  {% endif %}

{% endfor %}

{% if not hasAnyMedicalHistoryData %}
  {% set insetTextHtml %}
    <p>
      No medical history has been added yet.
    </p>
  {% endset %}

  {{ insetText({
    html: insetTextHtml
  }) }}
{% endif %}

{% if allowEdits %}
  <hr class="nhsuk-section-break nhsuk-section-break--m nhsuk-section-break--visible">

  <h3>Add medical history</h3>

  <div class="nhsuk-button-group app-button-group--small">
    {% for typeData in data.medicalHistoryTypes %}
      {% if typeData.canHaveMultiple %}
        {{ button({
          text: typeData.name,
          href: contextUrl + "/medical-information/medical-history/" + typeData.slug + "/add" | urlWithReferrer(referrerChain | appendReferrer(currentUrl), scrollTo),
          classes: "nhsuk-button--secondary app-button--small"
        }) }}
     {% endif %}
      
    {% endfor %}
  </div>
{% endif %}

