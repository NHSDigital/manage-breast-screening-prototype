{# app/views/_includes/medical-information/medical-history/index.njk #}

{# Hacky way of testing if there is any medical history data. Can't just test medicalInformation.medicalHistory as once items have been added and then deleted, it would still be truthy. #}
{% set hasAnyMedicalHistoryData = false %}

{% for typeData in data.medicalHistoryTypes %}

  {% set historyItemArray = data.event.medicalInformation.medicalHistory[typeData.type] %}

  {% if historyItemArray and historyItemArray | length %}

    {% set hasAnyMedicalHistoryData = true %}
    <h3>{{ typeData.name }}</h3>

    {% for historyItem in historyItemArray %}

      {% set changeHref =  "./medical-information/medical-history/" + typeData.slug + "/edit/" + historyItem.id | urlWithReferrer(currentUrl, scrollTo) %}

      <div class="nhsuk-u-margin-bottom-6">
        {% if historyItemArray | length > 1 %}
          <p class="nhsuk-u-font-weight-bold nhsuk-u-margin-bottom-2">
            Item #{{ loop.index }}
          </p>
        {% endif %}

        {% set typeText %}
          {% if historyItem.type %}
            {% if historyItem.type == 'Other' %}
              {{ historyItem.typeOtherDetails }}
            {% else %}
              {{ historyItem.type }}
            {% endif %}
          {% endif %}
        {% endset %}

        {% set dateText %}
          {% if historyItem.generalDate %}
            {% if historyItem.generalDate == "Specific date" %}
              {% if historyItem.specificDate | isValidDate %}
                {{ historyItem.specificDate | formatDate }} ({{ historyItem.specificDate | formatRelativeDate }})
              {% endif %}
            {% else %}
              {{ historyItem.generalDate }}
            {% endif %}
          {% endif %}
        {% endset %}

        {{ summaryList({
          classes: "nhsuk-u-margin-bottom-3",
          rows: [
            {
              key: {
                text: "Type"
              },
              value: {
                text: typeText
              },
              actions: {
                items: [
                  {
                    href: changeHref,
                    text: "Change",
                    visuallyHiddenText: historyItem.name | lower
                  }
                ]
              }
            } if historyItem.type,
            {
              key: {
                text: "Location"
              },
              value: {
                text: historyItem.generalLocation
              },
              actions: {
                items: [
                  {
                    href: changeHref,
                    text: "Change",
                    visuallyHiddenText: "generalLocation"
                  }
                ]
              }
            } if historyItem.generalLocation,
            {
              key: {
                text: "Date"
              },
              value: {
                text: dateText
              },
              actions: {
                items: [
                  {
                    href: changeHref,
                    text: "Change",
                    visuallyHiddenText: "date"
                  }
                ]
              }
            } if historyItem.generalDate,
            {
              key: {
                text: "Additional details"
              },
              value: {
                text: historyItem.additionalDetails
              },
              actions: {
                items: [
                  {
                    href: changeHref,
                    text: "Change",
                    visuallyHiddenText: "additional details"
                  }
                ]
              }
            } if historyItem.additionalDetails
          ]
        } | handleSummaryListMissingInformation(true) ) }}

        {% set addedByText %}
          Added by {{ historyItem.addedBy | getUsername }} on {{ historyItem.dateAdded | formatDate }} ({{ historyItem.dateAdded | formatRelativeDate }})
        {% endset %}
        <p>
          {{ addedByText | asHint }}
        </p>
      </div>


    {% endfor %}

    {% set addItemHref = ("./medical-information/medical-history/" + typeData.slug + "/add") | urlWithReferrer(currentUrl, scrollTo) %}

    <p class="nhsuk-u-margin-bottom-4"><a href="{{ addItemHref }}">Add another {{ typeData.name | lower | asVisuallyHiddenText }}</a></p>
  {% endif %}

{% endfor %}

{% if not hasAnyMedicalHistoryData %}
  {% set insetTextHtml %}
    <p>
      No medical history has been added yet.
    </p>
  {% endset %}

  {{ insetText({
    html: insetTextHtml
  }) }}
{% endif %}

<hr>

<h3>Add medical history</h3>
<div class="app-button-group">
  {% for typeData in data.medicalHistoryTypes %}
    {{ button({
      text: typeData.name,
      href: "./medical-information/medical-history/" + typeData.slug + "/add" | urlWithReferrer(currentUrl, scrollTo),
      classes: "nhsuk-button--secondary app-button--small"
    }) }}
  {% endfor %}
</div>