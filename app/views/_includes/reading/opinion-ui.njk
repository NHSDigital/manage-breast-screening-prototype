{% set existingResult = event.reads[0].result %}


{# {% set opionionHeading = "Review images for " + participant | getFullName %}
{% if existingResult %}
  {% set opionionHeading = "Update review for " + participant | getFullName %}
{% endif %} #}

{% set opionionHeading = "Review images" %}
{% if existingResult %}
  {% set opionionHeading = "Update review" %}
{% endif %}

<div class="nhsuk-grid-row app-header-with-status">
  <div class="nhsuk-grid-column-two-thirds">

    <span class="nhsuk-caption-l">
      {{ participant | getFullName }}
    </span>
    <h1 class="nhsuk-heading-l js-image-count">
      {{ opionionHeading }}
    </h1>
  </div>
  <div class="nhsuk-grid-column-one-third app-header-with-status__status-tag">
    {% set requestedWithDateHtml %}
      {{ "Images requested" | toTag | safe }}<br>
      Requested 10 Feb 2025
    {% endset %}
    {{ (requestedWithDateHtml | safe) if event.hasRequestedImages | falsify }}
  </div>
</div>
<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-full">
    {% set thingsToReview = [] %}
    {% set hasSymptoms = event.currentSymptoms | length > 0 %}
    {% if hasSymptoms %}
      {% set thingsToReview = thingsToReview | push("Symptoms") %}
    {% endif %}

    {% set imageCount = event.mammogramData.metadata.totalImages %}
    {% set hasAdditionalImages = imageCount > 4 %}

    {% if hasAdditionalImages %}
      {% set thingsToReview = thingsToReview | push("Additional images") %}
    {% endif %}

    {% if thingsToReview | length %}
      {% set warningCalloutHtml %}

        {% if hasSymptoms %}
          {# {% if thingsToReview | length > 1 %} #}
            {# <h3>{{ event.currentSymptoms | length }} {{ "symptom" | pluralise(event.currentSymptoms | length )}} reported</h3> #}
          {# {% endif %} #}
          {% set symptoms = event.currentSymptoms %}
          {% include "summary-lists/symptoms.njk" %}
          {# <p><a href="./medical-information">See participantâ€™s medical information</a></p> #}
        {% endif %}

        {% if hasAdditionalImages %}

          {# {% if thingsToReview | length > 1 %} #}
            <h3>Record includes {{ imageCount }} images</h3>
          {# {% endif %} #}

          {% set repeatImagesRows = [] %}

          {% for viewKey, viewData in event.mammogramData.views %}
            {% if viewData.images.length > 1 %}
              {% set valueText %}
                {% if viewData.isRepeat %}
                  {{ viewData.repeatReason | sentenceCase }}
                {% else %}
                  View required additional images to capture the full breast
                {% endif %}
              {% endset %}
              {% set repeatImagesRows = repeatImagesRows | push({
                key: {
                  text: viewData.viewShortWithSide + " repeated"
                },
                value: {
                  text: valueText
                }
              }) %}

            {% endif %}


          {% endfor %}

          {{ summaryList({
            rows: repeatImagesRows
          }) }}

          {# <ul class="nhsuk-list">
            {% for viewKey, viewData in event.mammogramData.views %}
              {% if viewData.images.length > 1 %}
                <li>
                  {% if viewData.isRepeat %}
                    {{ viewData.viewShortWithSide }} view was repeated because: {{ viewData.repeatReason }}
                  {% else %}
                    {{ viewData.viewShortWithSide }} view required additional images to capture the full breast
                  {% endif %}
                </li>
              {% endif %}
            {% endfor %}
          </ul> #}

        {% endif %}

        {# <hr class="nhsuk-section-break nhsuk-section-break--m nhsuk-section-break--visible">

        {% set symptomsCheckboxQuestionText %}
          Acknowledge these
            {% if thingsToReview | length > 1 %}
              items
            {% else %}
              {{ thingsToReview[0] | lower }}
            {% endif %}
          {% endset %}

          {{ checkboxes({
            idPrefix: "acknowledgeItems",
            name: "acknowledgeItems",
            items: [
              {
                value: "true",
                text: symptomsCheckboxQuestionText,
                checked: true if (data.acknowledgeItems == "true" or existingResult) else false
              }
            ]
          } | populateErrors) }} #}
      {% endset %}

      {% set calloutHeading %}
        {% if thingsToReview | length > 1 %}
          To review
        {% elseif thingsToReview[0] == 'Symptoms' %}
          Significant symptoms reported
        {% else %}
          {{ thingsToReview[0] }}
        {% endif %}
      {% endset %}
      {{ warningCallout({
        heading: calloutHeading | trim,
        HTML: warningCalloutHtml
      }) }}
    {% endif %}
  </div>
</div>



{% set questionText = "What is your opinion of these images?" %}

<form action="./assessment-answer" method="POST">


{# Temporary ui to support changing an answer #}
{% if existingResult %}
<div class="nhsuk-grid-row">
<div class="nhsuk-grid-column-two-thirds">
  {# Show radios when updating an existing result #}
  {{ radios({
    idPrefix: "result",
    name: "result",
    fieldset: {
      legend: {
        text: questionText,
        classes: "nhsuk-fieldset__legend--m",
        isPageHeading: false
      }
    },
    items: [
      {
        value: "normal",
        text: "Normal",
        checked: existingResult == "normal"
      },
      {
        value: "technical_recall",
        text: "Technical recall",
        checked: existingResult == "technical_recall"
      },
      {
        value: "recall_for_assessment",
        text: "Recall for assessment",
        checked: existingResult == "recall_for_assessment"
      }
    ],
    value: data.result or existingResult
  }) }}

  {{ button({
    text: "Update opinion"
  }) }}
</div>
</div>
{% else %}
<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-two-thirds">
    {# Show buttons for initial assessment #}
    <h2>{{ questionText }}</h2>
  </div>
</div>

<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-one-third">
    <div class="form-group">
      {{ button({
        text: "Normal" if not hasSymptoms else "Normal, and add details",
        value: "normal",
        name: "result",
        classes: "app-button-full-width nhsuk-u-margin-bottom-3"
      }) }}

      {# Go to page to collect a comment and mark features #}
      {% if not hasSymptoms %}
        <p class="nhsuk-u-margin-bottom-0">
          <a href="./normal-details" class="nhsuk-link--no-visited-state">
            Normal, but add details
          </a>
        </p>
      {% endif %}

    </div>
  </div>
  <div class="nhsuk-grid-column-one-third">
    <div class="form-group">
      {{ button({
        text: "Technical recall",
        classes: "nhsuk-button--secondary app-button-full-width",
        value: "technical_recall",
        name: "result"
      }) }}
    </div>
  </div>
  <div class="nhsuk-grid-column-one-third">
    <div class="form-group">
      {{ button({
        "text": "Recall for assessment",
        "classes": "nhsuk-button--warning app-button-full-width",
        "value": "recall_for_assessment",
        name: "result"
      }) }}
    </div>
  </div>

</div>

{% endif %}

{% set isPartialMammography = event.mammogramData.isPartialMammography %}
{% set partialMammographyHtml %}
<p>
  <b>Partial mammography:</b> Patient was uncomfortable and asked to stop
</p>
{% endset %}
{% if isPartialMammography %}
<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-two-thirds">
    {{ insetText({
      html: partialMammographyHtml
    }) }}
  </div>
</div>
{% endif %}

</form>