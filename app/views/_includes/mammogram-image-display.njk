{# app/views/_includes/mammogram-image-display.njk #}
{# 
  Display a single mammogram view with count/images and machine room
  
  Parameters:
  - viewItem: object with { side, view, viewShort, viewShortWithSide, count, images, etc }
  - isManualEntry: boolean - true shows count only, false shows image details
  - machineRoom: string - the screening room name
#}

<div class="{{ 'nhsuk-u-margin-bottom-3' if not loop.last }}">

  {% if isManualEntry %}
    {# Manual entry - show count only #}
    <h2>
      {{ viewItem.count }}× {{ viewItem.viewShortWithSide }}
    </h2>

    {{ summaryList({
      classes: "nhsuk-u-margin-bottom-0",
      rows: [
        {
          key: {
            text: "Machine room"
          },
          value: {
            text: machineRoom or "Not recorded"
          }
        }
      ]
    }) }}

    {# Show repeat information if present #}
    {% if viewItem.repeatCount > 0 and viewItem.repeatReasons %}
      <p class="nhsuk-u-margin-top-2">
        <strong>Repeat {{ 'reason' | pluralise(viewItem.repeatReasons | length) }}:</strong> {{ viewItem.repeatReasons | join(', ') }}
      </p>
    {% endif %}

  {% else %}
    {# Automated entry - show full image details #}
    
    {# Check if this is a missing view #}
    {% if viewItem.isMissing %}
      <h3 class="nhsuk-u-margin-bottom-2 nhsuk-u-secondary-text-color">
        0× {{ viewItem.viewShortWithSide }}
      </h3>
      
      <div class="app-mammogram-image--placeholder app-mammogram-image--missing nhsuk-u-margin-bottom-3">
        <div class="app-mammogram-image--missing-content">
          <span class="nhsuk-u-secondary-text-color">No image</span>
        </div>
      </div>
    {% else %}
      <h3 class="nhsuk-u-margin-bottom-2">
        {{ viewItem.images | length }}× {{ viewItem.viewShortWithSide }}
      </h3>

      {# Show thumbnails side by side #}
      <div class="">
        {% for image in viewItem.images %}
          <div class="app-mammogram-image--placeholder nhsuk-u-margin-right-3" style="float:left">
            <img class="nhsuk-image__img" src="/images/mammogram-diagrams/{{ viewItem.viewShortWithSide | lower }}.png" alt="">
          </div>
        {% endfor %}
        <div style="clear:both"></div>
      </div>
    {% endif %}

    {# View image metadata details #}
    {% set metadataHtml %}
      {% for image in viewItem.images %}
        <h4 class="nhsuk-heading-xs {{ 'nhsuk-u-margin-bottom-2' if not loop.last else 'nhsuk-u-margin-bottom-1' }}">Image {{ loop.index }}</h4>
        {{ summaryList({
          classes: "nhsuk-u-margin-bottom-" + ("4" if not loop.last else "0"),
          rows: [
            {
              key: {
                text: "Captured"
              },
              value: {
                text: image.timestamp | formatDateTime("D MMMM YYYY, H:mm:ss a")
              }
            },
            {
              key: {
                text: "Accession"
              },
              value: {
                html: image.accessionNumber
              }
            },
            {
              key: {
                text: "Machine room"
              },
              value: {
                text: machineRoom or "Not recorded"
              }
            }
          ]
        }) }}
      {% endfor %}
    {% endset %}

    {# {{ details({
      summaryText: "View image metadata",
      html: metadataHtml
    }) }} #}

    {# If there are no images, show inset text - likely partial mammography #}
    {# {% if viewItem.images | length == 0 %}
      {% set insetHtml %}
        <p>There are no {{ viewItem.viewShortWithSide }} images</p>
      {% endset %}
      {{ insetText({
        html: insetHtml
      }) }}
    {% endif %} #}

  {% endif %}

</div>
