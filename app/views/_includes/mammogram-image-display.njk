{# app/views/_includes/mammogram-image-display.njk #}
{# 
  Display a single mammogram view with count/images
  
  Parameters:
  - viewItem: object with { side, view, viewShort, viewShortWithSide, count, images, etc }
  - isManualEntry: boolean - true shows count only, false shows image details
#}

<div class="{{ 'nhsuk-u-margin-bottom-3' if not loop.last }}">

  {% if isManualEntry %}
    {# Manual entry - show count only #}
    <h3 class="nhsuk-u-margin-bottom-2">
      {{ viewItem.count }}× {{ viewItem.viewShortWithSide }}
    </h3>

    {# Show repeat information if present #}
    {% if viewItem.repeatCount > 0 and viewItem.repeatReasons %}
      <p class="nhsuk-u-margin-bottom-0">
        <strong>Repeat {{ 'reason' | pluralise(viewItem.repeatReasons | length) }}:</strong> {{ viewItem.repeatReasons | join(', ') }}
      </p>
    {% endif %}

  {% else %}
    {# Automated entry - show full image details #}
    
    {# Check if this is a missing view #}
    {% if viewItem.isMissing %}
      <h3 class="nhsuk-u-margin-bottom-2 nhsuk-u-secondary-text-color">
        0× {{ viewItem.viewShortWithSide }}
      </h3>
      
      <div class="app-mammogram-image--placeholder app-mammogram-image--missing nhsuk-u-margin-bottom-3">
        <div class="app-mammogram-image--missing-content">
          <span class="nhsuk-u-secondary-text-color">No image</span>
        </div>
      </div>
    {% else %}
      <h3 class="nhsuk-u-margin-bottom-2">
        {{ viewItem.images | length }}× {{ viewItem.viewShortWithSide }}
      </h3>

      {# Show thumbnails side by side #}
      <div class="">
        {% for image in viewItem.images %}
          <div class="app-mammogram-image--placeholder nhsuk-u-margin-right-3" style="float:left">
            <img class="nhsuk-image__img" src="/images/mammogram-diagrams/{{ viewItem.viewShortWithSide | lower }}.png" alt="">
          </div>
        {% endfor %}
        <div style="clear:both"></div>
      </div>

      {# Show additional image details if there are repeats or multiple images #}
      {% if viewItem.repeatCount > 0 or (viewItem.images | length) > 1 %}
        {% set additionalCount = (viewItem.images | length) - 1 %}
        {% set repeatCount = viewItem.repeatCount or 0 %}
        {% set extraCount = additionalCount - repeatCount %}
        
        {% set additionalDetailsHtml %}
          {# Show repeat information #}
          {% if repeatCount > 0 %}
            <p class="nhsuk-u-margin-bottom-2">
              {{ repeatCount }} {{ 'repeat' | pluralise(repeatCount) }} taken
            </p>
            {% if viewItem.repeatReasons and viewItem.repeatReasons | length > 0 %}
              {% if viewItem.repeatReasons | length == 1 %}
                <p class="nhsuk-u-margin-bottom-2">
                  {{ viewItem.repeatReasons[0] }}
                </p>
              {% else %}
                <p class="nhsuk-u-margin-bottom-2"><strong>Repeat reasons:</strong></p>
                <ul class="nhsuk-list nhsuk-list--bullet nhsuk-u-margin-bottom-2">
                  {% for reason in viewItem.repeatReasons %}
                    <li>{{ reason }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            {% endif %}
          {% endif %}
          
          {# Show extra image information #}
          {% if extraCount > 0 %}
            <p class="nhsuk-u-margin-bottom-0">
              {% if extraCount == 1 %}
                An extra image was taken to capture the complete view.
              {% else %}
                {{ extraCount }} extra images were taken to capture the complete view.
              {% endif %}
            </p>
          {% endif %}
        {% endset %}
        
        <div class="nhsuk-u-margin-top-3">
          {{ details({
            summaryText: "Additional image details",
            html: additionalDetailsHtml
          }) }}
        </div>
      {% endif %}
    {% endif %}

  {% endif %}

</div>
