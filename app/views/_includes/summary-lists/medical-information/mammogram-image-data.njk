{# app/views/_includes/mammogram-data-display.njk #}
{# Display captured mammogram information - works for both manual and automated #}

{% set isManualEntry = event.mammogramData.isManualEntry %}
{% set mammogramViews = event.mammogramData.views | getObjectValues %}

{# Define view order for consistent display (CC, MLO, Eklund) #}
{% set viewOrder = ['CC', 'MLO', 'Eklund'] %}

{# Group views by side and sort by standard order #}
{% set rightViewsUnsorted = [] %}
{% set leftViewsUnsorted = [] %}
{% for view in mammogramViews %}
  {% if isManualEntry %}
    {% if view.count > 1 %}
      {% set viewText = view.viewShort + " (" + view.count + "x)" %}
    {% else %}
      {% set viewText = view.viewShort %}
    {% endif %}
  {% else %}
    {% if view.images | length > 1 %}
      {% set viewText = view.viewShort + " (" + (view.images | length) + "x)" %}
    {% else %}
      {% set viewText = view.viewShort %}
    {% endif %}
  {% endif %}
  
  {% if view.side == 'right' %}
    {% set rightViewsUnsorted = rightViewsUnsorted | push({ text: viewText, type: view.viewShort, view: view }) %}
  {% else %}
    {% set leftViewsUnsorted = leftViewsUnsorted | push({ text: viewText, type: view.viewShort, view: view }) %}
  {% endif %}
{% endfor %}

{# Sort views by standard order #}
{% set rightViews = [] %}
{% set leftViews = [] %}
{% for viewType in viewOrder %}
  {% for item in rightViewsUnsorted %}
    {% if item.type == viewType %}
      {% set rightViews = rightViews | push(item.text) %}
    {% endif %}
  {% endfor %}
  {% for item in leftViewsUnsorted %}
    {% if item.type == viewType %}
      {% set leftViews = leftViews | push(item.text) %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% set viewsHtml %}
  {% if rightViews | length > 0 %}
    <p class="nhsuk-u-margin-bottom-1"><strong>Right:</strong> {{ rightViews | join(", ") }}</p>
  {% endif %}
  {% if leftViews | length > 0 %}
    <p class="nhsuk-u-margin-bottom-0"><strong>Left:</strong> {{ leftViews | join(", ") }}</p>
  {% endif %}
{% endset %}

{# Build repeats/additional images information #}
{% set extraImagesHtml = "" %}
{% set hasRepeatsOrExtras = false %}
{% for view in mammogramViews %}
  {% set viewHasMultiple = false %}
  {% set totalCount = 0 %}
  
  {% if isManualEntry and view.count > 1 %}
    {% set viewHasMultiple = true %}
    {% set totalCount = view.count %}
  {% elseif not isManualEntry and view.images | length > 1 %}
    {% set viewHasMultiple = true %}
    {% set totalCount = view.images | length %}
  {% endif %}
  
  {% if viewHasMultiple %}
    {% set hasRepeatsOrExtras = true %}
    
    {# Calculate counts explicitly #}
    {% set additionalCount = totalCount - 1 %}
    {% set repeatCount = view.repeatCount or 0 %}
    {% set extraCount = additionalCount - repeatCount %}
    
    {# Build description for this view #}
    {% set viewDescription = "" %}
    
    {# Describe the breakdown using specific counts #}
    {% if repeatCount > 0 and extraCount > 0 %}
      {% set viewDescription = repeatCount + " " + ("repeat" | pluralise(repeatCount)) + ", " + extraCount + " extra" %}
    {% elseif repeatCount > 0 and extraCount == 0 %}
      {% set viewDescription = repeatCount + " " + ("repeat" | pluralise(repeatCount)) %}
    {% elseif repeatCount == 0 and extraCount > 0 %}
      {% set viewDescription = extraCount + " extra" %}
    {% endif %}
    
    {# Add repeat reasons if present #}
    {% if view.repeatReasons and view.repeatReasons | length > 0 %}
      {% set reasonsList = "<ul class='nhsuk-list nhsuk-list--bullet nhsuk-u-margin-bottom-0'>" %}
      {% for reason in view.repeatReasons %}
        {% set reasonsList = reasonsList + "<li>" + reason + "</li>" %}
      {% endfor %}
      {% set reasonsList = reasonsList + "</ul>" %}
      {% set viewDescription = viewDescription + "<br>Repeat " + ("reason" | pluralise(view.repeatReasons | length)) + ":" + reasonsList %}
    {% endif %}
    
    {% set extraImagesHtml = extraImagesHtml + "<p class='nhsuk-u-margin-bottom-2'><strong>" + view.viewShortWithSide + ":</strong> " + viewDescription + "</p>" %}
  {% endif %}
{% endfor %}

{# Build summary list rows #}
{% set summaryRows = [] %}

{% set defaultHref = "./images-automatic" %}

{# Machine room #}
{% if event.mammogramData.machineRoom %}
  {# Check if this is a mobile clinic #}
  {% set isMobileClinic = (clinic.location.type == 'mobile_unit') %}
  
  {% set machineRoomActions = [] %}
  {% if not isMobileClinic %}
    {% set machineRoomActions = [
      {
        href: "./images-room-selection" | urlWithReferrer(referrerChain, scrollTo),
        text: "Change",
        visuallyHiddenText: "machine room"
      }
    ] %}
  {% endif %}
  
  {% set summaryRows = summaryRows | push({
    key: {
      text: "Machine room"
    },
    value: {
      text: event.mammogramData.machineRoom
    },
    actions: {
      items: machineRoomActions
    }
  }) %}
{% endif %}

{# Combined views taken (showing all view information in one row) #}
{# Sort views by side and standard order before displaying #}
{% set sortedViews = [] %}
{% for viewType in viewOrder %}
  {% for view in mammogramViews %}
    {% if view.viewShort == viewType and view.side == 'right' %}
      {% set sortedViews = sortedViews | push(view) %}
    {% endif %}
  {% endfor %}
{% endfor %}
{% for viewType in viewOrder %}
  {% for view in mammogramViews %}
    {% if view.viewShort == viewType and view.side == 'left' %}
      {% set sortedViews = sortedViews | push(view) %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% set combinedViewsHtml = "" %}
{% for view in sortedViews %}
  {% set totalCount = 0 %}
  
  {% if isManualEntry %}
    {% set totalCount = view.count %}
  {% else %}
    {% set totalCount = view.images | length %}
  {% endif %}
  
  {# Build view label with count prefix #}
  {% set viewLabel = totalCount + "Ã— " + view.viewShortWithSide %}
  {% set viewDescription = "" %}
  
  {# If multiple images, add breakdown #}
  {% if totalCount > 1 %}
    {# Calculate counts explicitly #}
    {% set additionalCount = totalCount - 1 %}
    {% set repeatCount = view.repeatCount or 0 %}
    {% set extraCount = additionalCount - repeatCount %}
    
    {# Add breakdown using specific counts #}
    {% if repeatCount > 0 and extraCount > 0 %}
      {% set viewDescription = repeatCount + " " + ("repeat" | pluralise(repeatCount)) + ", " + extraCount + " extra" %}
    {% elseif repeatCount > 0 and extraCount == 0 %}
      {% set viewDescription = repeatCount + " " + ("repeat" | pluralise(repeatCount)) %}
    {% elseif repeatCount == 0 and extraCount > 0 %}
      {% set viewDescription = extraCount + " extra" %}
    {% endif %}
    
    {# Add repeat reasons if present #}
    {% if view.repeatReasons and view.repeatReasons | length > 0 %}
      {% set reasonsList = "<ul class='nhsuk-list nhsuk-list--bullet nhsuk-u-margin-bottom-0'>" %}
      {% for reason in view.repeatReasons %}
        {% set reasonsList = reasonsList + "<li>" + reason + "</li>" %}
      {% endfor %}
      {% set reasonsList = reasonsList + "</ul>" %}
      {% set viewDescription = viewDescription + "<br>Repeat " + ("reason" | pluralise(view.repeatReasons | length)) + ":" + reasonsList %}
    {% endif %}
  {% endif %}
  
  {% if viewDescription %}
    {% set combinedViewsHtml = combinedViewsHtml + "<p class='nhsuk-u-margin-bottom-2'><strong>" + viewLabel + ":</strong> " + viewDescription + "</p>" %}
  {% else %}
    {% set combinedViewsHtml = combinedViewsHtml + "<p class='nhsuk-u-margin-bottom-2'><strong>" + viewLabel + "</strong></p>" %}
  {% endif %}
{% endfor %}

{% set summaryRows = summaryRows | push({
  key: {
    text: "Views taken"
  },
  value: {
    html: combinedViewsHtml
  },
  actions: {
    items: [
      {
        href: ("./images-manual-details" if isManualEntry else defaultHref) | urlWithReferrer(referrerChain, scrollTo),
        text: "Change",
        visuallyHiddenText: "views taken"
      }
    ]
  }
}) %}

{# OLD Views taken (split into separate rows) - keeping for reference #}
{# {% set summaryRows = summaryRows | push({
  key: {
    text: "Views taken"
  },
  value: {
    html: viewsHtml
  },
  actions: {
    items: [
      {
        href: ("./images-manual-details" if isManualEntry else defaultHref) | urlWithReferrer(referrerChain, scrollTo),
        text: "Change",
        visuallyHiddenText: "views taken"
      }
    ]
  }
}) %} #}

{# Image counts #}
{# {% set summaryRows = summaryRows | push({
  key: {
    text: "Total images"
  },
  value: {
    html: event.mammogramData.metadata.totalImages + " (" + 
          event.mammogramData.metadata.imagesByBreast.right + " right, " +
          event.mammogramData.metadata.imagesByBreast.left + " left)"
  }
}) %} #}

{# Partial mammography #}
{% if event.mammogramData.isPartialMammography == 'yes' %}
  {% set partialMammographyHtml %}
    {% if event.mammogramData.partialMammographyReasonSelect %}
      <p class="nhsuk-u-margin-bottom-2"><strong>Reason:</strong> {{ event.mammogramData.partialMammographyReasonSelect }}</p>
    {% endif %}
    {% if event.mammogramData.partialMammographyShouldReinvite == 'yes' %}
      <p class="nhsuk-u-margin-bottom-2">Participant to be reinvited to complete the remaining images</p>
    {% endif %}
    {% if event.mammogramData.partialMammographyReasonComment %}
      <p class="nhsuk-u-margin-bottom-0"><strong>Follow-up appointment information:</strong> {{ event.mammogramData.partialMammographyReasonComment }}</p>
    {% endif %}
    {% if not event.mammogramData.partialMammographyReasonSelect and not event.mammogramData.partialMammographyReasonComment %}
      Yes, no reason provided
    {% endif %}
  {% endset %}
  
  {% set summaryRows = summaryRows | push({
    key: {
      text: "Partial mammography"
    },
    value: {
      html: partialMammographyHtml
    },
    actions: {
      items: [
        {
          href: ("./images-manual-details" if isManualEntry else defaultHref) | urlWithReferrer(referrerChain, scrollTo),
          text: "Change",
          visuallyHiddenText: "partial mammography"
        }
      ]
    }
  }) %}
{% endif %}

{# OLD Repeats and additional images (separate row) - keeping for reference #}
{# {% if hasRepeatsOrExtras %}
  {% set summaryRows = summaryRows | push({
    key: {
      text: "Additional images"
    },
    value: {
      html: extraImagesHtml
    },
    actions: {
      items: [
        {
          href: ("./images-manual-repeats" if isManualEntry else defaultHref) | urlWithReferrer(referrerChain, scrollTo),
          text: "Change",
          visuallyHiddenText: "additional images"
        }
      ]
    }
  }) %}
{% endif %} #}

{# Additional details #}
{# {% if event.mammogramData.additionalDetails %} #}
  {% set summaryRows = summaryRows | push({
    key: {
      text: "Additional details"
    },
    value: {
      text: event.mammogramData.additionalDetails
    },
    actions: {
      items: [
        {
          href: ("./images-manual-details" if isManualEntry else defaultHref) | urlWithReferrer(referrerChain, scrollTo),
          text: "Change",
          visuallyHiddenText: "additional details"
        }
      ]
    }
  }) %}
{# {% endif %} #}

{{ summaryList({
  rows: summaryRows
} | handleSummaryListMissingInformation) }}