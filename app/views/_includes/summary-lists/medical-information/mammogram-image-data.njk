{# app/views/_includes/mammogram-data-display.njk #}
{# Display captured mammogram information - works for both manual and automated #}

{% set allowEdits = allowEdits | default(true) %}

{% set isManualEntry = event.mammogramData.isManualEntry %}
{% set mammogramViews = event.mammogramData.views | getObjectValues %}

{# Define view order for consistent display (CC, MLO, Eklund) #}
{% set viewOrder = ['CC', 'MLO', 'Eklund'] %}

{# Group views by side and sort by standard order #}
{% set rightViewsUnsorted = [] %}
{% set leftViewsUnsorted = [] %}
{% for view in mammogramViews %}
  {% if isManualEntry %}
    {% if view.count > 1 %}
      {% set viewText = view.viewShort + " (" + view.count + "x)" %}
    {% else %}
      {% set viewText = view.viewShort %}
    {% endif %}
  {% else %}
    {% if view.images | length > 1 %}
      {% set viewText = view.viewShort + " (" + (view.images | length) + "x)" %}
    {% else %}
      {% set viewText = view.viewShort %}
    {% endif %}
  {% endif %}
  
  {% if view.side == 'right' %}
    {% set rightViewsUnsorted = rightViewsUnsorted | push({ text: viewText, type: view.viewShort, view: view }) %}
  {% else %}
    {% set leftViewsUnsorted = leftViewsUnsorted | push({ text: viewText, type: view.viewShort, view: view }) %}
  {% endif %}
{% endfor %}

{# Sort views by standard order #}
{% set rightViews = [] %}
{% set leftViews = [] %}
{% for viewType in viewOrder %}
  {% for item in rightViewsUnsorted %}
    {% if item.type == viewType %}
      {% set rightViews = rightViews | push(item.text) %}
    {% endif %}
  {% endfor %}
  {% for item in leftViewsUnsorted %}
    {% if item.type == viewType %}
      {% set leftViews = leftViews | push(item.text) %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% set viewsHtml %}
  {% if rightViews | length > 0 %}
    <p class="nhsuk-u-margin-bottom-1"><strong>Right:</strong> {{ rightViews | join(", ") }}</p>
  {% endif %}
  {% if leftViews | length > 0 %}
    <p class="nhsuk-u-margin-bottom-0"><strong>Left:</strong> {{ leftViews | join(", ") }}</p>
  {% endif %}
{% endset %}

{# Build repeats/additional images information #}
{% set extraImagesHtml = "" %}
{% set hasRepeatsOrExtras = false %}
{% for view in mammogramViews %}
  {% set viewHasMultiple = false %}
  {% set totalCount = 0 %}
  
  {% if isManualEntry and view.count > 1 %}
    {% set viewHasMultiple = true %}
    {% set totalCount = view.count %}
  {% elseif not isManualEntry and view.images | length > 1 %}
    {% set viewHasMultiple = true %}
    {% set totalCount = view.images | length %}
  {% endif %}
  
  {% if viewHasMultiple %}
    {% set hasRepeatsOrExtras = true %}
    
    {# Calculate counts explicitly #}
    {% set additionalCount = totalCount - 1 %}
    {% set repeatCount = view.repeatCount or 0 %}
    {% set extraCount = additionalCount - repeatCount %}
    
    {# Build description for this view #}
    {% set viewDescription = "" %}
    
    {# Describe the breakdown using specific counts #}
    {% if repeatCount > 0 and extraCount > 0 %}
      {% set viewDescription = repeatCount + " " + ("repeat" | pluralise(repeatCount)) + ", " + extraCount + " extra" %}
    {% elseif repeatCount > 0 and extraCount == 0 %}
      {% set viewDescription = repeatCount + " " + ("repeat" | pluralise(repeatCount)) %}
    {% elseif repeatCount == 0 and extraCount > 0 %}
      {% set viewDescription = extraCount + " extra" %}
    {% endif %}
    
    {# Add repeat reasons if present #}
    {% if view.repeatReasons and view.repeatReasons | length > 0 %}
      {% set reasonsList = "<ul class='nhsuk-list nhsuk-list--bullet nhsuk-u-margin-bottom-0'>" %}
      {% for reason in view.repeatReasons %}
        {% set reasonsList = reasonsList + "<li>" + reason + "</li>" %}
      {% endfor %}
      {% set reasonsList = reasonsList + "</ul>" %}
      {% set viewDescription = viewDescription + "<br>Repeat " + ("reason" | pluralise(view.repeatReasons | length)) + ":" + reasonsList %}
    {% endif %}
    
    {% set extraImagesHtml = extraImagesHtml + "<p class='nhsuk-u-margin-bottom-2'><strong>" + view.viewShortWithSide + ":</strong> " + viewDescription + "</p>" %}
  {% endif %}
{% endfor %}

{# Build summary list rows #}
{% set summaryRows = [] %}

{% set defaultHref = "./images-automatic" %}

{# Machine room #}
{% if event.mammogramData.machineRoom %}
  {# Check if this is a mobile clinic #}
  {% set isMobileClinic = (clinic.location.type == 'mobile_unit') %}
  
  {% set machineRoomActions = [] %}
  {% if allowEdits and not isMobileClinic %}
    {% set machineRoomActions = [
      {
        href: "./images-room-selection" | urlWithReferrer(referrerChain, scrollTo),
        text: "Change",
        visuallyHiddenText: "machine room"
      }
    ] %}
  {% endif %}
  
  {% set summaryRows = summaryRows | push({
    key: {
      text: "Machine room"
    },
    value: {
      text: event.mammogramData.machineRoom
    },
    actions: {
      items: machineRoomActions
    }
  }) %}
{% endif %}

{# Combined views taken (showing all view information in one row) #}
{# Sort views by side and standard order before displaying #}
{% set sortedViews = [] %}
{% for viewType in viewOrder %}
  {% for view in mammogramViews %}
    {% if view.viewShort == viewType and view.side == 'right' %}
      {% set sortedViews = sortedViews | push(view) %}
    {% endif %}
  {% endfor %}
{% endfor %}
{% for viewType in viewOrder %}
  {% for view in mammogramViews %}
    {% if view.viewShort == viewType and view.side == 'left' %}
      {% set sortedViews = sortedViews | push(view) %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% set combinedViewsHtml = "" %}
{% for view in sortedViews %}
  {% set totalCount = 0 %}
  
  {% if isManualEntry %}
    {% set totalCount = view.count %}
  {% else %}
    {% set totalCount = view.images | length %}
  {% endif %}
  
  {# Build view label with count prefix #}
  {% set viewLabel = totalCount + "× " + view.viewShortWithSide %}
  {% set viewDescription = "" %}
  
  {# If multiple images, add breakdown #}
  {% if totalCount > 1 %}
    {# Calculate counts explicitly #}
    {% set additionalCount = totalCount - 1 %}
    {% set repeatCount = view.repeatCount or 0 %}
    {% set extraCount = additionalCount - repeatCount %}
    
    {# Add breakdown using specific counts #}
    {% if repeatCount > 0 and extraCount > 0 %}
      {% set viewDescription = repeatCount + " " + ("repeat" | pluralise(repeatCount)) + ", " + extraCount + " extra" %}
    {% elseif repeatCount > 0 and extraCount == 0 %}
      {% set viewDescription = repeatCount + " " + ("repeat" | pluralise(repeatCount)) %}
    {% elseif repeatCount == 0 and extraCount > 0 %}
      {% set viewDescription = extraCount + " extra" %}
    {% endif %}
    
    {# Add repeat reasons if present #}
    {% if view.repeatReasons and view.repeatReasons | length > 0 %}
      {% set reasonsList = "<ul class='nhsuk-list nhsuk-list--bullet nhsuk-u-margin-bottom-0'>" %}
      {% for reason in view.repeatReasons %}
        {% set reasonsList = reasonsList + "<li>" + reason + "</li>" %}
      {% endfor %}
      {% set reasonsList = reasonsList + "</ul>" %}
      {% set viewDescription = viewDescription + "<br>Repeat " + ("reason" | pluralise(view.repeatReasons | length)) + ":" + reasonsList %}
    {% endif %}
  {% endif %}
  
  {% if viewDescription %}
    {% set combinedViewsHtml = combinedViewsHtml + "<p class='nhsuk-u-margin-bottom-2'><strong>" + viewLabel + ":</strong> " + viewDescription + "</p>" %}
  {% else %}
    {% set combinedViewsHtml = combinedViewsHtml + "<p class='nhsuk-u-margin-bottom-2'><strong>" + viewLabel + "</strong></p>" %}
  {% endif %}
{% endfor %}

{% set summaryRows = summaryRows | push({
  key: {
    text: "Views taken"
  },
  value: {
    html: combinedViewsHtml
  },
  actions: {
    items: [
      {
        href: ("./images-manual-details" if isManualEntry else defaultHref) | urlWithReferrer(referrerChain, scrollTo),
        text: "Change",
        visuallyHiddenText: "views taken"
      }
    ]
  } if allowEdits
}) %}

{# OLD Views taken (split into separate rows) - keeping for reference #}
{# {% set summaryRows = summaryRows | push({
  key: {
    text: "Views taken"
  },
  value: {
    html: viewsHtml
  },
  actions: {
    items: [
      {
        href: ("./images-manual-details" if isManualEntry else defaultHref) | urlWithReferrer(referrerChain, scrollTo),
        text: "Change",
        visuallyHiddenText: "views taken"
      }
    ]
  }
}) %} #}

{# Image counts #}
{# {% set summaryRows = summaryRows | push({
  key: {
    text: "Total images"
  },
  value: {
    html: event.mammogramData.metadata.totalImages + " (" + 
          event.mammogramData.metadata.imagesByBreast.right + " right, " +
          event.mammogramData.metadata.imagesByBreast.left + " left)"
  }
}) %} #}

{# Imperfect but best possible images #}
{% if event.mammogramData.isImperfectButBestPossible and event.mammogramData.isImperfectButBestPossible | includes("yes") %}
  {% set summaryRows = summaryRows | push({
    key: {
      text: "Image quality note"
    },
    value: {
      text: "Imperfect, but best possible images – advise image readers not to request a technical recall"
    },
    actions: {
      items: [
        {
          href: ("./images-manual-details" if isManualEntry else defaultHref) | urlWithReferrer(referrerChain, scrollTo),
          text: "Change",
          visuallyHiddenText: "image quality note"
        }
      ]
    } if allowEdits
  }) %}
{% endif %}

{# Incomplete mammography #}
{% if event.mammogramData.isIncompleteMammography and event.mammogramData.isIncompleteMammography | includes("yes") %}
  {% set incompleteMammographyHtml %}
    {% if event.mammogramData.incompleteMammographyReasons and event.mammogramData.incompleteMammographyReasons | length > 0 %}
      <p class="nhsuk-u-margin-bottom-1">{{ "Reason" | pluralise(event.mammogramData.incompleteMammographyReasons | length) }}:</p>
      <ul class="nhsuk-list nhsuk-list--bullet nhsuk-u-margin-bottom-2">
        {% for reason in event.mammogramData.incompleteMammographyReasons %}
          <li>{{ reason }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    {% if event.mammogramData.incompleteMammographyReasonDetails %}
      <p class="nhsuk-u-margin-bottom-2">Details: {{ event.mammogramData.incompleteMammographyReasonDetails }}</p>
    {% endif %}
    {% if event.mammogramData.incompleteMammographyFollowUpAppointment %}
      {% set followUpValue = event.mammogramData.incompleteMammographyFollowUpAppointment %}
      {% if followUpValue.startsWith("No") %}
        {{ tag({
          text: "Partial mammography",
          classes: "nhsuk-tag--orange nhsuk-u-margin-top-2 nhsuk-u-margin-bottom-2"
        }) }}
        {# <p class="nhsuk-u-margin-bottom-0">Recorded as partial mammography.</p> #}
      {% else %}
        {{ tag({
          text: "Recall requested",
          classes: "nhsuk-tag--orange nhsuk-u-margin-top-2 nhsuk-u-margin-bottom-2"
        }) }}
        {# <p class="nhsuk-u-margin-bottom-{% if event.mammogramData.incompleteMammographyFollowUpAppointmentDetails %}1{% else %}0{% endif %}">Participant to be invited to a recall appointment to take more images.</p> #}
        {% if event.mammogramData.incompleteMammographyFollowUpAppointmentDetails %}
          <p class="nhsuk-u-margin-bottom-0">Note for scheduling recall appointment:<br>{{ event.mammogramData.incompleteMammographyFollowUpAppointmentDetails }}</p>
        {% endif %}
      {% endif %}
    {% endif %}
  {% endset %}
  
  {% set summaryRows = summaryRows | push({
    key: {
      text: "Not all mammograms taken"
    },
    value: {
      html: incompleteMammographyHtml
    },
    actions: {
      items: [
        {
          href: ("./images-manual-details" if isManualEntry else defaultHref) | urlWithReferrer(referrerChain, scrollTo),
          text: "Change",
          visuallyHiddenText: "not all mammograms taken"
        }
      ]
    } if allowEdits
  }) %}
{% endif %}



{# OLD Repeats and additional images (separate row) - keeping for reference #}
{# {% if hasRepeatsOrExtras %}
  {% set summaryRows = summaryRows | push({
    key: {
      text: "Additional images"
    },
    value: {
      html: extraImagesHtml
    },
    actions: {
      items: [
        {
          href: ("./images-manual-repeats" if isManualEntry else defaultHref) | urlWithReferrer(referrerChain, scrollTo),
          text: "Change",
          visuallyHiddenText: "additional images"
        }
      ]
    }
  }) %}
{% endif %} #}

{# Notes for reader #}
{# {% if event.mammogramData.notesForReader %} #}
  {% set summaryRows = summaryRows | push({
    key: {
      text: "Notes for reader"
    },
    value: {
      text: event.mammogramData.notesForReader
    },
    actions: {
      items: [
        {
          href: ("./images-manual-details" if isManualEntry else defaultHref) | urlWithReferrer(referrerChain, scrollTo),
          text: "Change",
          visuallyHiddenText: "notes for reader"
        }
      ]
    } if allowEdits
  }) %}
{# {% endif %} #}

{{ summaryList({
  rows: summaryRows
} | handleSummaryListMissingInformation) }}