{# app/views/_includes/summary-lists/read-summary.njk #}
{# 
  Summary list showing a reading assessment.
  Outputs a summary list - wrap in a card if needed.
  
  Parameters:
    - read: object - the read data (defaults to data.imageReadingTemp)
    - allowEdits: boolean - whether to show change links (default: false)
    - changeOpinionUrl: string - URL for change opinion link
    - hideEmptyRows: boolean - if true, only show rows that have data (default: false)
#}

{% set read = read if read is defined else data.imageReadingTemp %}
{% set allowEdits = allowEdits if allowEdits is defined else false %}
{% set hideEmptyRows = hideEmptyRows if hideEmptyRows is defined else false %}
{# Support legacy opinionOnly parameter #}
{% if opinionOnly is defined and opinionOnly %}
  {% set hideEmptyRows = true %}
{% endif %}

{# Format the opinion for display #}
{% set opinionText %}
  {% if read.opinion == 'normal' %}
    Normal
  {% elseif read.opinion == 'technical_recall' %}
    Technical recall
  {% elseif read.opinion == 'recall_for_assessment' %}
    Recall for assessment
  {% else %}
    {{ read.opinion }}
  {% endif %}
{% endset %}

{# Count annotations #}
{% set leftAnnotations = read.left.annotations if read.left and read.left.annotations else [] %}
{% set rightAnnotations = read.right.annotations if read.right and read.right.annotations else [] %}
{% set totalAnnotations = leftAnnotations | length + rightAnnotations | length %}
{% set leftAnnotationSummaries = leftAnnotations | summariseAnnotations %}
{% set rightAnnotationSummaries = rightAnnotations | summariseAnnotations %}

{# Build annotation summary #}
{% set annotationSummaryHtml %}
  {% if totalAnnotations == 0 %}
    No annotations added
  {% else %}
    {% if leftAnnotationSummaries | length > 0 %}
      <p class="nhsuk-u-margin-bottom-1">
        <strong>Left breast:</strong>
      </p>
      {% if leftAnnotationSummaries | length == 1 %}
        <p class="nhsuk-u-margin-bottom-2">{{ leftAnnotationSummaries[0] }}</p>
      {% else %}
        <ul class="nhsuk-list nhsuk-list--bullet nhsuk-u-margin-bottom-2">
          {% for summary in leftAnnotationSummaries %}
            <li>{{ summary }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endif %}
    {% if rightAnnotationSummaries | length > 0 %}
      <p class="nhsuk-u-margin-bottom-1">
        <strong>Right breast:</strong>
      </p>
      {% if rightAnnotationSummaries | length == 1 %}
        <p class="nhsuk-u-margin-bottom-2">{{ rightAnnotationSummaries[0] }}</p>
      {% else %}
        <ul class="nhsuk-list nhsuk-list--bullet nhsuk-u-margin-bottom-2">
          {% for summary in rightAnnotationSummaries %}
            <li>{{ summary }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endif %}
  {% endif %}
{% endset %}

{# Build rows based on result type #}
{% set rows = [] %}

{# Opinion row - always shown #}
{% set rows = rows | push({
  key: {
    text: "Opinion"
  },
  value: {
    html: read.opinion | toTag
  },
  actions: {
    items: [
      {
        href: changeOpinionUrl,
        text: "Change",
        visuallyHiddenText: "opinion"
      }
    ]
  } if allowEdits and changeOpinionUrl
}) %}

{# Determine if detail rows have data #}
{% set hasNormalDetails = read.opinion == 'normal' and read.normalDetails %}
{% set hasTechRecallViews = read.opinion == 'technical_recall' and read.technicalRecall and read.technicalRecall.views and (read.technicalRecall.views | length > 0) %}
{% set hasBreastAssessment = read.opinion == 'recall_for_assessment' and ((read.left and read.left.breastAssessment) or (read.right and read.right.breastAssessment)) %}
{% set hasAnnotations = read.opinion == 'recall_for_assessment' and (totalAnnotations > 0) %}

{# Normal - additional details #}
{% if read.opinion == 'normal' and read.normalDetails %}
  {% set rows = rows | push({
    key: {
      text: "Details"
    },
    value: {
      text: read.normalDetails
    },
    actions: {
      items: [
        {
          href: "./normal-details",
          text: "Change",
          visuallyHiddenText: "details"
        }
      ]
    } if allowEdits
  }) %}
{% endif %}

{# Technical recall - views to retake #}
{% if read.opinion == 'technical_recall' %}
  {% set techRecallViews = read.technicalRecall.views | default({}) %}
  
  {% if techRecallViews | length > 0 %}
    {# Build display text for each view with reason #}
    {% set viewsHtml %}
      <ul class="nhsuk-list">
        {% for viewCode, viewData in techRecallViews %}
          <li>
            <strong>{{ viewCode }}</strong>
            {%- if viewData.reason %}: {{ viewData.reason }}{% endif %}
            {%- if viewData.additionalDetails %} â€“ {{ viewData.additionalDetails }}{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endset %}

    {% set rows = rows | push({
      key: {
        text: "Views to retake"
      },
      value: {
        html: viewsHtml
      },
      actions: {
        items: [
          {
            href: "./technical-recall",
            text: "Change",
            visuallyHiddenText: "views"
          }
        ]
      } if allowEdits
    }) %}
  {% endif %}
{% endif %}

{# Recall for assessment details #}
{% if read.opinion == 'recall_for_assessment' %}
  
  {% set breastAssessmentHtml %}
    <div class="nhsuk-grid-row nhsuk-u-margin-bottom-0">
      {% for breastSide in ["right", "left"] %}
        {% set breastData = read[breastSide] %}
        {% set sideLabel = breastSide | capitalize %}
        <div class="nhsuk-grid-column-one-half nhsuk-u-margin-bottom-2">
          <p class="nhsuk-u-font-weight-bold nhsuk-u-margin-bottom-1">{{ sideLabel }} breast</p>
          {% if breastData and breastData.breastAssessment %}
            {% set assessmentKey = breastData.breastAssessment | lower %}
            {% set tagStatusMap = {
              "normal": "normal",
              "clinical": "clinical_recall",
              "abnormal": "abnormal"
            } %}
            {% set tagStatus = tagStatusMap[assessmentKey] | default(breastData.breastAssessment) %}
            <div class="nhsuk-u-margin-bottom-1">
              {{ tagStatus | toTag }}
            </div>
            {% if breastData.comment %}
              <p class="nhsuk-u-margin-bottom-0">Comment: {{ breastData.comment }}</p>
            {% endif %}
          {% else %}
            <p class="nhsuk-u-secondary-text-color nhsuk-u-margin-bottom-0">Not recorded</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% endset %}

  {# Only show detailed opinion if we have data, or if not hiding empty rows #}
  {% if not hideEmptyRows or hasBreastAssessment %}
    {% set rows = rows | push({
      key: {
        text: "Detailed opinion"
      },
      value: {
        html: breastAssessmentHtml
      },
      actions: {
        items: [
          {
            href: "./recall-for-assessment-details",
            text: "Change",
            visuallyHiddenText: "detailed opinion"
          }
        ]
      } if allowEdits
    }) %}
  {% endif %}

  {# Only show annotations if we have data, or if not hiding empty rows #}
  {% if not hideEmptyRows or hasAnnotations %}
    {% set rows = rows | push({
      key: {
        text: "Annotations"
      },
      value: {
        html: annotationSummaryHtml
      },
      actions: {
        items: [
          {
            href: "./recall-for-assessment-details",
            text: "Change",
            visuallyHiddenText: "annotations"
          }
        ]
      } if allowEdits
    }) %}
  {% endif %}
  
{% endif %}

{# Normal with details #}
{% if read.opinion == 'normal' %}
  {% if read.normalComment %}
    {% set rows = rows | push({
      key: {
        text: "Comment"
      },
      value: {
        text: read.normalComment
      }
    }) %}
  {% endif %}
{% endif %}

{{ summaryList({
  rows: rows | removeLastRowBorder
}) }}
