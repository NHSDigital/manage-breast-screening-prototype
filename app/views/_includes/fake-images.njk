{# /app/views/_includes/fake-images.njk #}

<div class="nhsuk-u-margin-bottom-4">

  {# Convert object to an array of views #}
  {% set mammogramViews = event.mammogramData.views | getObjectValues %}

  {# Check if this is manual entry #}
  {% set isManualEntry = event.mammogramData.isManualEntry %}

  {# Group views by view name so we get MLO or CC only #}
  {% set groupedViews = mammogramViews | groupby("viewShort") %}

  {# Iterate through each view - they should be in a set / known order #}
  {% for viewName, view in groupedViews %}

    {# General view name - "MLO views" #}
    {% set viewNameString %}
      {{ viewName }} views
    {% endset %}

    {# Capture html for entire view #}
    {% set viewCardHtml %}

      {# Right then left #}
      {% for side in view %}
        <div class="{{ 'nhsuk-u-margin-bottom-3' if not loop.last }}">

          {# Display differently for manual vs automated #}
          {% if isManualEntry %}
            {# Manual entry - show count only #}
            <h2>
              {{ side.count }} {{ side.viewShortWithSide }} {{ "image" | pluralise(side.count) }}
            </h2>

            {{ summaryList({
              classes: "nhsuk-u-margin-bottom-0",
              rows: [
                {
                  key: {
                    text: "Machine room"
                  },
                  value: {
                    text: event.mammogramData.machineRoom or "Not recorded"
                  }
                }
              ]
            }) }}

            {# Show repeat information if present #}
            {% if side.repeatCount > 0 and side.repeatReasons %}
              <p class="nhsuk-u-margin-top-2">
                <strong>Repeat {{ 'reason' | pluralise(side.repeatReasons | length) }}:</strong> {{ side.repeatReasons | join(', ') }}
              </p>
            {% endif %}

          {% else %}
            {# Automated entry - show full image details #}
            <h2>
              {{ side.images | length }} {{ side.viewShortWithSide }} {{ "image" | pluralise(side.images | length) }}
            </h2>

            {# Loop through each image for each side #}
            {% for image in side.images %}
              <div class="nhsuk-grid-row {{ 'nhsuk-u-margin-bottom-3' if not loop.last }}">
                <div class="nhsuk-grid-column-three-quarters">
                  {{ summaryList({
                    classes: "nhsuk-u-margin-bottom-0",
                    rows: [
                      {
                        key: {
                          text: "Captured"
                        },
                        value: {
                          text: image.timestamp | formatDateTime("D MMMM YYYY, H:mm:ss a")
                        }
                      },
                      {
                        key: {
                          text: "Accession"
                        },
                        value: {
                          html: image.accessionNumber
                        }
                      }
                    ]
                  }) }}
                </div>
                {# Small graphic of mammogram #}
                <div class="nhsuk-grid-column-one-quarter">
                  <div class="app-mammogram-image--placeholder">
                    <img class="nhsuk-image__img" src="/images/mammogram-diagrams/{{ side.viewShortWithSide | lower }}.png" alt="">
                  </div>
                </div>
              </div>

            {# If there are no images, show inset text - likely partial mammography #}
            {% else %}
              {% set insetHtml %}
                <p>There are no {{ side.viewShortWithSide }} images</p>
              {% endset %}
              {{ insetText({
                html: insetHtml
              }) }}
            {% endfor %}

            {# If there are multiple images for a side, show UI for repeats #}
            {% if side.images | length > 1 %}

              <div class="nhsuk-grid-row">
                <div class="nhsuk-grid-column-two-thirds nhsuk-u-margin-top-3">
                  
                  {% set repeatReasons = data.repeatReasons %}
                  {% set reasonItems = [{
                    value: "",
                    text: "Please select",
                    selected: true
                  }] %}
                  
                  {% for reason in repeatReasons %}
                    {% set item = {
                      value: reason,
                      text: reason
                    } %}
                    {% set reasonItems = reasonItems | push(item) %}
                  {% endfor %}
                  
                  {{ radios({
                    idPrefix: "isRepeatQuestion-" + side.viewShortWithSide,
                    name: "event[mammogramData][isRepeatQuestion-" + side.viewShortWithSide + "]",
                    fieldset: {
                      legend: {
                        text: "Why are there multiple " + side.viewShortWithSide + " images?",
                        classes: "nhsuk-fieldset__legend--s",
                        isPageHeading: false
                      }
                    },
                    value: event.mammogramData["isRepeatQuestion-" + side.viewShortWithSide],
                    items: [
                      {
                        value: "isRepeat",
                        text: "A repeat was needed",
                        conditional: {
                          html: select({
                            id: "repeatReason-" + side.viewShortWithSide,
                            name: "event[mammogramData][repeatReason-" + side.viewShortWithSide + "]",
                            label: {
                              text: "Repeat reason"
                            },
                            value: event.mammogramData["repeatReason-" + side.viewShortWithSide],
                            items: reasonItems
                          })
                        }
                      },
                      {
                        value: "extraImages",
                        text: "Additional images were required to capture complete view"
                      }
                    ]
                  }) }}
                </div>
              </div>

            {% endif %}
          {% endif %}
        </div>

      {% endfor %}

    {% endset %}

    {{ card({
      heading: viewNameString | sentenceCase,
      headingLevel: "2",
      feature: true,
      descriptionHtml: viewCardHtml
    }) }}
  {% endfor %}
</div>


{% block pageScripts %}
  {% if animateImages %}
    <script type="module">
      document.addEventListener('DOMContentLoaded', () => {
        const loadingSpinner = document.getElementById('loading-spinner')
        const imageCards = document.querySelectorAll('.app-image-card')
        const imagingForm = document.getElementById('imaging-form')

        if (!loadingSpinner || !imageCards.length || !imagingForm)
        {
          return
        }

        // Hide spinner after initial delay
        setTimeout(() => {
          loadingSpinner.classList.add('app-hidden')

          // Show each image sequentially
          imageCards.forEach((card, index) => {
            // Increased time between images to 2 seconds
            const loadTime = 1000 + (index * 2000)

            setTimeout(() => {
              card.classList.remove('app-hidden')
              card.style.opacity = 0
              card.style.transition = 'opacity 0.5s ease-in'
              setTimeout(() => card.style.opacity = 1, 50)

              // Show form at same time as first image
              if (index === 0)
              {
                imagingForm.classList.remove('app-hidden')
                imagingForm.style.opacity = 0
                imagingForm.style.transition = 'opacity 0.5s ease-in'
                setTimeout(() => imagingForm.style.opacity = 1, 50)
              }
            }, loadTime)
          })
        }, 1000)
      })
      </script>
  {% endif %}

{% endblock %}