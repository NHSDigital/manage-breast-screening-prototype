{% extends 'layout-app.html' %}

{% set pageHeading = "Medical information" %}

{% set gridColumn = "nhsuk-grid-column-full" %}

{% set formAction = "./../record-medical-information" | getReturnUrl(referrerChain) %}

{% block pageContent %}

  {% set unit = data.breastScreeningUnits | findById(clinic.breastScreeningUnitId) %}

  <h1 class="nhsuk-heading-l">
    <span class="nhsuk-caption-l">
      {{ participant | getFullName }}
    </span>
    {{ pageHeading }}
  </h1>

  <hr class="nhsuk-section-break nhsuk-section-break--m nhsuk-section-break--visible">

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">
      {{ button({
        text: "Nothing further to add",
        classes: "nhsuk-u-margin-bottom-0 nhsuk-button--secondary"
      }) }}

      {# <p>
        Selecting this confirms there is nothing further to record for the 4 remaining medical information sections
      </p> #}
    </div>
  </div>

  <hr class="nhsuk-section-break nhsuk-section-break--m nhsuk-section-break--visible">

  {% set medicalHistoryHtml %}
    {% include "summary-lists/medical-information/medical-history.njk" %}
  {% endset %}

  {{ appDetails({
    id: "medical-information",
    classes: "nhsuk-expander",
    summaryText: "Medical history",
    subtitle: "Including breast cancer, implants, prior proceedures and treatments",
    html: medicalHistoryHtml,
    status: "Incomplete"
  }) }}

  {% set currentSymptomsHtml %}
    {% include "summary-lists/medical-information/symptoms/summary.njk" %}

      {% set hasSymptoms = event.medicalInformation.symptoms and event.medicalInformation.symptoms | length %}

      {% if not hasSymptoms %}
        {% set insetHtml %}
          <p>No symptoms have been recorded for this participant.</p>
        {% endset %}
        {{ insetText({
          html: insetHtml
        }) }}
      {% endif %}

      {% set linkHref %}
        {{ "./medical-information/symptoms/add" | urlWithReferrer(currentUrl) }}
      {% endset %}

      {# <p class="nhsuk-u-margin-top-4 nhsuk-u-margin-bottom-0">
        <a href="{{ linkHref }}" class="nhsuk-link">{{ "Add another symptom" if hasSymptoms else "Add a symptom" }}</a>
      </p> #}

      {# Explicitly set referrer chain to the current url #}
      {% set referrerChain = currentUrl %}
      {% include "add-symptom-button-menu.njk" %}
  {% endset %}


  {{ appDetails({
    id: "current-symptoms",
    classes: "nhsuk-expander",
    summaryText: "Current symptoms",
    subtitle: "Details of any lumps, swelling, rashes or nipple changes",
    html: currentSymptomsHtml,
    status: "Incomplete"
  }) }}

  {% set breastFeaturesHtml %}
    {% include "_includes/medical-information/breast-features.njk" %}
  {% endset %}

  {{ appDetails({
    id: "breast-features",
    classes: "nhsuk-expander",
    summaryText: "Breast features",
    subtitle: "Significant scars, moles or warts that may appear on mammogram images",
    html: breastFeaturesHtml,
    status: "Incomplete"
  }) }}

  {% set otherRelevantInformationHtml %}
    {% include "_includes/summary-lists/medical-information/other-relevant-information.njk" %}
  {% endset %}

  {{ appDetails({
    id: "other-medical-information",
    classes: "nhsuk-expander",
    summaryText: "Other medical information",
    subtitle: "Record factors that could affect breast density sich as HRT, pregnancy or breastfeeding, and mammographer notes",
    html: otherRelevantInformationHtml,
    status: "Incomplete"
  }) }}

  <div class="nhsuk-form-group">
    {{ button({
      text: "Complete all and continue"
    }) }}
  </div>

  {% include "screening-cannot-proceed-link.njk" %}


    <!-- Progress Summary - One third width -->
    {# <div class="nhsuk-grid-column-one-third app-sidebar-sticky">
      <div class="nhsuk-card">
        <div class="nhsuk-card__content">
          <h2 class="nhsuk-card__heading nhsuk-heading-s">
            Overview
          </h2>
          <p class="nhsuk-heading-m nhsuk-u-margin-bottom-2">
            <strong id="progress-complete">0</strong> out of 8
          </p>
          <p class="nhsuk-body-s nhsuk-u-margin-bottom-0">
            Sections completed
          </p>
        </div>
      </div>
    </div> #}


<script>
document.addEventListener('DOMContentLoaded', function() {
  const sections = document.querySelectorAll('.nhsuk-details')
  const completedSections = new Set()

  sections.forEach(function(section, index) {
    const content = section.querySelector('.nhsuk-details__text')
    if (content) {
      // Create button container
      const buttonContainer = document.createElement('div')
      buttonContainer.className = 'nhsuk-form-group'

      // Create button
      const button = document.createElement('button')
      button.className = 'nhsuk-button nhsuk-button--secondary nhsuk-u-margin-bottom-0 nhsuk-u-margin-top-3 js-save-and-next'
      button.textContent = 'Mark as complete'
      button.type = 'button'
      button.setAttribute('data-section-index', index)

      buttonContainer.appendChild(button)
      content.appendChild(buttonContainer)

      // Add click handler
      button.addEventListener('click', function() {
        // Mark current section as completed
        completedSections.add(index)

        // Update the status for this section
        updateSectionStatus(section, 'Complete')

        // Close current section
        section.removeAttribute('open')

        // Open next section
        const nextSection = sections[index + 1]
        if (nextSection) {
          nextSection.setAttribute('open', 'open')
          const nextSummary = nextSection.querySelector('.nhsuk-details__summary')
          if (nextSummary) {
            nextSummary.scrollIntoView({ behavior: 'smooth', block: 'start' })
          } else {
            nextSection.scrollIntoView({ behavior: 'smooth', block: 'start' })
          }
        }

        // Update progress counter
        updateProgress()
      })
    }
  })

  // Function to update section status
  function updateSectionStatus(section, statusText) {
    const sectionId = section.getAttribute('id')
    let statusElement = null

    // Try different strategies to find the status element
    // Strategy 1: Look for status in parent/sibling elements
    const parent = section.parentElement
    if (parent) {
      statusElement = parent.querySelector('.app-details__status .nhsuk-tag')
    }

    // Strategy 2: Look for status element by section ID (if it follows a pattern)
    if (!statusElement && sectionId) {
      // Look for a status element that might be associated with this section
      statusElement = document.querySelector(`[data-section="${sectionId}"] .nhsuk-tag`) ||
                     document.querySelector(`#${sectionId}-status .nhsuk-tag`)
    }

    // Strategy 3: Look for the closest status element before this section
    if (!statusElement) {
      let currentElement = section.previousElementSibling
      while (currentElement && !statusElement) {
        statusElement = currentElement.querySelector('.app-details__status .nhsuk-tag')
        if (!statusElement) {
          currentElement = currentElement.previousElementSibling
        }
      }
    }

    // Strategy 4: Look for the closest status element after this section
    if (!statusElement) {
      let currentElement = section.nextElementSibling
      while (currentElement && !statusElement) {
        statusElement = currentElement.querySelector('.app-details__status .nhsuk-tag')
        if (!statusElement) {
          currentElement = currentElement.nextElementSibling
        }
      }
    }

    // Strategy 5: Look for any status element in the same container as this section
    if (!statusElement) {
      const container = section.closest('.nhsuk-grid-column-two-thirds') || section.closest('.nhsuk-grid-row') || document.body
      const allStatusElements = container.querySelectorAll('.app-details__status .nhsuk-tag')

      // Try to match by index (assuming they're in the same order)
      const allSections = container.querySelectorAll('.nhsuk-details')
      const sectionIndex = Array.from(allSections).indexOf(section)
      if (allStatusElements[sectionIndex]) {
        statusElement = allStatusElements[sectionIndex]
      }
    }

    if (statusElement) {
      console.log('Found status element:', statusElement)
      statusElement.textContent = statusText

      // Update the tag color class based on status
      if (statusText === 'Complete') {
        statusElement.classList.remove('nhsuk-tag--blue')
        statusElement.classList.add('nhsuk-tag--green')
      } else if (statusText === 'Incomplete') {
        statusElement.classList.remove('nhsuk-tag--green')
        statusElement.classList.add('nhsuk-tag--blue')
      }

      console.log('Updated status to:', statusText)
    } else {
      console.error('Could not find status element for section:', sectionId)
    }
  }

  // Progress counter function
  function updateProgress() {
    const totalSections = sections.length
    const completed = completedSections.size
    const inProgress = document.querySelectorAll('.nhsuk-details[open]').length
    const remaining = totalSections - completed - inProgress

    document.getElementById('progress-complete').textContent = completed

    const progressCurrent = document.getElementById('progress-current')
    const progressRemaining = document.getElementById('progress-remaining')

    if (progressCurrent) progressCurrent.textContent = inProgress
    if (progressRemaining) progressRemaining.textContent = remaining
  }

  // Initialize progress
  updateProgress()
})
</script>

<style>
.app-progress-summary--sticky {
  position: sticky;
  top: 0;
  z-index: 100;
  background: white;
  border-bottom: 1px solid #d8dde0;
  margin-bottom: 20px;
}

.app-progress-summary--sticky .app-progress-summary__content {
  margin-bottom: 0;
}

.app-sidebar-sticky {
  position: sticky;
  top: 20px;
  z-index: 100;
  height: fit-content;
}
</style>

{% endblock %}