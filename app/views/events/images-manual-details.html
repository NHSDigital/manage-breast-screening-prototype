{% extends 'layout-appointment.html' %} 

{% set showNavigation = true %}
{% set hideBackLink = true %}
{% set activeWorkflowStep = 'take-images' %}

{% set pageHeading = "Provide image details" %}

{% set gridColumn = "nhsuk-grid-column-two-thirds" %}

{% set formAction = './images-manual-details-answer' %}

{% set activeTab = 'images' %}

{% block pageContent %}

  {# TODO: Ideally this would be before the main element #}
  {{ backLink({
    href: "javascript:history.back();",
    text: "Back",
    classes: "nhsuk-u-margin-top-0 nhsuk-u-margin-bottom-4"
  }) }}

  <h1>{{ pageHeading }}</h1>

  {# Get count values - prefer temp data, fall back to structured mammogramData #}
  {% set mammogramTemp = event.mammogramDataTemp or {} %}
  {% set mammogramViews = event.mammogramData.views or {} %}
  
  {% set viewsRightBreastCCCount = mammogramTemp.viewsRightBreastCCCount or mammogramViews.rightCraniocaudal.count or "1" %}
  {% set viewsRightBreastMLOCount = mammogramTemp.viewsRightBreastMLOCount or mammogramViews.rightMediolateralOblique.count or "1" %}
  {% set viewsRightBreastEklundCount = mammogramTemp.viewsRightBreastEklundCount or mammogramViews.rightEklund.count or "0" %}
  {% set viewsLeftBreastCCCount = mammogramTemp.viewsLeftBreastCCCount or mammogramViews.leftCraniocaudal.count or "1" %}
  {% set viewsLeftBreastMLOCount = mammogramTemp.viewsLeftBreastMLOCount or mammogramViews.leftMediolateralOblique.count or "1" %}
  {% set viewsLeftBreastEklundCount = mammogramTemp.viewsLeftBreastEklundCount or mammogramViews.leftEklund.count or "0" %}
  {% set additionalDetails = mammogramTemp.additionalDetails or event.mammogramData.additionalDetails or "" %}
  {% set notesForReader = mammogramTemp.notesForReader or event.mammogramData.notesForReader or "" %}
  
  {# Set mammogramSource for incomplete mammography question - prefer temp data, fall back to final data #}
  {% set mammogramSource = mammogramTemp or event.mammogramData or {} %}

  {{ appHiddenInput({
    name: "event[mammogramDataTemp][uiVersion]",
    value: "inputs"
  }) }}

  {% set viewsQuestionText %}
    How many images were taken
  {%- endset %}

  {# H2 hidden from AT as it's included in the fieldset legend of each set of inputs #}
  <h2 aria-hidden="true">{{ viewsQuestionText }}?</h2>

    <div class="nhsuk-grid-row">
      <div class="nhsuk-grid-column-one-half">
        <fieldset class="nhsuk-fieldset">
          <legend class="nhsuk-fieldset__legend nhsuk-fieldset__legend--s">
            {{ (viewsQuestionText + " for the") | asVisuallyHiddenText }} Right breast
          </legend>
          
          {{ appStepperInput({
            label: {
              text: "RMLO"
            },
            _hint: {
              text: "Mediolateral oblique view"
            },
            name: "event[mammogramDataTemp][viewsRightBreastMLOCount]",
            value: viewsRightBreastMLOCount | default("1"),
            id: "views-right-breast-mlo-count",
            min: 0,
            max: 9
          }) }}
          
          {{ appStepperInput({
            label: {
              text: "RCC"
            },
            _hint: {
              text: "Craniocaudal view"
            },
            name: "event[mammogramDataTemp][viewsRightBreastCCCount]",
            value: viewsRightBreastCCCount | default("1"),
            id: "views-right-breast-cc-count",
            min: 0,
            max: 9
          }) }}
          
          {{ appStepperInput({
            label: {
              text: "Right Eklund"
            },
            hint: {
              text: "Used with breast implants"
            },
            name: "event[mammogramDataTemp][viewsRightBreastEklundCount]",
            value: viewsRightBreastEklundCount | default("0"),
            id: "views-right-breast-eklund-count",
            min: 0,
            max: 9
          }) }}
        </fieldset>
      </div>
      
      <div class="nhsuk-grid-column-one-half">
        <fieldset class="nhsuk-fieldset">
          <legend class="nhsuk-fieldset__legend nhsuk-fieldset__legend--s">
            {{ (viewsQuestionText + " for the") | asVisuallyHiddenText }} Left breast
          </legend>
          
          {{ appStepperInput({
            label: {
              text: "LMLO"
            },
            _hint: {
              text: "Mediolateral oblique view"
            },
            name: "event[mammogramDataTemp][viewsLeftBreastMLOCount]",
            value: viewsLeftBreastMLOCount | default("1"),
            id: "views-left-breast-mlo-count",
            min: 0,
            max: 9
          }) }}
          
          {{ appStepperInput({
            label: {
              text: "LCC"
            },
            _hint: {
              text: "Craniocaudal view"
            },
            name: "event[mammogramDataTemp][viewsLeftBreastCCCount]",
            value: viewsLeftBreastCCCount | default("1"),
            id: "views-left-breast-cc-count",
            min: 0,
            max: 9
          }) }}
          
          {{ appStepperInput({
            label: {
              text: "Left Eklund"
            },
            hint: {
              text: "Used with breast implants"
            },
            name: "event[mammogramDataTemp][viewsLeftBreastEklundCount]",
            value: viewsLeftBreastEklundCount | default("0"),
            id: "views-left-breast-eklund-count",
            min: 0,
            max: 9
          }) }}
        </fieldset>
      </div>
    </div>

  {# Calculate initial total count from form data #}
  {% set initialTotalCount = 0 %}
  {% set initialTotalCount = initialTotalCount + (viewsRightBreastCCCount | int(0)) %}
  {% set initialTotalCount = initialTotalCount + (viewsRightBreastMLOCount | int(0)) %}
  {% set initialTotalCount = initialTotalCount + (viewsRightBreastEklundCount | int(0)) %}
  {% set initialTotalCount = initialTotalCount + (viewsLeftBreastCCCount | int(0)) %}
  {% set initialTotalCount = initialTotalCount + (viewsLeftBreastMLOCount | int(0)) %}
  {% set initialTotalCount = initialTotalCount + (viewsLeftBreastEklundCount | int(0)) %}

  <p class="_nhsuk-u-font-weight-bold app-js-only app-text-grey nhsuk-u-margin-bottom-4 nhsuk-u-font-size-22" id="total-images-count">
    Images taken: <span data-total-count>{{ initialTotalCount }}</span>
  </p>

  {% set insetTextHtml %}
    <p>Repeat or extra image details captured on the next screen</p>
  {% endset %}

  {{ insetText({
    html: insetTextHtml,
    attributes: {
      "id": "repeat-images-inset",
      "data-module": "repeat-images-notice",
      "style": "display: none;"
    }
  }) }}

  <h2>Additional details</h2>

  {% set namePrefix = "event[mammogramDataTemp]" %}
  {# {% include "_includes/partial-mammography-question.njk" %} #}
  {% include "_includes/incomplete-mammography-question.njk" %}

  {{ textarea({
    name: "event[mammogramDataTemp][notesForReader]",
    id: "notes-for-reader-details",
    value: notesForReader,
    label: {
      text: "Notes for reader (optional)",
      classes: "nhsuk-label--s"
    },
    hint: {
      text: "Provide information for image readers when reviewing"
    },
    rows: 2
  }) }}

  {{ button({
    text: "Continue"
  }) }}

{% endblock %}

{% block pageScripts %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const insetText = document.querySelector('[data-module="repeat-images-notice"]')
      const totalCountElement = document.querySelector('[data-total-count]')
      
      if (!insetText) {
        return
      }

      // Function to get all currently visible count inputs
      const getCountInputs = () => {
        return [
          document.getElementById('views-right-breast-cc-count'),
          document.getElementById('views-right-breast-mlo-count'),
          document.getElementById('views-right-breast-eklund-count'),
          document.getElementById('views-left-breast-cc-count'),
          document.getElementById('views-left-breast-mlo-count'),
          document.getElementById('views-left-breast-eklund-count')
        ].filter(Boolean) // Remove any null values
      }

      // Function to calculate total image count
      const getTotalCount = () => {
        const inputs = getCountInputs()
        return inputs.reduce((total, input) => {
          const value = parseInt(input.value, 10)
          return total + (isNaN(value) ? 0 : value)
        }, 0)
      }

      // Function to check if any count is greater than 1
      const hasRepeats = () => {
        const inputs = getCountInputs()
        return inputs.some(input => {
          const value = parseInt(input.value, 10)
          return !isNaN(value) && value > 1
        })
      }

      // Function to update total count display
      const updateTotalCount = () => {
        if (totalCountElement) {
          const total = getTotalCount()
          totalCountElement.textContent = total
        }
      }

      // Function to update visibility
      const updateVisibility = () => {
        if (hasRepeats()) {
          insetText.style.display = ''
        } else {
          insetText.style.display = 'none'
        }
      }

      // Function to update everything
      const updateAll = () => {
        updateTotalCount()
        updateVisibility()
      }

      // Set initial state after a short delay to allow conditional reveals to initialize
      setTimeout(updateAll, 100)

      // Add event listeners using delegation on the form
      document.addEventListener('input', (event) => {
        const target = event.target
        if (target.id && target.id.includes('breast') && target.id.includes('count')) {
          updateAll()
        }
      })

      document.addEventListener('change', (event) => {
        const target = event.target
        // Handle checkbox changes (which reveal/hide conditional inputs)
        if (target.name && target.name.includes('event[mammogramDataTemp][views')) {
          setTimeout(updateAll, 100)
        }
        // Handle count input changes
        if (target.id && target.id.includes('breast') && target.id.includes('count')) {
          updateAll()
        }
      })
    })
  </script>
{% endblock %}