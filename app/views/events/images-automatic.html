{% extends 'layout-appointment.html' %}

{% set imageCount = event.mammogramData.metadata.totalImages %}

{% set pageHeading = "Review image details" %}

{% set mammogramSource = event.mammogramData %}
{% set namePrefix = "event[mammogramData]" %}

{% set showNavigation = true %}
{% set activeWorkflowStep = 'take-images' %}
{% set hideBackLink = true %}

{# {% set hideBackLink = true %} #}


{% set gridColumn = "nhsuk-grid-column-full" %}
{% set formAction = './imaging-answer' %}

{% set activeTab = 'images' %}

{% block pageContent %}

  <h1>{{ pageHeading }}</h1>

  {% if data.event.workflowStatus["take-images"] == 'completed' %}
    {{ button({
      text: "Next section",
      classes: "nhsuk-u-margin-bottom-1"
    }) }}
  {% endif %}

  {% set insetTextHtml %}
    <p>{{ imageCount }} images have been detected and imported from PACS</p>
  {% endset %}

  {{ insetText({
    html: insetTextHtml
  }) }}

  

  {# Convert object to an array of views and get machine room #}
  {% set mammogramViews = event.mammogramData.views | getObjectValues %}
  {% set machineRoom = event.mammogramData.machineRoom %}
  
  {# HACK: Remove RCC view to test missing placeholder #}
  {# {% set filteredViews = [] %}
  {% for viewItem in mammogramViews %}
    {% if viewItem.viewShortWithSide != 'RCC' %}
      {% set filteredViews = filteredViews | push(viewItem) %}
    {% endif %}
  {% endfor %}
  {% set mammogramViews = filteredViews %} #}

  {# Define standard views that should always be shown #}
  {% set standardViews = [
    { side: 'right', viewShort: 'MLO', viewShortWithSide: 'RMLO' },
    { side: 'right', viewShort: 'CC', viewShortWithSide: 'RCC' },
    { side: 'left', viewShort: 'MLO', viewShortWithSide: 'LMLO' },
    { side: 'left', viewShort: 'CC', viewShortWithSide: 'LCC' }
  ] %}

  {# Build complete view lists with placeholders for missing views #}
  {% set rightViews = [] %}
  {% set leftViews = [] %}
  {% for standardView in standardViews %}
    {# Find if this view exists in the data #}
    {% set viewData = null %}
    {% for viewItem in mammogramViews %}
      {% if viewItem.viewShortWithSide == standardView.viewShortWithSide %}
        {% set viewData = viewItem %}
      {% endif %}
    {% endfor %}
    
    {% if not viewData %}
      {# Create placeholder for missing view #}
      {% set viewData = {
        side: standardView.side,
        viewShort: standardView.viewShort,
        viewShortWithSide: standardView.viewShortWithSide,
        images: [],
        isMissing: true
      } %}
    {% endif %}
    
    {% if standardView.side == 'right' %}
      {% set rightViews = rightViews | push(viewData) %}
    {% else %}
      {% set leftViews = leftViews | push(viewData) %}
    {% endif %}
  {% endfor %}

  {# Display in two columns: right breast on left, left breast on right #}
  <div class="nhsuk-grid-row">
    {# Right views on the left #}
    <div class="nhsuk-grid-column-one-half">
      {% set rightViewsHtml %}
        {% for viewItem in rightViews %}
          {% set isManualEntry = false %}
          {% include "_includes/mammogram-image-display.njk" %}
        {% endfor %}
      {% endset %}

      {{ card({
        heading: "Right breast",
        headingLevel: "2",
        feature: true,
        descriptionHtml: rightViewsHtml
      }) }}
    </div>

    {# Left views on the right #}
    <div class="nhsuk-grid-column-one-half">
      {% set leftViewsHtml %}
        {% for viewItem in leftViews %}
          {% set isManualEntry = false %}
          {% include "_includes/mammogram-image-display.njk" %}
        {% endfor %}
      {% endset %}

      {{ card({
        heading: "Left breast",
        headingLevel: "2",
        feature: true,
        descriptionHtml: leftViewsHtml
      }) }}
    </div>
  </div>

  <p><a href="#">View imported image metadata</a></p>

  <div class="nhsuk-button-group nhsuk-u-margin-bottom-0">
    {{ button({
      text: "Re-scan PACS for image updates",
      classes: "nhsuk-button--secondary"
    }) }}

    <a class="nhsuk-link app-link--error" href="#">There is a problem with the images</a>
  </div>

  {# Build array of views needing repeat questions (count > 1) #}
  {% set viewsNeedingRepeats = [] %}
  {% for view in mammogramViews %}
    {% if (view.images | length) > 1 %}
      {% set viewsNeedingRepeats = viewsNeedingRepeats | push({
        side: view.side | capitalize,
        view: view.viewShort,
        code: view.viewShortWithSide,
        count: view.images | length
      }) %}
    {% endif %}
  {% endfor %}

  {# Show repeat questions if any views have multiple images #}
  {% if viewsNeedingRepeats | length > 0 %}
    <hr class="nhsuk-section-break nhsuk-section-break--m nhsuk-section-break--visible">

    <div class="nhsuk-grid-row">
      <div class="nhsuk-grid-column-two-thirds">
        <h2>Additional images</h2>
        {# <p>Some views have multiple images. Please provide information about why additional images were taken.</p> #}

        {% for viewItem in viewsNeedingRepeats %}
          {% set namePrefix = "event[mammogramData]" %}
          {% set dataSource = event.mammogramData %}
          {% set radioQuestionSize = "s" %}
          {% include "_includes/images-repeat-question.njk" %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  

  <hr class="nhsuk-section-break nhsuk-section-break--m nhsuk-section-break--visible nhsuk-u-margin-top-0">

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      {# {% include "_includes/partial-mammography-question.njk" %} #}
      {% include "_includes/incomplete-mammography-question.njk" %}

      {{ textarea({
        name: "event[mammogramData][additionalDetails]",
        id: "additional-details",
        value: event.mammogramData.additionalDetails,
        label: {
          text: "Additional details (optional)",
          classes: "nhsuk-label--m"
        },
        hint: {
          text: "Provide information for image readers when reviewing"
        },
        rows: 2
      }) }}

      {{ button({
        text: "Confirm images"
      }) }}

    </div>
  </div>

{% endblock %}


