{% extends 'layout-appointment.html' %}

{% set imageCount = event.mammogramData.metadata.totalImages %}

{% set pageHeading = imageCount + " images taken" %}

{% set mammogramSource = event.mammogramData %}
{% set namePrefix = "event[mammogramData]" %}

{% set showNavigation = true %}
{% set activeWorkflowStep = 'take-images' %}
{% set hideBackLink = true %}

{# {% set hideBackLink = true %} #}


{% set gridColumn = "nhsuk-grid-column-full" %}
{% set formAction = './imaging-answer' %}

{% set activeTab = 'images' %}

{% block pageContent %}

  <h1>{{ pageHeading }}</h1>

  {% if data.event.workflowStatus["take-images"] == 'completed' %}
    {{ button({
      text: "Next section",
      classes: "nhsuk-u-margin-bottom-1 nhsuk-button--secondary"
    }) }}
  {% endif %}

  {# Convert object to an array of views and get machine room #}
  {% set mammogramViews = event.mammogramData.views | getObjectValues %}
  {% set machineRoom = event.mammogramData.machineRoom %}

  {# Group views by view name so we get MLO or CC only #}
  {% set groupedViews = mammogramViews | groupby("viewShort") %}

  {# Iterate through each view type (MLO, CC, etc.) #}
  {% for viewName, viewsInGroup in groupedViews %}

    {# General view name - "MLO views" #}
    {% set viewNameString = viewName + " views" %}

    {# Capture html for entire view group #}
    {% set viewCardHtml %}
      {# Right then left #}
      {% for viewItem in viewsInGroup %}
        {% set isManualEntry = false %}
        {% include "_includes/mammogram-image-display.njk" %}
      {% endfor %}
    {% endset %}

    {{ card({
      heading: viewNameString | sentenceCase,
      headingLevel: "2",
      feature: true,
      descriptionHtml: viewCardHtml
    }) }}
  {% endfor %}

  {# Build array of views needing repeat questions (count > 1) #}
  {% set viewsNeedingRepeats = [] %}
  {% for view in mammogramViews %}
    {% if (view.images | length) > 1 %}
      {% set viewsNeedingRepeats = viewsNeedingRepeats | push({
        side: view.side | capitalize,
        view: view.viewShort,
        code: view.viewShortWithSide,
        count: view.images | length
      }) %}
    {% endif %}
  {% endfor %}

  {# Show repeat questions if any views have multiple images #}
  {% if viewsNeedingRepeats | length > 0 %}
    <hr class="nhsuk-section-break nhsuk-section-break--l nhsuk-section-break--visible">

    <div class="nhsuk-grid-row">
      <div class="nhsuk-grid-column-two-thirds">
        <h2>Multiple images information</h2>
        <p>Some views have multiple images. Please provide information about why additional images were taken.</p>

        {% for viewItem in viewsNeedingRepeats %}
          {% set namePrefix = "event[mammogramData]" %}
          {% set dataSource = event.mammogramData %}
          {% include "_includes/images-repeat-question.njk" %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div class="nhsuk-button-group nhsuk-u-margin-bottom-0">
    {{ button({
      text: "Re-scan PACS for image updates",
      classes: "nhsuk-button--secondary"
    }) }}

    <a class="nhsuk-link app-link--error" href="#">There is a problem with the images</a>
  </div>

  <hr class="nhsuk-section-break nhsuk-section-break--l nhsuk-section-break--visible nhsuk-u-margin-top-3">

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      {% include "_includes/partial-mammography-question.njk" %}

      {{ textarea({
        name: "event[mammogramData][additionalDetails]",
        id: "additional-details",
        value: event.mammogramData.additionalDetails,
        label: {
          text: "Additional details (optional)",
          classes: "nhsuk-label--m"
        },
        hint: {
          text: "Provide information for image readers when reviewing"
        },
        rows: 2
      }) }}

      {{ button({
        text: "Continue"
      }) }}

    </div>
  </div>

{% endblock %}


