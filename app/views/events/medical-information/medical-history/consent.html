{# app/views/events/medical-information/implanted-devices/consent.html #}

{% extends 'layout-appointment.html' %}

{% set pageHeading = "Request consent to continue" %}

{% set gridColumn = "nhsuk-grid-column-two-thirds" %}

{% set formAction = "./consent-answer" | urlWithReferrer(referrerChain, query.scrollTo) %}

{% block pageContent %}

  {% set unit = data.breastScreeningUnits | findById(clinic.breastScreeningUnitId) %}

  {# Read implant data from temporary medical history (not yet saved) #}
  {% set hasRightImplant = false %}
  {% set hasLeftImplant = false %}

  {% if event.medicalHistoryTemp %}
    {% if event.medicalHistoryTemp.proceduresRightBreast %}
      {% for procedure in event.medicalHistoryTemp.proceduresRightBreast %}
        {% if procedure == "Breast implants" %}
          {% set hasRightImplant = true %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if event.medicalHistoryTemp.proceduresLeftBreast %}
      {% for procedure in event.medicalHistoryTemp.proceduresLeftBreast %}
        {% if procedure == "Breast implants" %}
          {% set hasLeftImplant = true %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endif %}

  {# Determine implant configuration #}
  {% set hasBothImplants = hasRightImplant and hasLeftImplant %}
  {% set hasOneSideImplant = (hasRightImplant and not hasLeftImplant) or (hasLeftImplant and not hasRightImplant) %}
  {% set unaffectedBreast = "" %}

  {% if hasOneSideImplant %}
    {% if hasRightImplant %}
      {% set unaffectedBreast = "left" %}
    {% else %}
      {% set unaffectedBreast = "right" %}
    {% endif %}
  {% endif %}

  {# Generate implant description text #}
  {% if hasBothImplants %}
    {% set implantDescription = "implants in both breasts" %}
  {% elif hasRightImplant %}
    {% set implantDescription = "an implant in the right breast" %}
  {% elif hasLeftImplant %}
    {% set implantDescription = "an implant in the left breast" %}
  {% endif %}

  <h1 class="nhsuk-heading-l">
    <span class="nhsuk-caption-l">
      {{ participant | getFullName }}
    </span>
    {{ pageHeading }}
  </h1>

  <p>You have recorded {{ implantDescription }}. You must get the participant's permission to continue.</p>

  <p>There is no medical reason for people with breast implants to avoid the procedure.</p>

  <h2 class="nhsuk-heading-m">Explain the risks</h2>

  <ul class="nhsuk-list nhsuk-list--bullet">
    <li>Very rarely, implants can rupture due to pressure during imaging</li>
    <li>There's a slight increase in radiation exposure if extra images are needed to scan breast tissue</li>
    <li>Implants make it harder to spot signs of cancer as they can obscure breast tissue</li>
  </ul>

  <p>If the participant notices any problems with their implants after the appointment, they should contact their GP.</p>

  <h2 class="nhsuk-heading-m">Ask {{ participant.demographicInformation.firstName or "the participant" }} for their consent</h2>

  <p>Once you've explained the process and the risks, ask them to read and complete your paper consent form.</p>

  {# Build radio items array #}
  {% set radioItems = [
    {
      value: "yes",
      text: "Yes"
    }
  ] %}

  {# Add conditional middle option if implant only in one breast #}
  {% if hasOneSideImplant %}
    {% set radioItems = radioItems | push({
      value: "no-continue-" + unaffectedBreast,
      text: "No, but " + unaffectedBreast + " breast (no implant) can be scanned"
    }) %}
  {% endif %}

  {# Add final option #}
  {% set radioItems = radioItems | push({
    value: "no",
    text: "No, end appointment"
  }) %}

  {{ radios({
    name: "event[medicalInformation][implantedDevices][consentGiven]",
    value: event.medicalInformation.implantedDevices.consentGiven,
    fieldset: {
      legend: {
        text: "Have they signed the consent form?",
        classes: "nhsuk-fieldset__legend--m",
        isPageHeading: false
      }
    },
    items: radioItems
  }) }}

  {{ button({
    text: "Continue"
  }) }}

  {% include "screening-cannot-proceed-link.njk" %}

{% endblock %}