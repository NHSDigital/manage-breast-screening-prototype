{% extends 'layout-app.html' %}

{% set pageHeading = "Record breast features" %}
{% set gridColumn = "nhsuk-grid-column-two-thirds" %}
{% set formAction = "./../record-medical-information" | getReturnUrl(referrerChain) %}

{% block pageContent %}

  {{ participant | log }}

  {% set unit = data.breastScreeningUnits | findById(clinic.breastScreeningUnitId) %}

  <h1 class="nhsuk-heading-l">
    <span class="nhsuk-caption-m">
      {{ participant | getFullName }}
    </span>
    {{ pageHeading }}
  </h1>

  <div id="status-message" aria-live="polite" class="nhsuk-u-visually-hidden" role="status"></div>

  <h2 class="nhsuk-heading-m">Add a feature</h2>

  <p class="nhsuk-body">Add any non-symptomatic features like scars, moles, or warts observed or reported during the appointment.</p> 

  <p class="nhsuk-body">These features will be used by the radiologists to help inform mammograms.</p>

  <div class="breast-features-diagram-header">
      <h2 class="nhsuk-heading-m">Where is the feature?</h2>
      <p class="nhsuk-body">Click on the diagram to add a point</p>
  </div>
  
  <div class="breast-features-diagram-container">

      <div class="breast-features-diagram-side-labels">
          <span>Right</span>
          <span>Left</span>
      </div>
      
      <div class="breast-features-diagram-diagram-container" id="diagramContainer">
          <svg class="breast-features-diagram-diagram-svg" viewBox="0 0 793 320" xmlns="http://www.w3.org/2000/svg" id="breastSvg">
              <!-- Right breast outline -->
              <path d="M2 140.1532L57.7845 57.00006C99.1338 64.53851 120.917 75.6557 120.917 140.1532C120.917 204.651 164.733 250.315 165.259 251.008C176.138 263.554 227.136 303.614 297.277 280.234C367.418 256.853 384.953 177.105 384.953 140.1532" stroke="black" stroke-width="3" fill="none"/>
              
              <!-- Right nipple -->
              <circle cx="251.386" cy="159.079" r="20.671" stroke="black" stroke-width="3" fill="none"/>
              
              <!-- Left breast outline -->
              <path d="M791.598 140.6593L735.813 57.50616C694.464 65.0446 672.681 76.1619 672.681 140.6593C672.681 205.157 628.865 250.821 628.339 251.514C617.459 264.06 566.461 304.12 496.32 280.74C426.179 257.359 408.644 177.611 408.644 140.6593" stroke="black" stroke-width="3" fill="none"/>
              
              <!-- Left nipple -->
              <circle cx="542.212" cy="159.585" r="20.671" stroke="black" stroke-width="3" fill="none"/>
              
              <!-- Markers will be added here dynamically -->
          </svg>
          
          <!-- Popover (initially hidden) -->
          <div class="breast-features-diagram-popover" id="featurePopover">
            <span class="nhsuk-caption-m" id="popoverCaption">Add new feature</span>
            <h2 id="popoverHeading">What is the feature?</h2>
              
            {{ radios({
              idPrefix: "feature",
              name: "feature",
              fieldset: {
                legend: {
                  text: "Feature type",
                  classes: "nhsuk-fieldset__legend--s",
                  isPageHeading: false
                }
              },
              items: [
                {
                  value: "scar",
                  text: "Scar"
                },
                {
                  value: "breast-reduction-scar",
                  text: "Breast reduction scar"
                },
                {
                  value: "mole", 
                  text: "Mole"
                },
                {
                  value: "wart",
                  text: "Wart"
                },
                {
                  value: "other",
                  text: "Other",
                  conditional: {
                    html: input({
                      id: "customLabel",
                      name: "customLabel",
                      label: {
                        text: "Enter a custom label"
                      }
                    })
                  }
                }
              ]
            }) }}

            <div class="nhsuk-button-group">
              {{ button({
                text: "Add",
                id: "addBtn",
                attributes: {
                  type: "button",
                  "data-action": "add"
                }
              }) }}
              
              {{ button({
              text: "Cancel",
              classes: "nhsuk-button--secondary",
              attributes: {
               type: "button",
               "data-action": "cancel"  
               }
              }) }}
              
             {{ button({
               text: "Remove",
              classes: "nhsuk-button--warning",
              attributes: {
               type: "button",
               "data-action": "remove"  
               }
              }) }}
            </div>
          </div>
      </div>

  </div>

  <!-- Features list -->
<div id="featuresListContainer" style="display: none;" class="nhsuk-u-margin-top-4">
      <h3 class="nhsuk-heading-s">Key</h3>
      <div class="features-list" id="featuresList"></div>
  </div>

  <div class="nhsuk-u-margin-top-6">
      {{ button({
        text: "Save features and continue",
        id: "saveBtn",
        attributes: {
          type: "button"
        }
      }) }}
      
      <div id="statusMessage" class="nhsuk-u-margin-top-3" style="display: none;"></div>
  </div>

  {% include "screening-cannot-proceed-link.njk" %}

  <script>
  function initializeBreastFeatures() {
    let diagramContainer
    let svg
    let popover
    let addBtn, cancelBtn, removeBtn, saveBtn
    let featuresListContainer
    let featuresList
    let statusMessage
    let editingFeature = null
    let currentMarker = null
    let markerCounter = 1
    let allFeatures = []
    let diagramOffset = { x: 0, y: 0 }
    let conditionalDiv
    let customInput

    // Prevent multiple initializations in NHS Prototype Kit environment
    if (window.breastFeaturesInitialized) {
        console.warn('Breast features already initialized. Skipping.')
        return
    }
    window.breastFeaturesInitialized = true

    // Get DOM elements
    diagramContainer = document.querySelector('.breast-features-diagram-diagram-container')
    svg = document.querySelector('.breast-features-diagram-diagram-svg')
    popover = document.querySelector('.breast-features-diagram-popover')
    console.log('DEBUG initializeBreastFeatures: diagramContainer:', diagramContainer)
    console.log('DEBUG initializeBreastFeatures: svg:', svg)
    addBtn = popover ? popover.querySelector('.nhsuk-button[data-action="add"]') : null
    cancelBtn = popover ? popover.querySelector('.nhsuk-button[data-action="cancel"]') : null
    removeBtn = popover ? popover.querySelector('.nhsuk-button[data-action="remove"]') : null
    saveBtn = document.querySelector('#saveBtn')
    featuresListContainer = document.querySelector('#featuresListContainer')
    featuresList = document.querySelector('#featuresList')
    statusMessage = document.querySelector('#status-message')
    conditionalDiv = document.querySelector('.js-conditional-reveal__container')
    customInput = document.querySelector('.js-conditional-reveal__container #other-feature-text')

    console.log('DEBUG: popover element found:', popover)
    console.log('DEBUG: addBtn element found:', addBtn)
    console.log('DEBUG: removeBtn element found:', removeBtn)
    console.log('DEBUG: cancelBtn element found:', cancelBtn)

    if (!svg || !popover || !diagramContainer) {
        console.error('One or more required elements not found:', { svg, popover, diagramContainer })
        return
    }

    // Event listener for clicking on the SVG diagram
    svg.addEventListener('click', function(e) {
        console.log('SVG clicked')
        handleDiagramClick(e)
    })

    // Popover action button listeners
    if (addBtn) addBtn.addEventListener('click', addFeature)
    if (cancelBtn) cancelBtn.addEventListener('click', closePopover)
    if (removeBtn) removeBtn.addEventListener('click', removeFeature)
    if (saveBtn) saveBtn.addEventListener('click', saveAllFeatures)

    // Setup conditional reveals for radio buttons
    setupConditionalReveals()

    // Close popover if click outside
    document.addEventListener('click', function(e) {
        if (popover && popover.style.display === 'block' &&
            !popover.contains(e.target) && !svg.contains(e.target) &&
            (!currentMarker || !currentMarker.element.contains(e.target))) {
            closePopover()
        }
    })

    // --- Core Functions ---

    function handleDiagramClick(e) {
        const svgRect = svg.getBoundingClientRect()
        const containerRect = diagramContainer.getBoundingClientRect()

        const clickX = e.clientX
        const clickY = e.clientY

        const svgClickX = clickX - svgRect.left
        const svgClickY = clickY - svgRect.top

        const svgViewBoxX = svgRect.width > 0 ? (svgClickX / svgRect.width) * 793 : 0
        const svgViewBoxY = svgRect.height > 0 ? (svgClickY / svgRect.height) * 320 : 0

        const containerX = clickX - containerRect.left
        const containerY = clickY - containerRect.top

        console.log('Container click coords:', { containerX, containerY })
        console.log('SVG click coords:', { svgClickX, svgClickY })
        console.log('SVG viewBox coords:', { svgViewBoxX, svgViewBoxY })

        if (currentMarker && currentMarker.element) {
            console.log('Editing in progress, not creating new marker.')
            return
        }

        if (svgClickX < 0 || svgClickX > svgRect.width || svgClickY < 0 || svgClickY > svgRect.height) {
            console.warn('Click outside SVG element bounds. Ignoring.')
            return
        }

        createTemporaryMarker(containerX, containerY)
        showPopover(clickX, clickY)

        currentMarker.x = svgViewBoxX
        currentMarker.y = svgViewBoxY

        editingFeature = null
    }

    function createTemporaryMarker(containerX, containerY) {
        if (currentMarker && currentMarker.element) {
            currentMarker.element.remove()
        }

        const marker = document.createElement('div')
        marker.className = 'breast-features-diagram-marker'
        marker.innerText = '?'
        marker.style.left = (containerX - 20) + 'px'
        marker.style.top = (containerY - 20) + 'px'
        marker.style.zIndex = '102'

        diagramContainer.appendChild(marker)
        currentMarker = { element: marker }
        console.log('Temporary marker created at:', marker.style.left, marker.style.top)
    }

    function showPopover(clickX, clickY) {
        if (!popover) return

        popover.style.display = 'block'
        resetPopoverForm()

        const popoverRect = popover.getBoundingClientRect()
        let popoverLeft = clickX + 20
        let popoverTop = clickY - popoverRect.height / 2

        if (popoverLeft + popoverRect.width > window.innerWidth) {
            popoverLeft = window.innerWidth - popoverRect.width - 10
        }
        if (popoverTop < 0) {
            popoverTop = 10
        }
        if (popoverTop + popoverRect.height > window.innerHeight) {
            popoverTop = window.innerHeight - popoverRect.height - 10
        }
        if (popoverLeft < 0) {
            popoverLeft = 10
        }

        popover.style.left = popoverLeft + 'px'
        popover.style.top = popoverTop + 'px'
        popover.focus()
    }

    function resetPopoverForm() {
        if (!popover) return
        
        const popoverCaption = popover.querySelector('#popoverCaption')
        const popoverHeading = popover.querySelector('#popoverHeading')
        
        if (popoverCaption) {
            popoverCaption.innerText = 'Add new feature'
        }
        if (popoverHeading) {
            popoverHeading.innerText = 'What is the feature?'
        }
        
        addBtn.innerText = 'Add'
        removeBtn.style.display = 'none'

        const radios = popover.querySelectorAll('input[name="feature"]')
        radios.forEach(radio => radio.checked = false)

        const customInput = document.querySelector('#customLabel')
        if (customInput) {
            customInput.value = ''
        }
        
        const conditionalDiv = document.querySelector('.nhsuk-radios__conditional')
        if (conditionalDiv) {
            conditionalDiv.classList.remove('nhsuk-radios__conditional--revealed')
        }
    }

    function setupConditionalReveals() {
        const otherRadio = document.getElementById('feature-other')
        const allRadios = document.querySelectorAll('input[name="feature"]')
        const conditionalDiv = document.querySelector('.nhsuk-radios__conditional')
        const customInput = document.querySelector('#customLabel')

        if (otherRadio && conditionalDiv) {
            otherRadio.addEventListener('change', function() {
                if (this.checked) {
                    conditionalDiv.classList.add('nhsuk-radios__conditional--revealed')
                }
            })
        }

        allRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (conditionalDiv && this.value !== 'other') {
                    conditionalDiv.classList.remove('nhsuk-radios__conditional--revealed')
                    if (customInput) {
                        customInput.value = ''
                    }
                }
            })
        })
    }

    function createPermanentMarker(x, y, text, number, featureId) {
        console.log('=== createPermanentMarker START ===')
        console.log('Received parameters:', {x, y, text, number, featureId})
        console.log('featureId type:', typeof featureId, 'value:', featureId)
        console.log('featureId === undefined:', featureId === undefined)
        
        const marker = document.createElement('div')
        marker.className = 'breast-features-diagram-marker'
        marker.innerText = number
        marker.setAttribute('data-id', number)
        marker.setAttribute('data-x', x)
        marker.setAttribute('data-y', y)
        
        console.log('About to set data-feature-id to:', featureId)
        marker.setAttribute('data-feature-id', featureId)
        console.log('data-feature-id actually set to:', marker.getAttribute('data-feature-id'))

        positionMarkerContainer(marker, x, y)

        diagramContainer.appendChild(marker)
        setupMarkerInteraction(marker)
        
        console.log('=== createPermanentMarker END ===')
        return marker
    }

    function positionMarkerContainer(container, svgX, svgY) {
        console.log('--- positionMarkerContainer function called ---')
        const containerRect = diagramContainer.getBoundingClientRect()
        const svgRect = svg.getBoundingClientRect()
        
        console.log('--- positionMarkerContainer debug ---')
        console.log('Input container element:', container)
        console.log('Input svgX:', svgX, 'svgY:', svgY)
        console.log('diagramContainer clientRect:', containerRect.width, 'x', containerRect.height, 'left:', containerRect.left, 'top:', containerRect.top)
        console.log('svgRect (rendered) dimensions:', svgRect.width, 'x', svgRect.height, 'left:', svgRect.left, 'top:', svgRect.top)
        console.log('svgRect offset from container (calculated):', 'left:', svgRect.left - containerRect.left, 'top:', svgRect.top - containerRect.top)

        const svgOffsetX = svgRect.left - containerRect.left
        const svgOffsetY = svgRect.top - containerRect.top
        
        const pixelX = (svgX / 793) * svgRect.width
        const pixelY = (svgY / 320) * svgRect.height
        
        console.log('Converted pixelX (within SVG):', pixelX, 'pixelY (within SVG):', pixelY)

        const markerSizeOffset = 20
        container.style.left = (svgOffsetX + pixelX - markerSizeOffset) + 'px'
        container.style.top = (svgOffsetY + pixelY - markerSizeOffset) + 'px'
        container.style.position = 'absolute'

        console.log('Final marker CSS left:', container.style.left, 'top:', container.style.top)
        console.log('------------------------------------')
    }

    function setupMarkerInteraction(containerElement) {
        let isDragging = false
        let dragStartX, dragStartY
        let elementStartX, elementStartY
        let dragThreshold = 5
        
        console.log('Setting up interaction for marker:', containerElement)
        
        containerElement.addEventListener('mousedown', function(e) {
            console.log('Marker mousedown triggered')
            e.preventDefault()
            e.stopPropagation()
            
            isDragging = false
            dragStartX = e.clientX
            dragStartY = e.clientY
            elementStartX = parseInt(containerElement.style.left) || 0
            elementStartY = parseInt(containerElement.style.top) || 0
            
            document.addEventListener('mousemove', handleMouseMove)
            document.addEventListener('mouseup', handleMouseUp)

            containerElement.classList.add('dragging')
        })
        
        // Also add a click event as a backup
        containerElement.addEventListener('click', function(e) {
            console.log('Marker click triggered (backup handler)')
            e.preventDefault()
            e.stopPropagation()
            
            const featureId = parseInt(containerElement.getAttribute('data-feature-id'))
            console.log('Looking for feature with ID:', featureId)
            const feature = allFeatures.find(f => f.id === featureId)
            console.log('Found feature:', feature)
            if (feature) {
                editFeature(feature, e.clientX, e.clientY)
            }
        })
        
        function handleMouseMove(e) {
            const currentX = e.clientX
            const currentY = e.clientY
            
            const dx = Math.abs(currentX - dragStartX)
            const dy = Math.abs(currentY - dragStartY)

            if (!isDragging && (dx > dragThreshold || dy > dragThreshold)) {
                isDragging = true
                console.log('Started dragging')
            }
            
            if (isDragging) {
                const newLeft = elementStartX + (currentX - dragStartX)
                const newTop = elementStartY + (currentY - dragStartY)
                containerElement.style.left = newLeft + 'px'
                containerElement.style.top = newTop + 'px'
            }
        }
        
        function handleMouseUp(e) {
            console.log('Marker mouseup triggered, isDragging:', isDragging)
            document.removeEventListener('mousemove', handleMouseMove)
            document.removeEventListener('mouseup', handleMouseUp)
            containerElement.classList.remove('dragging')

            if (isDragging) {
                console.log('Was dragging, updating position')
                updateFeaturePosition(containerElement)
            } else {
                console.log('Was clicking, opening edit dialog')
                const featureId = parseInt(containerElement.getAttribute('data-feature-id'))
                console.log('Looking for feature with ID:', featureId)
                const feature = allFeatures.find(f => f.id === featureId)
                console.log('Found feature:', feature)
                if (feature) {
                    editFeature(feature, e.clientX, e.clientY)
                }
            }
            isDragging = false
        }
    }

    function updateFeaturePosition(containerElement) {
        const containerRect = diagramContainer.getBoundingClientRect()
        const svgRect = svg.getBoundingClientRect()

        const currentMarkerLeft = parseFloat(containerElement.style.left) + 20
        const currentMarkerTop = parseFloat(containerElement.style.top) + 20

        const relativeToSvgX = currentMarkerLeft - (svgRect.left - containerRect.left)
        const relativeToSvgY = currentMarkerTop - (svgRect.top - containerRect.top)

        const newSvgX = (relativeToSvgX / svgRect.width) * 793
        const newSvgY = (relativeToSvgY / svgRect.height) * 320

        const featureId = parseInt(containerElement.getAttribute('data-feature-id'))
        const feature = allFeatures.find(f => f.id === featureId)

        if (feature) {
            feature.x = newSvgX
            feature.y = newSvgY
            updateFeaturesList()
            console.log(`Feature ${feature.number} position updated to SVG (${newSvgX.toFixed(2)}, ${newSvgY.toFixed(2)})`)
        }
    }

    function editFeature(feature, clickX, clickY) {
        console.log('--- editFeature called for feature:', feature)
        editingFeature = feature
        currentMarker = { element: document.querySelector(`.breast-features-diagram-marker[data-feature-id="${feature.id}"]`) }

        if (!popover) {
            console.error('Popover not found in editFeature')
            return
        }
        
        // Show popover first
        showPopover(clickX, clickY)
        
        // Then update its content
        const popoverCaption = popover.querySelector('#popoverCaption')
        const popoverHeading = popover.querySelector('#popoverHeading')
        
        if (popoverCaption) {
            popoverCaption.innerText = `Editing feature ${feature.number}`
        }
        if (popoverHeading) {
            popoverHeading.innerText = 'What is the feature?'
        }
        
        if (addBtn) addBtn.innerText = 'Save changes'
        if (removeBtn) removeBtn.style.display = 'inline-block'

        // Clear all radios first
        const radios = popover.querySelectorAll('input[name="feature"]')
        radios.forEach(radio => radio.checked = false)
        
        let featureFound = false
        const featureTextLower = feature.text.toLowerCase()
        
        console.log('Looking for feature text:', feature.text, 'lowercase:', featureTextLower)

        // Check standard feature types first - including the new breast reduction scar
        radios.forEach(radio => {
            if (radio.value === featureTextLower || 
                (radio.value === 'breast-reduction-scar' && featureTextLower === 'breast reduction scar')) {
                radio.checked = true
                featureFound = true
                console.log('Found matching radio for:', radio.value)
            }
        })

        // Handle "Other" cases
        if (feature.text && feature.text.startsWith('Other: ')) {
            const otherRadio = document.getElementById('feature-other')
            const customInput = document.querySelector('#customLabel')
            const conditionalDiv = document.querySelector('.nhsuk-radios__conditional')
            
            console.log('Handling Other case, otherRadio found:', !!otherRadio)
            
            if (otherRadio) {
                otherRadio.checked = true
                featureFound = true
                
                if (conditionalDiv) {
                    conditionalDiv.classList.add('nhsuk-radios__conditional--revealed')
                }
                if (customInput) {
                    customInput.value = feature.text.replace('Other: ', '')
                }
            }
        }

        // If no standard match found and not an "Other:" prefixed text, treat as custom "other"
        if (!featureFound && !['scar', 'breast reduction scar', 'mole', 'wart'].includes(featureTextLower)) {
            const otherRadio = document.getElementById('feature-other')
            const customInput = document.querySelector('#customLabel')
            const conditionalDiv = document.querySelector('.nhsuk-radios__conditional')
            
            console.log('No match found, defaulting to Other. otherRadio found:', !!otherRadio)
            
            if (otherRadio) {
                otherRadio.checked = true
                if (conditionalDiv) {
                    conditionalDiv.classList.add('nhsuk-radios__conditional--revealed')
                }
                if (customInput) {
                    customInput.value = feature.text
                }
            }
        }

        console.log('EditFeature setup complete')
    }

    function addFeature() {
        console.log('--- addFeature function called ---')
        console.log('DEBUG: currentMarker at start of addFeature:', currentMarker)

        const selectedFeatureRadio = popover.querySelector('input[name="feature"]:checked')
        let selectedFeature = null
        let featureText = ''

        if (!selectedFeatureRadio) {
            showStatusMessage('Please select a feature type.', 'error')
            return
        }

        console.log('DEBUG: selectedFeatureRadio value:', selectedFeatureRadio.value)
        
        selectedFeature = { value: selectedFeatureRadio.value, text: selectedFeatureRadio.value }

        if (selectedFeature.value === 'other') {
            const customLabel = document.querySelector('#customLabel') ? document.querySelector('#customLabel').value.trim() : ''
            console.log('DEBUG: customLabel value:', customLabel)
            if (!customLabel) {
                showStatusMessage('Please enter text for "Other" feature.', 'error')
                return
            }
            featureText = `Other: ${customLabel}`
        } else if (selectedFeature.value === 'breast-reduction-scar') {
            featureText = 'Breast reduction scar'
        } else {
            featureText = selectedFeature.value.charAt(0).toUpperCase() + selectedFeature.value.slice(1)
        }

        if (editingFeature) {
            editingFeature.text = featureText
            updateFeaturesList()
            showStatusMessage(`Feature ${editingFeature.number} updated.`, 'success')
            editingFeature = null
        } else if (currentMarker) {
            console.log('DEBUG: Entering currentMarker branch in addFeature. currentMarker is:', currentMarker)
            
            if (currentMarker.element) {
                currentMarker.element.remove()
            }
            
            const newFeatureNumber = markerCounter++
            const newFeature = {
                id: allFeatures.length > 0 ? Math.max(...allFeatures.map(f => f.id)) + 1 : 1,
                number: newFeatureNumber,
                text: featureText,
                x: currentMarker.x,
                y: currentMarker.y
            }
            
            allFeatures.push(newFeature)

            // Pass the newFeature.id as the featureId parameter
            const markerElement = createPermanentMarker(newFeature.x, newFeature.y, newFeature.text, newFeature.number, newFeature.id)
            console.log('DEBUG: markerElement returned by createPermanentMarker:', markerElement)
            newFeature.element = markerElement

            updateFeaturesList()
            showStatusMessage(`Feature ${newFeature.number} added.`, 'success')
            
            currentMarker = null
        } else {
            console.log('DEBUG: No currentMarker found to add/edit. Showing error message.')
            showStatusMessage('Error: No marker to add/edit.', 'error')
        }

        closePopover()
    }

    function removeFeature() {
        if (!editingFeature) return

        allFeatures = allFeatures.filter(f => f.id !== editingFeature.id)
        if (editingFeature.element) {
            editingFeature.element.remove()
        }
        updateFeaturesList()
        showStatusMessage(`Feature ${editingFeature.number} removed.`, 'success')
        closePopover()
        editingFeature = null
    }

    function closePopover() {
        if (popover) {
            popover.style.display = 'none'
        }
        
        if (currentMarker && currentMarker.element) {
            const isTemporary = !allFeatures.some(f => f.element === currentMarker.element)
            if (isTemporary) {
                console.log('Removing temporary marker')
                currentMarker.element.remove()
            }
        }
        
        currentMarker = null
        editingFeature = null
    }

    function updateFeaturesList() {
        if (!featuresListContainer || !featuresList) {
            console.warn('Features list container or list element not found.')
            return
        }

        if (allFeatures.length === 0) {
            featuresListContainer.style.display = 'none'
            return
        }

        featuresListContainer.style.display = 'block'
        featuresList.innerHTML = ''

        allFeatures.sort((a, b) => a.number - b.number)

        const ul = document.createElement('ul')
        ul.className = 'nhsuk-list features-list-items'

        allFeatures.forEach(feature => {
            const listItem = document.createElement('li')
            listItem.className = 'feature-item'
            listItem.style.cursor = 'pointer'
            listItem.setAttribute('data-feature-id', feature.id)
            listItem.innerHTML = `
                <div class="feature-left">
                    <div class="feature-number">${feature.number}</div>
                    <div class="feature-label">${feature.text}</div>
                </div>
                <div class="feature-position">(${feature.x.toFixed(0)}, ${feature.y.toFixed(0)})</div>
            `
            
            listItem.addEventListener('click', function() {
                const featureId = parseInt(this.getAttribute('data-feature-id'))
                const feature = allFeatures.find(f => f.id === featureId)
                if (feature && feature.element) {
                    const markerRect = feature.element.getBoundingClientRect()
                    const centerX = markerRect.left + markerRect.width / 2
                    const centerY = markerRect.top + markerRect.height / 2
                    editFeature(feature, centerX, centerY)
                }
            })
            
            ul.appendChild(listItem)

            if (feature.element) {
                feature.element.innerText = feature.number
            }
        })
        
        featuresList.appendChild(ul)
    }

    function saveAllFeatures() {
        if (allFeatures.length === 0) {
            showStatusMessage('No features to save.', 'error')
            return
        }

        try {
            if (typeof sessionStorage !== 'undefined') {
                sessionStorage.setItem('breastFeatures', JSON.stringify({ features: allFeatures.map(f => ({
                    id: f.id,
                    number: f.number,
                    text: f.text,
                    x: f.x,
                    y: f.y
                })) }))
            }
            showStatusMessage('Features saved successfully!', 'success')
            setTimeout(() => {
                if (confirm('Features saved successfully! Would you like to continue to the next step?')) {
                    const returnUrl = "{{ formAction }}"
                    if (returnUrl) {
                        window.location.href = returnUrl
                    } else {
                        console.warn('No return URL defined for formAction.')
                    }
                }
            }, 1000)
        } catch (error) {
            console.error('Error saving features:', error)
            showStatusMessage('Error saving features.', 'error')
        }
    }

    function showStatusMessage(message, type) {
        if (!statusMessage) {
            console.warn('Status message element not found.')
            return
        }
        statusMessage.innerText = message
        statusMessage.classList.remove('nhsuk-u-visually-hidden', 'status-success', 'status-error')
        if (type === 'success') {
            statusMessage.classList.add('status-success')
        } else if (type === 'error') {
            statusMessage.classList.add('status-error')
        }
        statusMessage.focus()
        setTimeout(() => {
            statusMessage.classList.add('nhsuk-u-visually-hidden')
        }, 5000)
    }

    function loadSavedFeatures() {
        try {
            const savedData = sessionStorage.getItem('breastFeatures')
            if (savedData) {
                const data = JSON.parse(savedData)
                if (data.features && Array.isArray(data.features)) {
                    allFeatures = data.features.filter(f => f.x !== undefined && f.y !== undefined)

                    allFeatures.forEach(savedFeature => {
                        // Pass the savedFeature.id as the featureId parameter
                        const markerElement = createPermanentMarker(savedFeature.x, savedFeature.y, savedFeature.text, savedFeature.number, savedFeature.id)
                        savedFeature.element = markerElement
                        if (savedFeature.id >= markerCounter) {
                            markerCounter = savedFeature.id + 1
                        }
                    })
                    if (allFeatures.length > 0) {
                        updateFeaturesList()
                    }
                }
            }
        } catch (error) {
            console.warn('Could not load saved features:', error)
        }
    }

    // Initialize: Load any saved features
    loadSavedFeatures()

    // Handle window resize to reposition markers
    window.addEventListener('resize', function() {
        allFeatures.forEach(feature => {
            positionMarkerContainer(feature.element, feature.x, feature.y)
        })
    })

    // Prevent form submission on Enter key in popover
    if (popover) {
        popover.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault()
                addFeature()
            }
        })
    }

    // Keyboard accessibility
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && popover && popover.style.display === 'block') {
            closePopover()
        }
    })

} // End of initializeBreastFeatures

// Try multiple initialization methods for NHS Prototype Kit compatibility
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeBreastFeatures)
} else {
    initializeBreastFeatures()
}

// Also try after window load in case NHS scripts interfere
window.addEventListener('load', function() {
    if (!window.breastFeaturesInitialized) {
        console.log('Attempting initialization after window load...')
        initializeBreastFeatures()
    }
})
</script>

{% endblock %}