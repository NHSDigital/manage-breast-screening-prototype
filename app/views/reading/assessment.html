{# /app/views/events/reading/assessment.html #}

{% extends 'layout-reading.html' %}

{% set existingResult = event.reads[0].result %}

{% set pageHeading = "Your assessment for " + participant | getFullName %}
{% if existingResult %}
  {% set pageHeading = "Update assessment for " + participant | getFullName %}
{% endif %}

{% set gridColumn = "nhsuk-grid-column-full" %}

{% set mainClasses = "nhsuk-u-padding-top-3" %}
{% set tabActive = "assessment" %}
{# {% set formAction = event.id + '/result-update' %} #}

{% block pageContent %}

  {{ participant | log("Participant") }}
  {{ event | log("Event") }}
  {# {{ data.readingSession | log("Reading session")}}
  {{ progress | log("Progress")}} #}


  {# {% include "./_includes/reading-header.njk" %} #}

  {# <span class="nhsuk-caption-l">
    {{ participant | getFullName }}
  </span> #}
  <h1 class="nhsuk-heading-l js-image-count">
    {{ pageHeading }}
  </h1>
  {% set imageCount = event.mammogramData.metadata.totalImages %}
  {% set standardViews = event.mammogramData.views | length %}

  {% set thingsToReview = [] %}

  {% set hasSymptoms = event.currentSymptoms | length %}
  {% if hasSymptoms %}
    {% set thingsToReview = thingsToReview | push('Symptoms') %}
  {% endif %}

  {% set hasAdditionalImages = imageCount > standardViews %}
  {% if hasAdditionalImages %}
    {% set thingsToReview = thingsToReview | push('Images') %}
  {% endif %}



  {% set itemsToReviewHtml %}

    {% if hasSymptoms %}
      {% if thingsToReview | length > 1 %}
        <h2>Symptoms</h2>
      {% endif %}

      {% set symptoms = event.currentSymptoms %}
      {% include "summary-lists/symptoms.njk" %}
      <p><a href="./medical-information">View details</a></p>
      {{ checkboxes({
      idPrefix: "acknowledgeSymptoms",
        name: "acknowledgeSymptoms",
        items: [
          {
            value: "email",
            text: "Acknowledge these symptoms"
          }
        ]
      }) }}
    {% endif %}

    {% if hasAdditionalImages %}
      {% if thingsToReview | length > 1 %}
        <h2>Images</h2>
      {% endif %}
      <ul class="nhsuk-list">
        {% for viewKey, viewData in event.mammogramData.views %}
          {% if viewData.images.length > 1 %}
            <li>
              {% if viewData.isRepeat %}
                {{ viewData.viewShortWithSide }} view was repeated because: {{ viewData.repeatReason }}
              {% else %}
                {{ viewData.viewShortWithSide }} view required additional images to capture the full breast
              {% endif %}
            </li>
          {% endif %}
        {% endfor %}
      </ul>
      {# <p><a href="#">View details</a></p> #}
    {% endif %}

  {% endset %}

  {% if thingsToReview | length %}
    {% set calloutHeading %}
      {% if thingsToReview | length > 1 %}
        Items to review
      {% else %}
        {{ thingsToReview[0]}}
      {% endif %}
    {% endset %}
    {{ warningCallout({
      heading: calloutHeading,
      HTML: itemsToReviewHtml
    }) }}
  {% endif %}

  {% set questionText = "What is your assessment?" %}



  {% if existingResult %}
    <form action="./result-update" method="post">
      {{ radios({
        idPrefix: "example",
        name: "newResult",
        fieldset: {
          legend: {
            text: questionText,
            classes: "nhsuk-fieldset__legend--m",
            isPageHeading: false
          }
        },
        items: [
          {
            value: "normal",
            text: "Normal",
            checked: existingResult == "normal"
          },
          {
            value: "recall",
            text: "Technical recall",
            checked: existingResult == "recall"
          },
          {
            value: "abnormal",
            text: "Recall for assessment",
            checked: existingResult == "abnormal"
          }
        ]
      }) }}

      {{ button({
        text: "Update assessment"
      }) }}
    </form>
  {% else %}
    <h2>{{ questionText }}</h2>

    <div class="form-group">
      {% if data.confirmNormalResults == "true" %}
        {{ button({
          text: "Normal",
          href: "./confirm-normal"
        }) }}
      {% else %}
        <form action="./result-normal" method="post">
          {{ button({
            text: "Normal"
          }) }}
        </form>
      {% endif %}

    </div>
    <div class="form-group">
      {{ button({
        text: "Technical recall",
        classes: "nhsuk-button--secondary",
        href: "./recall-reason"
      }) }}
    </div>
    <div class="form-group">
      {{ button({
        "text": "Recall for assessment",
        "classes": "nhsuk-button--warning",
        href: "./awaiting-annotations"
      }) }}
    </div>
  {% endif %}

  {# <p><a href="#">Skip to next participant</a></p> #}

  {% if progress.hasNextUnread %}
    <p>
      <a href="/clinics/{{clinicId}}/reading/{{progress.nextUnreadId}}/assessment?skipped={{eventId}}" class="">Skip to next participant
      </a>
    </p>
  {% endif %}

  {% if progress.hasPrevious %}
    <p>
      <a href="/clinics/{{clinicId}}/reading/{{progress.previousEventId}}/assessment" class="">Previous participant
      </a>
    </p>

  {% endif %}

{% endblock %}


