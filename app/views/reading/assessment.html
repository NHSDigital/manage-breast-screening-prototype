{# /app/views/events/reading/assessment.html #}

{% extends 'layout-reading.html' %}

{% set existingResult = event.reads[0].result %}

{% set pageHeading = "Your assessment for " + participant | getFullName %}
{% if existingResult %}
  {% set pageHeading = "Update assessment for " + participant | getFullName %}
{% endif %}

{% set gridColumn = "nhsuk-grid-column-two-thirds" %}

{% set mainClasses = "nhsuk-u-padding-top-3" %}
{% set tabActive = "assessment" %}

{% set formAction = './assessment-answer' %}

{% block pageContent %}

  {{ participant | log("Participant") }}
  {{ event | log("Event") }}

  <h1 class="nhsuk-heading-l js-image-count">
    {{ pageHeading }}
  </h1>

  {% set hasSymptoms = event.currentSymptoms | length %}
  {% if hasSymptoms %}
    {% set calloutHeading %}
      Symptoms
    {% endset %}
    {% set symptomsCardHtml %}
      {% set symptoms = event.currentSymptoms %}
      {% include "summary-lists/symptoms.njk" %}
      {{ checkboxes({
        idPrefix: "acknowledgeSymptoms",
        name: "acknowledgeSymptoms",
        items: [
          {
            value: "true",
            text: "Acknowledge these symptoms",
            checked: true if data.acknowledgeSymptoms == "true" else false
          }
        ]
      } | populateErrors) }}
    {% endset %}

    {{ warningCallout({
      heading: calloutHeading | trim,
      HTML: symptomsCardHtml
    }) }}
  {% endif %}

  {% set imageCount = event.mammogramData.metadata.totalImages %}
  {% set hasAdditionalImages = imageCount > 4 %}

  {% if hasAdditionalImages %}
    {% set additionalImagesHtml %}
      <h3>Repeated views</h3>
      <ul class="nhsuk-list">
        {% for viewKey, viewData in event.mammogramData.views %}
          {% if viewData.images.length > 1 %}
            <li>
              {% if viewData.isRepeat %}
                {{ viewData.viewShortWithSide }} view was repeated because: {{ viewData.repeatReason }}
              {% else %}
                {{ viewData.viewShortWithSide }} view required additional images to capture the full breast
              {% endif %}
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    {% endset %}
    {{ insetText({
      html: additionalImagesHtml
    }) }}
  {% endif %}

  {% set isPartialMammography = event.mammogramData.isPartialMammography %}

  {% if isPartialMammography %}
    {% set partialMammographyHtml %}
      <h3>Partial mammography</h3>
      <p>
        Partial mamography reason: Patient was uncomfortable and asked to stop
      </p>
    {% endset %}
    {{ insetText({
      html: partialMammographyHtml
    }) }}
  {% endif %}

  {% set questionText = "What is your assessment?" %}

  {# Temporary ui to support changing an answer #}
  {% if existingResult %}
      {# Show radios when updating an existing result #}
      {{ radios({
        idPrefix: "result",
        name: "result",
        fieldset: {
          legend: {
            text: questionText,
            classes: "nhsuk-fieldset__legend--m",
            isPageHeading: false
          }
        },
        items: [
          {
            value: "normal",
            text: "Normal",
            checked: existingResult == "normal"
          },
          {
            value: "recall",
            text: "Technical recall",
            checked: existingResult == "recall"
          },
          {
            value: "abnormal",
            text: "Recall for assessment",
            checked: existingResult == "abnormal"
          }
        ],
        value: data.result or existingResult
      }) }}

      {{ button({
        text: "Update assessment"
      }) }}
  {% else %}

    {# Show buttons for initial assessment #}
    <h2>{{ questionText }}</h2>

    <div class="form-group">
      {{ button({
        text: "Normal",
        value: "normal",
        name: "result"
      }) }}
    </div>
    <div class="form-group">
      {{ button({
        text: "Technical recall",
        classes: "nhsuk-button--secondary",
        value: "recall",
        name: "result"
      }) }}
    </div>
    <div class="form-group">
      {{ button({
        "text": "Recall for assessment",
        "classes": "nhsuk-button--warning",
        "value": "abnormal",
        name: "result"
      }) }}
    </div>
  {% endif %}

  {# <p><a href="#">Skip to next participant</a></p> #}

  {% if progress.hasNextUnread %}
    <p>
      <a href="/clinics/{{clinicId}}/reading/{{progress.nextUnreadId}}/assessment?skipped={{eventId}}" class="">Skip to next participant
      </a>
    </p>
  {% endif %}

  {% if progress.hasPrevious %}
    <p>
      <a href="/clinics/{{clinicId}}/reading/{{progress.previousEventId}}/assessment" class="">Previous participant
      </a>
    </p>

  {% endif %}

{% endblock %}


