{# app/views/events/image-reading/index.html #}

{% extends 'layout-app.html' %}

{% set pageHeading = "Image reading" %}
{% set hideBackLink = true %}
{% set gridColumn = "nhsuk-grid-column-full" %}
{% set showRemaining = data.settings.reading.showRemaining | falsify %}

{% set incompleteClinics = clinics | removeWhere('readingStatus.status', 'complete') %}

{% block pageContent %}
  <h1>{{ pageHeading }}</h1>

<h2>Start new reading session</h2>

{% set allReadsEventsWithAwaitingPriors = data.events | filterEventsByEligibleForReading | filterEventsByNeedsAnyRead | sortEventsByScreeningDate %}

{% set allReadsEvents = allReadsEventsWithAwaitingPriors | where("hasRequestedImages", "false") %}

{% set firstReadsEvents = allReadsEvents | filterEventsByNeedsFirstRead %}
{% set secondReadsEvents = allReadsEvents | filterEventsByNeedsSecondRead %}
{% set awaitingPriorsEvents = allReadsEventsWithAwaitingPriors | where("hasRequestedImages", "true") %}

{% set allReadsForUser = allReadsEvents | filterEventsByUserCanRead(data.currentUser.id) %}
{% set firstReadsForUser = firstReadsEvents | filterEventsByUserCanRead(data.currentUser.id) %}
{% set secondReadsForUser = secondReadsEvents | filterEventsByUserCanRead(data.currentUser.id) %}
{% set awaitingPriorsForUser = awaitingPriorsEvents | filterEventsByUserCanRead(data.currentUser.id) %}

{% set oldestAllRead = allReadsEvents[0].timing.startTime if allReadsEvents.length > 0 %}
{% set oldestFirstRead = firstReadsEvents[0].timing.startTime if firstReadsEvents.length > 0 %}
{% set oldestSecondRead = secondReadsEvents[0].timing.startTime if secondReadsEvents.length > 0 %}
{% set oldestAwaitingPrior = awaitingPriorsEvents[0].timing.startTime if awaitingPriorsEvents.length > 0 %}

{# All reads card content #}
{% set allReadsContent %}
  <p>
    {{ allReadsEvents | length }} cases to read
    {# <br>
  ({{ allReadsForUser | length }} available to you)<br> #}
    {# Excludes those awaiting priors #}
  </p>

  {% if oldestAllRead %}
    <p class="nhsuk-u-margin-bottom-1">Oldest from {{ oldestAllRead | formatRelativeDate }}</p>
    {% set daysSinceOldest = oldestAllRead | daysSince %}
    {% if daysSinceOldest > 10 %}
      <div class="nhsuk-u-margin-bottom-2">
        {% if daysSinceOldest > 13 %}
          {{ tag({
            text: "Late",
            classes: "nhsuk-tag--red"
          })}}
        {% elseif daysSinceOldest > 10 %}
          {{ tag({
            text: "Urgent",
            classes: "nhsuk-tag--orange"
          })}}
        {% endif %}
      </div>
    {% endif %}

  {% endif %}

  {{ actionLink({
    classes: "nhsuk-link--no-visited-state nhsuk-u-margin-top-2",
    text: "Start session (50 cases)",
    href: "/reading/create-batch?type=all_reads"
  }) }}
{% endset %}

{# First reads card content #}
{% set firstReadsContent %}
<p>{{ firstReadsEvents | length }} cases needing reds
  {# <br>({{ firstReadsForUser | length }} available to you) #}
</p>
{% if oldestFirstRead %}
  <p>Oldest {{ oldestFirstRead | formatRelativeDate }}</p>
{% endif %}
{{ actionLink({
  classes: "nhsuk-link--no-visited-state nhsuk-u-margin-top-2",
  text: "Start first reads (50 cases)",
  href: "/reading/create-batch?type=first_reads"
}) }}
{% endset %}

{# Second reads card content #}
{% set secondReadsContent %}
<p>{{ secondReadsEvents | length }} cases needing second read<br>
({{ secondReadsForUser | length }} available to you)</p>
{% if oldestSecondRead %}
  <p>Oldest {{ oldestSecondRead | formatRelativeDate }}</p>
{% endif %}
{{ actionLink({
  classes: "nhsuk-link--no-visited-state nhsuk-u-margin-top-2",
  text: "Start second reads (50 cases)",
  href: "/reading/create-batch?type=second_reads"
}) }}
{% endset %}

{# Awaiting priors card content #}
{% set awaitingPriorsContent %}
  <p>{{ awaitingPriorsEvents | length }} cases awaiting priors
    <br>
  ({{ awaitingPriorsForUser | length }} available to you)
  </p>
  {% if oldestAwaitingPrior %}
    <p>Oldest case: {{ oldestAwaitingPrior | formatDate }} ({{ oldestAwaitingPrior | formatRelativeDate }})</p>
  {% endif %}
  {{ actionLink({
    classes: "nhsuk-link--no-visited-state nhsuk-u-margin-top-2",
    text: "View awaiting priors cases",
    href: "/reading/create-batch?type=awaiting_priors&limit=1000&name=Awaiting priors cases&redirect=list"
  }) }}
{% endset %}

{# Custom session card content #}
{% set customSessionContent %}
<p>Choose what cases to read</p>
{{ actionLink({
  classes: "nhsuk-link--no-visited-state nhsuk-u-margin-top-2",
  text: "Start custom session",
  href: "/reading/create-custom-batch"
}) }}
{% endset %}

{# Arbitration card content #}
{% set arbitrationContent %}
<p>53 cases need arbitration</p>
{{ actionLink({
  classes: "nhsuk-link--no-visited-state nhsuk-u-margin-top-2",
  text: "See cases",
  href: "#"
}) }}
{% endset %}

{# Reading history card content #}
{% set readingHistoryContent %}
<p>View your reading history and all recently read cases</p>
{{ actionLink({
  classes: "nhsuk-link--no-visited-state nhsuk-u-margin-top-2",
  text: "View history",
  href: "/reading/history"
}) }}
{% endset %}

<ul class="nhsuk-grid-row nhsuk-card-group">
  <li class="nhsuk-grid-column-one-third nhsuk-card-group__item">
    {{ card({
      heading: "Start reading",
      headingClasses: "nhsuk-heading-s",
      descriptionHtml: allReadsContent
    }) }}
  </li>

  <li class="nhsuk-grid-column-one-third nhsuk-card-group__item">
    {{ card({
      heading: "Custom session",
      headingClasses: "nhsuk-heading-s",
      descriptionHtml: customSessionContent
    }) }}
  </li>

  <li class="nhsuk-grid-column-one-third nhsuk-card-group__item">
    {{ card({
      heading: "Arbitration",
      headingClasses: "nhsuk-heading-s",
      descriptionHtml: arbitrationContent
    }) }}
  </li>


</ul>

<h2>Other options</h2>
<ul class="nhsuk-grid-row nhsuk-card-group">
  <li class="nhsuk-grid-column-one-third nhsuk-card-group__item">
    {{ card({
      heading: "View by clinic",
      headingClasses: "nhsuk-heading-s",
      clickable: true,
      href: "/reading/clinics"
    }) }}
  </li>
  <li class="nhsuk-grid-column-one-third nhsuk-card-group__item">
    {{ card({
      heading: "Reading history",
      headingClasses: "nhsuk-heading-s",
      _descriptionHtml: readingHistoryContent,
      clickable: true,
      href: "/reading/history"
    }) }}
  </li>
  <li class="nhsuk-grid-column-one-third nhsuk-card-group__item">
    {{ card({
      heading: (awaitingPriorsEvents | length) ~ " awaiting priors",
      headingClasses: "nhsuk-heading-s",
      clickable: true,
      href: "/reading/create-batch?type=awaiting_priors&limit=1000&name=Awaiting priors cases&redirect=list"
    }) }}
  </li>

</ul>


{% endblock %}