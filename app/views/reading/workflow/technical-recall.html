{# /app/views/reading/workflow/technical-recall.html #}
{#
  Technical recall data structure:
  imageReadingTemp.technicalRecall.views = {
    RMLO: { reason: 'Breast positioning', additionalDetails: '...' },
    LCC: { reason: 'Image blurred', additionalDetails: '' }
  }
#}

{% extends 'layout-reading.html' %}

{% set pageHeading = "Technical recall" %}

{% set gridColumn = "nhsuk-grid-column-full" %}

{# POST to route handler that cleans up unselected views before redirecting to review #}
{% set formAction = './technical-recall-answer' %}

{% block pageContent %}

  <span class="nhsuk-caption-l">
    {{ participant | getFullName }}
  </span>

  <h1 class="nhsuk-heading-l js-image-count">
    {{ pageHeading }}
  </h1>

  {# Standard views - order matches config setting #}
  {% if data.settings.mammogramViewOrder == 'mlo-first' %}
    {% set views = ['RMLO', 'LMLO', 'RCC', 'LCC'] %}
  {% else %}
    {% set views = ['RCC', 'LCC', 'RMLO', 'LMLO'] %}
  {% endif %}

  {% set recallReasons = [
    'Breast positioning',
    'Incorrect exposure',
    'Image obscured',
    'Image blurred',
    'Image missing',
    'Other reason'
  ] %}

  {# Build select items for reason dropdown #}
  {% set selectItems = [{
    value: '',
    text: "Select a reason",
    disabled: true,
    selected: true
  }] %}
  {% for item in recallReasons %}
    {% set selectItems = selectItems | push({
      value: item,
      text: item
    }) %}
  {% endfor %}

  {# Build checkbox items with conditional fields for each view #}
  {% set rightCheckboxItems = [] %}
  {% set leftCheckboxItems = [] %}
  {% set currentTechRecall = data.imageReadingTemp.technicalRecall.views | default({}) %}

  {% for viewCode in views %}
    {% set viewData = currentTechRecall[viewCode] | default({}) %}
    
    {% set conditionalHtml %}
      {{ select({
        id: "technicalRecall-" + viewCode + "-reason",
        name: "imageReadingTemp[technicalRecall][views][" + viewCode + "][reason]",
        value: viewData.reason,
        label: {
          text: "Reason for recall"
        },
        items: selectItems
      }) }}

      {{ input({
        id: "technicalRecall-" + viewCode + "-additionalDetails",
        name: "imageReadingTemp[technicalRecall][views][" + viewCode + "][additionalDetails]",
        value: viewData.additionalDetails,
        label: {
          text: "Additional details (optional)",
          classes: "nhsuk-label--s"
        }
      }) }}
    {% endset %}

    {% set checkboxItem = {
      value: viewCode,
      text: viewCode,
      checked: viewData.reason,
      conditional: {
        html: conditionalHtml
      }
    } %}

    {% if viewCode | first == "R" %}
      {% set rightCheckboxItems = rightCheckboxItems | push(checkboxItem) %}
    {% else %}
      {% set leftCheckboxItems = leftCheckboxItems | push(checkboxItem) %}
    {% endif %}
  {% endfor %}

  {% call fieldset({
    legend: {
      text: "Which views need to be retaken?",
      classes: "nhsuk-fieldset__legend--m",
      isPageHeading: false
    }
  }) %}

    <div class="nhsuk-grid-row">
      <div class="nhsuk-grid-column-one-half">
        <h2 class="nhsuk-heading-s">Right breast</h2>

        {{ checkboxes({
          idPrefix: "technicalRecall-selectedViews-right",
          name: "imageReadingTemp[technicalRecall][selectedViews]",
          items: rightCheckboxItems
        }) }}
      </div>
      <div class="nhsuk-grid-column-one-half">
        <h2 class="nhsuk-heading-s">Left breast</h2>

        {{ checkboxes({
          idPrefix: "technicalRecall-selectedViews-left",
          name: "imageReadingTemp[technicalRecall][selectedViews]",
          items: leftCheckboxItems
        }) }}
      </div>
    </div>

  {% endcall %}

  {{ button({
    text: "Continue"
  }) }}

{% endblock %}


