{# app/views/reading/workflow/existing-read.html #}
{# View a saved read with option to change it #}

{% extends 'layout-reading.html' %}

{% set pageHeading = "Your opinion" %}
{% set showWorkflowNav = true %}

{% block pageContent %}

  {% set isAwaitingPriors = event | awaitingPriors %}
  {% set hasUserRead = event | userHasReadEvent %}

  <span class="nhsuk-caption-l">
    {{ participant | getFullName }}
  </span>

  {% if isAwaitingPriors and not hasUserRead %}
    {# Event is awaiting priors - show as the reader's opinion #}
    <h1 class="nhsuk-heading-l">Your opinion</h1>

    {% set canUndo = event | userRequestedPriors(data.currentUser.id) %}

    {# Get the request reason from any requested mammogram (same reason applied to all) #}
    {% set requestReason = "" %}
    {% for mammogram in event.previousMammograms %}
      {% if mammogram.requestStatus == "requested" and mammogram.requestReason %}
        {% set requestReason = mammogram.requestReason %}
      {% endif %}
    {% endfor %}

    {% set priorsReadSummaryHtml %}
      {% call appSummaryList() %}
        {{ appSummaryListRow({
          key: {
            text: "Opinion"
          },
          value: {
            html: "Priors requested" | toTag
          },
          actions: {
            items: [{
              href: "./undo-priors",
              text: "Undo priors request",
              visuallyHiddenText: "priors request"
            }]
          } if canUndo
        }) }}

        {% if requestReason %}
          {{ appSummaryListRow({
            key: {
              text: "Reason"
            },
            value: {
              text: requestReason
            }
          }) }}
        {% endif %}
      {% endcall %}
    {% endset %}

    {{ card({
      heading: "Your read",
      headingLevel: "2",
      feature: true,
      descriptionHtml: priorsReadSummaryHtml
    }) }}

  {% else %}
    {# Normal existing read view #}
    <h1 class="nhsuk-heading-l">Your opinion</h1>

    {# Read summary card #}
    {% set readSummaryHtml %}
      {% set read = event | getReadForUser %}
      {% set allowEdits = true %}
      {% set changeOpinionUrl = "./opinion" %}
      {% include "_includes/summary-lists/read-summary.njk" %}
    {% endset %}

    {{ card({
      heading: "Your read",
      headingLevel: "2",
      feature: true,
      descriptionHtml: readSummaryHtml
    }) }}

    {# Other readers' assessments (for testing/debugging) #}
    {% set otherReads = event | getOtherReads %}
    {% if otherReads | length > 0 %}
      {% for otherRead in otherReads %}
        {% set readerName = otherRead.readerId | getUsername %}
        {% set otherReadSummaryHtml %}
          {% set read = otherRead %}
          {% set allowEdits = false %}
          {% include "_includes/summary-lists/read-summary.njk" %}
        {% endset %}

        {{ card({
          heading: (otherRead.readNumber | getOrdinalName | sentenceCase) + " read",
          headingLevel: "2",
          feature: true,
          descriptionHtml: otherReadSummaryHtml
        }) }}
      {% endfor %}
    {% endif %}
  {% endif %}

  {# Medical summary #}
  {# Only show rows that have data #}
  {% set showOnlyPopulated = true %}
  {# No edits allowed in image reading #}
  {% set allowEdits = false %}
  {% set medicalSummaryHtml %}
    {% include "_includes/summary-lists/medical-info-summary.njk" %}
  {% endset %}

  {{ card({
    heading: "Medical summary",
    headingLevel: "2",
    feature: true,
    descriptionHtml: medicalSummaryHtml
  }) }}

{% endblock %}
