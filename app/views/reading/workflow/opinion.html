{# app/views/reading/workflow/opinion.html #}
{# Main reading opinion page - entry point for reading workflow #}

{% extends 'layout-reading.html' %}

{% set pageHeading = participant | getFullName %}
{% set gridColumn = "none" %}
{% set showWorkflowNav = true %}

{% block pageContent %}


  {# Get existing read data for this user (saved read) #}
  {% set existingRead = event | getReadForUser %}
  {% set existingResult = existingRead.result %}
  
  {# Also check for in-progress read in temp data #}
  {% set tempResult = data.imageReadingTemp.result if data.imageReadingTemp else null %}
  
  {# Show update UI if there's either a saved read or an in-progress one #}
  {% set hasExistingOpinion = existingResult or tempResult %}
  {% set currentResult = tempResult or existingResult %}
  
  {% set hasSymptoms = event.medicalInformation.symptoms | length > 0 %}

  {% set opinionHeading = "Review images" %}
  {% if hasExistingOpinion %}
    {% set opinionHeading = "Update review" %}
  {% endif %}

  {# Get mammogram images for thumbnails #}
  {% set mammogramImageSource = data.config.reading.mammogramImageSource or "diagrams" %}
  {% set mammogramImages = getImagesForEvent(eventId, mammogramImageSource, { event: event }) %}

  {# View order from config - determines if CC or MLO comes first #}
  {# Right breast views on left, left breast views on right #}
  {% if data.config.reading.mammogramViewOrder == 'mlo-first' %}
    {% set viewOrder = [
      { key: 'rmlo', label: 'RMLO', side: 'right' },
      { key: 'lmlo', label: 'LMLO', side: 'left' },
      { key: 'rcc', label: 'RCC', side: 'right' },
      { key: 'lcc', label: 'LCC', side: 'left' }
    ] %}
  {% else %}
    {% set viewOrder = [
      { key: 'rcc', label: 'RCC', side: 'right' },
      { key: 'lcc', label: 'LCC', side: 'left' },
      { key: 'rmlo', label: 'RMLO', side: 'right' },
      { key: 'lmlo', label: 'LMLO', side: 'left' }
    ] %}
  {% endif %}

  {# Page header with status tags #}
  <div class="nhsuk-grid-row app-header-with-status">
    <div class="nhsuk-grid-column-two-thirds">
      <span class="nhsuk-caption-l">
        {{ opinionHeading }}
      </span>
      <h1 class="nhsuk-heading-l js-image-count">
        {{ participant | getFullName }}
      </h1>
    </div>
    <div class="nhsuk-grid-column-one-third app-header-with-status__status-tag">

      {# Urgency tags #}
      {% set eventAge = event.timing.startTime | daysSince %}
      {% if eventAge >= data.config.reading.priorityThreshold %}
        <div class="nhsuk-u-margin-bottom-2">
          {% if eventAge >= data.config.reading.urgentThreshold %}
            {{ "Urgent" | toTag }}
          {% elseif eventAge >= data.config.reading.priorityThreshold %}
            {{ "Due soon" | toTag }}
          {% endif %}
        </div>
      {% endif %}

      {# First/second read tag #}
      {% set readCount = event.readingMetadata.readCount %}
      {% if existingResult %}
        {% if readCount == 1 %}
          {{ "First read" | toTag }}
        {% else %}
          {{ "Second read" | toTag }}
        {% endif %}
      {% else %}
        {% if readCount == 0 %}
          {{ "First read" | toTag }}
        {% else %}
          {{ "Second read" | toTag }}
        {% endif %}
      {% endif %}

      {# Requested images tag #}
      {% if event.hasRequestedImages | falsify %}
        {% set requestedWithDateHtml %}
          {{ "Images requested" | toTag | safe }}<br>
          Requested 10 Feb 2025
        {% endset %}
        {{ requestedWithDateHtml | safe }}
      {% endif %}

      {% if (data.settings.debugMode | falsify) %}
        {% if event.mammogramData.metadata.hasAdditionalImages %}
          <br>{{ "Has additional" | toTag }}
        {% endif %}
        {% if event.mammogramData.isImperfectButBestPossible | includes("yes") %}
            <br>{{ "Imperfect" | toTag }}
        {% endif %}
        {% if event.mammogramData.isIncompleteMammography | includes("yes") %}
            <br>{{ "Incomplete" | toTag }}
        {% endif %}
      {% endif %}
    </div>
  </div>

  {# Symptoms warning #}
  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">
      {% set symptoms = event.medicalInformation.symptoms %}
      {% include "symptomsWarningCard.njk" %}
    </div>
  </div>



  {# Opinion form with thumbnails #}
  {% set questionText = "What is your opinion of these images?" %}

  {# Count total images #}
  {% set imageCount = 0 %}
  {% for view in viewOrder %}
    {% set allPaths = mammogramImages.allPaths[view.key] if mammogramImages and mammogramImages.allPaths else null %}
    {% if allPaths %}
      {% if allPaths is string %}
        {% set imageCount = imageCount + 1 %}
      {% else %}
        {% set imageCount = imageCount + allPaths | length %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {# Opinion form data attributes are used to manage the first-load lockout #}
  {# Todo: do we need a form here? is the parent layout's form not enough? #}
  {% set opinionDelayEnabled = data.settings.reading.enableOpinionDelay != 'false' %}
  {% set opinionDelayLocked = 'true' if opinionDelayEnabled and not hasExistingOpinion else 'false' %}
  <form action="./opinion-answer" method="POST" class="app-reading-opinion" data-reading-opinion-form="true" data-reading-opinion-locked="{{ opinionDelayLocked }}" data-event-id="{{ event.id }}" data-batch-id="{{ batch.id if batch }}">

    {# Hidden field to track previous result for opinion change detection #}
    <input type="hidden" name="imageReadingTemp[previousResult]" value="{{ currentResult }}">

    <div class="nhsuk-grid-row">

      {# Left column: Mammogram thumbnails #}
      <div class="nhsuk-grid-column-one-third nhsuk-u-margin-bottom-4">
        <h2 class="nhsuk-heading-s">Image thumbnails ({{ imageCount }})</h2>
        <div class="app-mammogram-thumbnails">
          {% for view in viewOrder %}
            <div class="app-mammogram-thumbnail app-mammogram-thumbnail--{{ view.side }}">
              {% set allPaths = mammogramImages.allPaths[view.key] if mammogramImages and mammogramImages.allPaths else null %}
              
              {% if allPaths %}
                {# Handle both single path (string) and multiple paths (array) #}
                {% if allPaths is string %}
                  <div class="app-mammogram-thumbnail__image-wrapper">
                    <span class="app-mammogram-thumbnail__label">{{ view.label }}</span>
                    <img 
                      class="app-mammogram-thumbnail__image{% if mammogramImageSource == 'diagrams' %} app-mammogram-thumbnail__image--diagram{% endif %}" 
                      src="{{ allPaths }}" 
                      alt="{{ view.label }} view"
                      data-view="{{ view.label }}"
                    >
                  </div>
                {% else %}
                  {# Multiple images - each with its own wrapper and label #}
                  {% for imagePath in allPaths %}
                    <div class="app-mammogram-thumbnail__image-wrapper">
                      <span class="app-mammogram-thumbnail__label">{{ view.label }}</span>
                      <img 
                        class="app-mammogram-thumbnail__image{% if mammogramImageSource == 'diagrams' %} app-mammogram-thumbnail__image--diagram{% endif %}" 
                        src="{{ imagePath }}" 
                        alt="{{ view.label }} view ({{ loop.index }} of {{ loop.length }})"
                        data-view="{{ view.label }}"
                      >
                    </div>
                  {% endfor %}
                {% endif %}
              {% else %}
                {# Missing image placeholder #}
                <div class="app-mammogram-thumbnail__image-wrapper">
                  <span class="app-mammogram-thumbnail__label">{{ view.label }}</span>
                  <div class="app-mammogram-thumbnail__missing">
                    <span class="app-mammogram-thumbnail__missing-text">No image</span>
                  </div>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>

      {# Right column: Opinion buttons/radios #}
      <div class="nhsuk-grid-column-two-thirds">
        {% if hasExistingOpinion %}
          {# Show radios when updating an existing or in-progress result #}
          {{ radios({
            name: "imageReadingTemp[result]",
            fieldset: {
              legend: {
                text: questionText,
                classes: "nhsuk-fieldset__legend--m",
                isPageHeading: false
              }
            },
            items: [
              {
                value: "normal",
                text: "Normal",
                checked: currentResult == 'normal' and not existingRead.normalDetails
              },
              {
                value: "normal_with_details",
                text: "Normal, but add details",
                checked: (currentResult == 'normal' and existingRead.normalDetails) or currentResult == 'normal_with_details'
              },
              {
                value: "technical_recall",
                text: "Technical recall"
              },
              {
                value: "recall_for_assessment",
                text: "Recall for assessment"
              }
            ],
            value: currentResult
          }) }}

          {{ button({
            text: "Update opinion"
          }) }}

        {% else %}
          {# Show buttons for initial assessment - vertically stacked #}
          <h2 class="nhsuk-heading-m">{{ questionText }}</h2>

          <div class="nhsuk-u-margin-bottom-4">
            {% if hasSymptoms %}
              {{ button({
                text: "Normal, and add details",
                value: "normal_with_details",
                name: "imageReadingTemp[result]",
                classes: "app-button-full-width nhsuk-u-margin-bottom-3"
              }) }}
            {% else %}
              {{ button({
                text: "Normal",
                value: "normal",
                name: "imageReadingTemp[result]",
                classes: "app-button-full-width nhsuk-u-margin-bottom-3"
              }) }}

              <p class="nhsuk-u-margin-bottom-4">
                <button type="submit" name="imageReadingTemp[result]" value="normal_with_details" class="app-button-link">
                  Normal, but add details
                </button>
              </p>
            {% endif %}
          </div>

          <div class="nhsuk-u-margin-bottom-4">
            {{ button({
              text: "Technical recall",
              value: "technical_recall",
              name: "imageReadingTemp[result]",
              classes: "nhsuk-button--secondary app-button-full-width nhsuk-u-margin-bottom-3"
            }) }}
          </div>

          <div class="nhsuk-u-margin-bottom-4">
            {{ button({
              text: "Recall for assessment",
              value: "recall_for_assessment",
              name: "imageReadingTemp[result]",
              classes: "nhsuk-button--warning app-button-full-width"
            }) }}
          </div>

        {% endif %}
      </div>
    </div>

  </form>


  {# Image notes - moved above opinion section #}
  {% include "_includes/reading/image-warnings.njk" %}


  {# Medical summary #}
  {# Only show rows that have data #}
  {% set showOnlyPopulated = true %}
  {# No edits allowed in image reading #}

  {% set allowEdits = false %}

  {% set medicalSummaryHtml %}
    {% include "_includes/summary-lists/medical-info-summary.njk" %}
  {% endset %}

  {{ card({
    heading: "Medical summary",
    headingLevel: "2",
    feature: true,
    descriptionHtml: medicalSummaryHtml
  }) }}

{% endblock %}

{% block pageScripts %}
<script>
// Thumbnail zoom functionality
document.addEventListener('DOMContentLoaded', () => {
  const enableThumbnailZoom = false

  if (!enableThumbnailZoom)
  {
    return
  }

  const thumbnails = document.querySelectorAll('.app-mammogram-thumbnail__image')
  
  thumbnails.forEach(img => {
    img.addEventListener('click', (e) => {
      const src = e.target.src
      const view = e.target.dataset.view || ''
      
      // Create zoom overlay
      const overlay = document.createElement('div')
      overlay.className = 'app-mammogram-zoom'
      overlay.innerHTML = `
        <span class="app-mammogram-zoom__label">${view}</span>
        <img class="app-mammogram-zoom__image" src="${src}" alt="${view} view">
      `
      
      // Close on click or escape
      overlay.addEventListener('click', () => overlay.remove())
      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
          overlay.remove()
          document.removeEventListener('keydown', escHandler)
        }
      })
      
      document.body.appendChild(overlay)
    })
  })
})
</script>
{% endblock %}
