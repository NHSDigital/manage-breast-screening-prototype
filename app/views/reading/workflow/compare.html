{# app/views/reading/workflow/compare.html #}
{# Comparison page for second readers to compare their opinion with first reader #}

{% extends 'layout-reading.html' %}

{% set pageHeading = "Compare opinions" %}

{# Layout option: 'side-by-side' or 'stacked' #}
{% set cardLayout = 'stacked' %}

{% set back = {
  href: "./opinion",
  text: "Back"
} %}

{% block pageContent %}

  {# Get comparison info #}
  {% set secondOpinion = data.imageReadingTemp.opinion %}
  {% set comparisonInfo = event | getComparisonInfo(secondOpinion) %}
  {% set firstRead = comparisonInfo.firstRead %}
  {% set firstOpinion = comparisonInfo.firstOpinion %}
  {% set comparisonType = comparisonInfo.type %}

  {% if comparisonType == "discordant" %}
    {% set pageHeading = "The first reader had a different opinion" %}
  {% elseif comparisonType == "agreeing" %}
    {% set pageHeading = "You and the first reader gave the same opinion" %}
  {% endif %}

  {# Format opinion labels #}
  {% set opinionLabels = {
    "normal": "Normal",
    "technical_recall": "Technical recall",
    "recall_for_assessment": "Recall for assessment"
  } %}

  {% set firstOpinionLabel = opinionLabels[firstOpinion] or firstOpinion %}
  {% set secondOpinionLabel = opinionLabels[secondOpinion] or secondOpinion %}

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      <span class="nhsuk-caption-l">
        {{ participant | getFullName }}
      </span>
      <h1 class="nhsuk-heading-l">{{ pageHeading }}</h1>

      {# {% if comparisonType == "discordant" %}
        {{ warningCallout({
          heading: "Opinions differ",
          html: "<p>Your opinion differs from the first reader. If you keep your original opinion, this case will go to arbitration.</p>"
        }) }}
      {% else %}
        {{ insetText({
          html: "<p>You and the first reader have given the same overall opinion. You can adopt the first reader's details or keep your own.</p>"
        }) }}
      {% endif %} #}

    </div>
  </div>

  {# First reader's opinion card #}
  {% set firstReadSummaryHtml %}
    {% set read = firstRead %}
    {% set allowEdits = false %}
    {% include "_includes/summary-lists/read-summary.njk" %}
  {% endset %}

  {# Second reader's opinion card (yours) #}
  {# Hide empty rows - shows details if they exist (e.g. adopted from first reader) #}
  {% set isEarlyComparison = data.settings.reading.secondReaderComparison == 'early' %}
  {% set secondReadSummaryHtml %}
    {% set read = data.imageReadingTemp %}
    {% set allowEdits = false %}
    {% set hideEmptyRows = true %}
    {% include "_includes/summary-lists/read-summary.njk" %}
  {% endset %}

  {% if cardLayout == 'side-by-side' %}
    {# Side by side layout #}
    <div class="nhsuk-grid-row">
      <div class="nhsuk-grid-column-one-half">
        {{ card({
          heading: "First read",
          headingLevel: "2",
          feature: true,
          descriptionHtml: firstReadSummaryHtml
        }) }}
      </div>
      <div class="nhsuk-grid-column-one-half">
        {{ card({
          heading: "Your read",
          headingLevel: "2",
          feature: true,
          descriptionHtml: secondReadSummaryHtml
        }) }}
      </div>
    </div>
  {% else %}
    {# Stacked layout #}
    <div class="nhsuk-grid-row">
      <div class="nhsuk-grid-column-full">
        {{ card({
          heading: "First read",
          headingLevel: "2",
          feature: true,
          descriptionHtml: firstReadSummaryHtml
        }) }}

        {{ card({
          heading: "Your read",
          headingLevel: "2",
          feature: true,
          descriptionHtml: secondReadSummaryHtml
        }) }}
      </div>
    </div>
  {% endif %}

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      <form action="./compare-answer" method="POST">

        {# Build radio options based on comparison type and timing #}
        {% set radioItems = [] %}

        {# Option to keep your opinion #}
        {% set keepLabelHtml %}
          {% if isEarlyComparison and comparisonType == "agreeing" %}
            {# Early: they haven't added details yet #}
            Keep my  opinion {{ secondOpinion | toTag }}{% if secondOpinion != "normal" %} and provide my own details{% endif %}
          {% elseif isEarlyComparison and comparisonType == "discordant" %}
            Keep my original opinion {{ secondOpinion | toTag }}{% if secondOpinion != "normal" %} and provide details{% endif %}
          {% else %}
            {# Late: they've already added details #}
            Keep my opinion {{ secondOpinion | toTag }}
          {% endif %}
        {% endset %}

        {% set keepHint %}
          {% if comparisonType == "discordant" %}
            This case will go to arbitration
          {% endif %}
        {% endset %}

        {% set radioItems = radioItems | push({
          value: "keep",
          html: keepLabelHtml,
          hint: {
            text: keepHint
          } if keepHint | trim
        }) %}

        {# Option to change to match first reader #}
        {% set adoptLabelHtml %}
          {% if comparisonType == "discordant" %}
            {# Discordant: changing opinion entirely #}
            Change my opinion to {{ firstOpinion | toTag }}
            {# {%- if firstOpinion != "normal" %} and use their details{% endif %} #}
          {% else %}
            {# Agreeing: same opinion, adopt their details #}
            Keep {{ firstOpinion | toTag }} and use the first reader's details
          {% endif %}
        {% endset %}

        {% set adoptHint %}
          {# Add hint text here if needed #}
          {% if comparisonType == "discordant" %}
            Copies first readerâ€™s details - you can modify when reviewing
          {% else %}
            You can modify details when reviewing
          {% endif %}
        {% endset %}

        {% set radioItems = radioItems | push({
          value: "adopt",
          html: adoptLabelHtml,
          hint: {
            text: adoptHint
          } if adoptHint | trim
        }) %}

        {{ radios({
          name: "compareDecision",
          fieldset: {
            legend: {
              text: "What would you like to do?",
              classes: "nhsuk-fieldset__legend--m",
              isPageHeading: false
            }
          },
          items: radioItems
        }) }}

        {{ button({
          text: "Continue"
        }) }}

      </form>

    </div>
  </div>

{% endblock %}
