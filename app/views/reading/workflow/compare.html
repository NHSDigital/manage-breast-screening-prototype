{# app/views/reading/workflow/compare.html #}
{# Comparison page for second readers to compare their opinion with first reader #}

{% extends 'layout-reading.html' %}

{% set pageHeading = "Compare opinions" %}
{% set bodyClasses = (bodyClasses or "") + " app-page-width--wide" %}

{# Layout option: 'side-by-side' or 'stacked' #}
{% set cardLayout = 'side-by-side' %}

{# Side-by-side card action position: 'top' or 'bottom' #}
{% set sideBySideCardActionPosition = "bottom" %}

{% set back = {
  href: "./opinion",
  text: "Back"
} %}

{% block pageContent %}

  {# Get comparison info #}
  {% set secondOpinion = data.imageReadingTemp.opinion %}
  {% set comparisonInfo = event | getComparisonInfo(secondOpinion) %}
  {% set firstRead = comparisonInfo.firstRead %}
  {% set firstOpinion = comparisonInfo.firstOpinion %}
  {% set comparisonType = comparisonInfo.type %}

  {% if comparisonType == "discordant" %}
    {% set pageHeading = "The first reader had a different opinion" %}
  {% elseif comparisonType == "agreeing" %}
    {% set pageHeading = "You and the first reader gave the same opinion" %}
  {% endif %}

  {# Format opinion labels #}
  {% set opinionLabels = {
    "normal": "Normal",
    "technical_recall": "Technical recall",
    "recall_for_assessment": "Recall for assessment"
  } %}

  {% set firstOpinionLabel = opinionLabels[firstOpinion] or firstOpinion %}
  {% set secondOpinionLabel = opinionLabels[secondOpinion] or secondOpinion %}

  {% set opinionCardClasses = {
    "normal": "app-reading-compare-card--normal",
    "technical_recall": "app-reading-compare-card--technical-recall",
    "recall_for_assessment": "app-reading-compare-card--recall-for-assessment"
  } %}

  {% set firstOpinionCardClass = opinionCardClasses[firstOpinion] or "" %}
  {% set secondOpinionCardClass = opinionCardClasses[secondOpinion] or "" %}

  {# 
    Determine if opinions need/have details:
    - Normal: only needs details if wantsNormalDetails flag is set
    - TR: always needs details (views to retake)
    - RFA: always needs details (breast assessments, annotations)
  #}
  {% set secondOpinionNeedsDetails = (
    secondOpinion == "technical_recall" or 
    secondOpinion == "recall_for_assessment" or 
    data.imageReadingTemp.wantsNormalDetails
  ) %}
  
  {% set firstOpinionHasDetails = (
    (firstOpinion == "technical_recall" and firstRead.technicalRecall and firstRead.technicalRecall.views) or
    (firstOpinion == "recall_for_assessment" and (firstRead.left or firstRead.right)) or
    (firstOpinion == "normal" and firstRead.normalDetails)
  ) %}

  {# Check if second reader already has details #}
  {% set secondHasDetails = (
    (secondOpinion == "technical_recall" and data.imageReadingTemp.technicalRecall and data.imageReadingTemp.technicalRecall.views) or
    (secondOpinion == "recall_for_assessment" and (data.imageReadingTemp.left or data.imageReadingTemp.right)) or
    (secondOpinion == "normal" and data.imageReadingTemp.normalDetails)
  ) %}

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      <span class="nhsuk-caption-l">
        {{ participant | getFullName }}
      </span>
      <h1 class="nhsuk-heading-l">{{ pageHeading }}</h1>

    </div>
  </div>

  {# First reader's opinion card #}
  {% set firstReadSummaryHtml %}
    {% set read = firstRead %}
    {% set allowEdits = false %}
    {% set hideOpinionRow = true %}
    {% include "_includes/summary-lists/read-summary.njk" %}
  {% endset %}

  {# Second reader's opinion card (yours) #}
  {# Hide empty rows - shows details if they exist (e.g. adopted from first reader) #}
  {% set secondReadSummaryHtml %}
    {% set read = data.imageReadingTemp %}
    {% set allowEdits = false %}
    {% set hideEmptyRows = true %}
    {% set hideOpinionRow = true %}
    {% include "_includes/summary-lists/read-summary.njk" %}
  {% endset %}

  {# Build decision labels/hints once for cards or radios #}
  {% set keepLabelHtml %}
    Keep my opinion {{ secondOpinion | toTag }}
    {%- if secondOpinionNeedsDetails and not secondHasDetails %} and provide details
    {%- elseif secondHasDetails %} and my details
    {%- endif %}
  {% endset %}

  {% set keepHint %}
    {% if comparisonType == "discordant" %}
      This case will go to arbitration
    {% endif %}
  {% endset %}

  {% set adoptLabelHtml %}
    {% if comparisonType == "discordant" %}
      Change my opinion to {{ firstOpinion | toTag }}
      {%- if firstOpinionHasDetails %} and use their details{%- endif %}
    {% else %}
      Use the first reader's details
    {% endif %}
  {% endset %}

  {% set adoptHint %}
    {% if comparisonType == "discordant" and not firstOpinionHasDetails %}
      You can add details when reviewing
    {% endif %}
  {% endset %}

  {% set keepActionHtml %}
    <div class="app-reading-compare-card__action app-reading-compare-card__action--{{ sideBySideCardActionPosition }}">
      <form action="./compare-answer" method="post" class="app-reading-compare-card__action-form">
        <input type="hidden" name="compareDecision" value="keep">
        {{ button({
          text: "Keep your opinion",
          classes: "nhsuk-button--secondary nhsuk-u-margin-bottom-0"
        }) }}
      </form>
      {# <p class="nhsuk-body nhsuk-u-margin-top-2 nhsuk-u-margin-bottom-0">{{ keepLabelHtml | safe }}</p>
      {% if keepHint | trim %}
        <p class="nhsuk-hint nhsuk-u-margin-top-2 nhsuk-u-margin-bottom-0">{{ keepHint }}</p>
      {% endif %} #}
    </div>
  {% endset %}

  {% set adoptActionHtml %}
    <div class="app-reading-compare-card__action app-reading-compare-card__action--{{ sideBySideCardActionPosition }}">
      <form action="./compare-answer" method="post" class="app-reading-compare-card__action-form">
        <input type="hidden" name="compareDecision" value="adopt">
        {{ button({
          text: "Use their details" if comparisonType == "agreeing" else "Change to this opinion",
          classes: "nhsuk-button--secondary nhsuk-u-margin-bottom-0"
        }) }}
      </form>
      {# <p class="nhsuk-body nhsuk-u-margin-top-2 nhsuk-u-margin-bottom-0">{{ adoptLabelHtml | safe }}</p> #}
      {# {% if adoptHint | trim %}
        <p class="nhsuk-hint nhsuk-u-margin-top-2 nhsuk-u-margin-bottom-0">{{ adoptHint }}</p>
      {% endif %} #}
    </div>
  {% endset %}

  {% set firstReadCardContentHtml %}
    {% if sideBySideCardActionPosition == "top" %}
      {{ adoptActionHtml | safe }}
    {% endif %}
    {{ firstReadSummaryHtml | safe }}
    {% if sideBySideCardActionPosition == "bottom" %}
      {{ adoptActionHtml | safe }}
    {% endif %}
  {% endset %}

  {% set secondReadCardContentHtml %}
    {% if sideBySideCardActionPosition == "top" %}
      {{ keepActionHtml | safe }}
    {% endif %}
    {{ secondReadSummaryHtml | safe }}
    {% if sideBySideCardActionPosition == "bottom" %}
      {{ keepActionHtml | safe }}
    {% endif %}
  {% endset %}

  {% if cardLayout == 'side-by-side' %}
    {# Side by side layout #}
    <div class="nhsuk-grid-row app-reading-compare-grid app-reading-compare-grid--{{ sideBySideCardActionPosition }}-actions">
      <div class="nhsuk-grid-column-one-half">
        <h2 class="nhsuk-u-margin-bottom-0">First read</h2>
        {{ card({
          heading: firstOpinionLabel,
          headingLevel: "2",
          feature: true,
          classes: "app-reading-compare-card " + firstOpinionCardClass,
          descriptionHtml: firstReadCardContentHtml
        }) }}
      </div>
      <div class="nhsuk-grid-column-one-half">
        <h2 class="nhsuk-u-margin-bottom-0">Your read</h2>
        {{ card({
          heading: secondOpinionLabel,
          headingLevel: "2",
          feature: true,
          classes: "app-reading-compare-card " + secondOpinionCardClass,
          descriptionHtml: secondReadCardContentHtml
        }) }}
      </div>
    </div>
  {% else %}
    {# Stacked layout #}
    <div class="nhsuk-grid-row">
      <div class="nhsuk-grid-column-full">
        {{ card({
          heading: "First read",
          headingLevel: "2",
          feature: true,
          classes: "app-reading-compare-card " + firstOpinionCardClass,
          descriptionHtml: firstReadSummaryHtml
        }) }}

        {{ card({
          heading: "Your read",
          headingLevel: "2",
          feature: true,
          classes: "app-reading-compare-card " + secondOpinionCardClass,
          descriptionHtml: secondReadSummaryHtml
        }) }}
      </div>
    </div>
  {% endif %}

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      {% if cardLayout == 'stacked' %}

      <form action="./compare-answer" method="POST">

        {# Build radio options based on comparison type and detail state #}
        {% set radioItems = [] %}

        {% set radioItems = radioItems | push({
          value: "keep",
          html: keepLabelHtml,
          hint: {
            text: keepHint
          } if keepHint | trim
        }) %}

        {% set radioItems = radioItems | push({
          value: "adopt",
          html: adoptLabelHtml,
          hint: {
            text: adoptHint
          } if adoptHint | trim
        }) %}

        {{ radios({
          name: "compareDecision",
          fieldset: {
            legend: {
              text: "What would you like to do?",
              classes: "nhsuk-fieldset__legend--m",
              isPageHeading: false
            }
          },
          items: radioItems
        }) }}

        {{ button({
          text: "Continue"
        }) }}

      </form>

      {% endif %}

    </div>
  </div>

{% endblock %}
