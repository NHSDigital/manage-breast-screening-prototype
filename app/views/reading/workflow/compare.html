{# app/views/reading/workflow/compare.html #}
{# Comparison page for second readers to compare their opinion with first reader #}

{% extends 'layout-reading.html' %}

{% set pageHeading = "Compare opinions" %}



{% set back = {
  href: "./opinion",
  text: "Back"
} %}

{% block pageContent %}

  {# Get comparison info #}
  {% set secondOpinion = data.imageReadingTemp.opinion %}
  {% set comparisonInfo = event | getComparisonInfo(secondOpinion) %}
  {% set firstRead = comparisonInfo.firstRead %}
  {% set firstOpinion = comparisonInfo.firstOpinion %}
  {% set comparisonType = comparisonInfo.type %}

  {% if comparisonType == "discordant" %}
    {% set pageHeading = "The first reader had a different opinion" %}
  {% elseif comparisonType == "agreeing" %}
    {% set pageHeading = "You and the first reader gave the same opinion" %}
  {% endif %}

  {# Format opinion labels #}
  {% set opinionLabels = {
    "normal": "Normal",
    "technical_recall": "Technical recall",
    "recall_for_assessment": "Recall for assessment"
  } %}

  {% set firstOpinionLabel = opinionLabels[firstOpinion] or firstOpinion %}
  {% set secondOpinionLabel = opinionLabels[secondOpinion] or secondOpinion %}

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      <span class="nhsuk-caption-l">
        {{ participant | getFullName }}
      </span>
      <h1 class="nhsuk-heading-l">{{ pageHeading }}</h1>

      {# {% if comparisonType == "discordant" %}
        {{ warningCallout({
          heading: "Opinions differ",
          html: "<p>Your opinion differs from the first reader. If you keep your original opinion, this case will go to arbitration.</p>"
        }) }}
      {% else %}
        {{ insetText({
          html: "<p>You and the first reader have given the same overall opinion. You can adopt the first reader's details or keep your own.</p>"
        }) }}
      {% endif %} #}

    </div>
  </div>

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-one-half">

      {# First reader's opinion #}
      {% set firstReadSummaryHtml %}
        {% set read = firstRead %}
        {% set allowEdits = false %}
        {% include "_includes/summary-lists/read-summary.njk" %}
      {% endset %}

      {{ card({
        heading: "First read",
        headingLevel: "2",
        feature: true,
        descriptionHtml: firstReadSummaryHtml
      }) }}

    </div>
    <div class="nhsuk-grid-column-one-half">

      {# Second reader's opinion (yours) #}
      {# In early comparison, only show the opinion - no details yet #}
      {% set isEarlyComparison = data.settings.reading.secondReaderComparison == 'early' %}
      {% set secondReadSummaryHtml %}
        {% set read = data.imageReadingTemp %}
        {% set allowEdits = false %}
        {% set opinionOnly = isEarlyComparison %}
        {% include "_includes/summary-lists/read-summary.njk" %}
      {% endset %}

      {{ card({
        heading: "Your opinion",
        headingLevel: "2",
        feature: true,
        descriptionHtml: secondReadSummaryHtml
      }) }}

    </div>
  </div>

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      <form action="./compare-answer" method="POST">

        {# Build radio options based on comparison type #}
        {% set radioItems = [] %}

        {# Option to keep your opinion #}
        {% set keepLabelHtml %}
          {% if comparisonType == "discordant" %}
            Keep my original opinion {{ secondOpinion | toTag }}
          
          {% else %}
            {{ secondOpinionLabel }} and add your own details {{ secondOpinion | toTag }}
          {% endif %}
        {% endset %}

        {% set keepHint %}
          {# {% if comparisonType == "agreeing" %}
            Continue to add details
          {% endif %} #}
          {% if comparisonType == "discordant" %}
            This case will go to arbitration
          {% endif %}
        {% endset %}

        {% set radioItems = radioItems | push({
          value: "keep",
          html: keepLabelHtml,
          hint: {
            text: keepHint
          } if keepHint | trim
        }) %}

        {# Option to change to match first reader #}
        {% set adoptLabelHtml %}
          {% if comparisonType == "discordant" %}
            Change my opinion to {{ firstOpinion | toTag }}
          {% else %}
            {{ firstOpinionLabel }} and use first reader's details {{ firstOpinion | toTag }}
          {% endif %}
        {% endset %}

        {% set radioItems = radioItems | push({
          value: "adopt",
          html: adoptLabelHtml,
          _hint: {
            text: "Your opinion will match the first reader" if comparisonType == "discordant" else "Your opinion will match the first reader exactly"
          }
        }) %}

        {{ radios({
          name: "compareDecision",
          fieldset: {
            legend: {
              text: "What would you like to do?",
              classes: "nhsuk-fieldset__legend--m",
              isPageHeading: false
            }
          },
          items: radioItems
        }) }}

        {{ button({
          text: "Continue"
        }) }}

      </form>

    </div>
  </div>

{% endblock %}
