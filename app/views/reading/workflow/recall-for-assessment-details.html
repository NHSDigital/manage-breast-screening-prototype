{# /app/views/reading/recall-for-assessment-details.html #}

{% extends 'layout-reading.html' %}

{% set pageHeading = "Recall for assessment" %}

{% set gridColumn = "none" %}

{% set formAction = './review' %}


{% macro breastDetails(params) %}

  {% set breastDetailsHtml %}

    {% set Side = params.side | capitalize %}

    {% set abnormalDetailsHtml %}

      {{ button({
        text: "Mark an abnormality" if not ((data.imageReadingTemp[params.side].annotations | default([])) | length > 0) else "Mark another abnormality",
        classes: "nhsuk-button--secondary",
        href: "./annotation/add?side=" + params.side + "&[imageReadingTemp][" + params.side + "][breastAssessment]=abnormal"
      }) }}

    {% endset %}

    {{ radios({
      name: "imageReadingTemp[" + params.side + "][breastAssessment]",
      value: data.imageReadingTemp[params.side].breastAssessment,
      fieldset: {
        legend: {
          text: "What is your opinion of the " + params.side + " breast?",
          classes: "nhsuk-fieldset__legend--s",
          isPageHeading: false
        }
      },
      items: [
        {
          value: "normal",
          text: "Normal"
        },
        {
          value: "clinical",
          text: "Normal, but symptoms need clinical assessment"
        } if event.medicalInformation.symptoms | length > 0,
        {
          value: "abnormal",
          text: "Abnormal, recall for assessment",
          conditional: {
            html: abnormalDetailsHtml
          }
        }
      ] | removeEmpty
    }) }}

    {{ input({
      name: "imageReadingTemp[" + params.side + "][comment]",
      value: data.imageReadingTemp[params.side].comment,
      label: {
        text: Side + " breast comment (optional)",
        classes: "nhsuk-label--s"
      },
      classes: "nhsuk-u-width-two-thirds"
    }) }}

    {% if (data.imageReadingTemp[params.side].annotations | default([])) | length > 0 %}

      <h3>Abnormalities</h3>

      <ul class="nhsuk-list nhsuk-list--bullet">
        {% for annotation in data.imageReadingTemp[params.side].annotations %}
          {% set annotationSummary = annotation | summariseAnnotation %}
          {% set changeLinkText = "Change" %}
          {% set changeLinkHiddenText = "annotation" %}
          {% if annotationSummary %}
            {% set changeLinkHiddenText = annotationSummary %}
          {% endif %}
          <li>
            {{ annotationSummary }}
            <span class="nhsuk-u-visually-hidden"> </span>
            <a href="./annotation/edit/{{ annotation.id }}">{{ changeLinkText }}</a>
            <span class="nhsuk-u-visually-hidden"> {{ changeLinkHiddenText }}</span>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

  {% endset %}

  {{ card({
    heading: Side + " breast",
    headingLevel: "2",
    feature: true,
    descriptionHtml: breastDetailsHtml
  }) }}

{% endmacro %}

{% block pageContent %}

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">
      <span class="nhsuk-caption-l">
        {{ participant | getFullName }}
      </span>

      <h1 class="nhsuk-heading-l js-image-count">
        {{ pageHeading }}
      </h1>
    </div>
  </div>

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">

      {% set symptoms = event.medicalInformation.symptoms %}
      {% include "symptomsWarningCard.njk" %}

    </div>
  </div>

  <div class="nhsuk-grid-row">

    {% for breastSide in ["right", "left"] %}
      <div class="nhsuk-grid-column-one-half">
        {{ breastDetails({
          side: breastSide
        }) }}
      </div>
    {% endfor %}

  </div>

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      {{ button({
        text: "Continue"
      }) }}

    </div>
  </div>

{% endblock %}