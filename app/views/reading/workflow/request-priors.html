{# app/views/reading/workflow/request-priors.html #}

{% extends 'layout-reading.html' %}

{% set pageHeading = "Request prior images" %}
{% set back = {
  href: "./opinion",
  text: "Back"
} %}

{% block pageContent %}

  {% set caption %}
    {{ participant | getFullName }}
  {% endset %}

  {% set unrequestedPriors = event | getUnrequestedPriors %}

  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      <form action="./request-priors-answer" method="POST">

        <h1 class="nhsuk-heading-l">
          <span class="nhsuk-caption-l">{{ caption }}</span>
          {{ pageHeading }}
        </h1>

        {# If only one unrequested mammogram, show details without checkboxes #}
        {% if unrequestedPriors | length == 1 %}
          {% set mammogram = unrequestedPriors[0] %}
          <p>
            {% if mammogram.location == "bsu" %}
              {{ mammogram.bsu }}
            {% elseif mammogram.location == "otherUk" %}
              {{ mammogram.otherUk }}
            {% elseif mammogram.location == "otherNonUk" %}
              Outside UK: {{ mammogram.otherNonUk }}
            {% elseif mammogram.location == "currentBsu" %}
              {{ unit.name if unit else "Current BSU" }}
            {% endif %}
            {% if mammogram.dateType == "dateKnown" %}
              – {{ mammogram.dateTaken | formatDate }}
            {% elseif mammogram.dateType == "moreThanSixMonths" %}
              – over 6 months ago
            {% endif %}
          </p>

          {# Hidden field to identify which mammogram to request #}
          <input type="hidden" name="requestPriorIds[]" value="{{ mammogram.id }}">

        {% else %}
          {# Multiple unrequested mammograms - show checkboxes #}
          {% set mammogramItems = [] %}
          {% for mammogram in unrequestedPriors %}
            {% set mammogramLabel %}
              {% if mammogram.location == "bsu" %}
                {{ mammogram.bsu }}
              {% elseif mammogram.location == "otherUk" %}
                {{ mammogram.otherUk }}
              {% elseif mammogram.location == "otherNonUk" %}
                Outside UK: {{ mammogram.otherNonUk }}
              {% elseif mammogram.location == "currentBsu" %}
                {{ unit.name if unit else "Current BSU" }}
              {% endif %}
              {% if mammogram.dateType == "dateKnown" %}
                – {{ mammogram.dateTaken | formatDate }}
              {% elseif mammogram.dateType == "moreThanSixMonths" %}
                – over 6 months ago
              {% endif %}
            {% endset %}

            {% set mammogramItems = mammogramItems | push({
              value: mammogram.id,
              text: mammogramLabel | trim,
              checked: true
            }) %}
          {% endfor %}

          {{ checkboxes({
            name: "requestPriorIds",
            fieldset: {
              legend: {
                text: "Select which prior images to request",
                classes: "nhsuk-fieldset__legend--s"
              }
            },
            items: mammogramItems
          }) }}

        {% endif %}

        {{ textarea({
          name: "requestPriorReason",
          id: "requestPriorReason",
          label: {
            text: "Reason for requesting (optional)",
            classes: "nhsuk-label--s"
          },
          rows: 3
        }) }}

        {{ button({
          text: "Request and continue to next case"
        }) }}

      </form>

    </div>
  </div>

{% endblock %}
