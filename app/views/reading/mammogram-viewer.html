{# app/views/reading/mammogram-viewer.html #}
{# Standalone mammogram viewer page - receives updates via BroadcastChannel #}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mammogram viewer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #1a1a1a;
      color: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .viewer-header {
      background-color: #0d0d0d;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
    }

    .viewer-header__info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .viewer-header__name {
      font-size: 18px;
      font-weight: 600;
    }

    .viewer-header__details {
      font-size: 14px;
      color: #999;
    }

    .viewer-header__details span {
      margin-right: 16px;
    }

    .viewer-header__actions {
      display: flex;
      gap: 8px;
    }

    .viewer-button {
      background-color: #333;
      color: #fff;
      border: 1px solid #555;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
    }

    .viewer-button:hover {
      background-color: #444;
    }

    .viewer-button--close {
      background-color: #8b0000;
      border-color: #a00;
    }

    .viewer-button--close:hover {
      background-color: #a00;
    }

    .viewer-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 4px;
      padding: 4px;
      min-height: 0;
    }

    .viewer-panel {
      background-color: #000;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .viewer-panel--right {
      justify-content: flex-end;
    }

    .viewer-panel--left {
      justify-content: flex-start;
    }

    .viewer-panel__label {
      position: absolute;
      top: 8px;
      left: 8px;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 2px;
      z-index: 1;
    }

    .viewer-panel__label--right {
      left: auto;
      right: 8px;
    }

    .viewer-panel__image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      cursor: zoom-in;
    }

    .viewer-panel__missing {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      color: #555;
      font-size: 14px;
      font-style: italic;
    }

    .viewer-placeholder {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #666;
      text-align: center;
      padding: 40px;
    }

    .viewer-placeholder__icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .viewer-placeholder__text {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .viewer-placeholder__hint {
      font-size: 14px;
      color: #555;
    }

    .viewer-status {
      background-color: #0d0d0d;
      padding: 8px 16px;
      font-size: 12px;
      color: #666;
      border-top: 1px solid #333;
      flex-shrink: 0;
    }

    .viewer-zoom {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: zoom-out;
    }

    .viewer-zoom__image {
      max-width: 95%;
      max-height: 95%;
      object-fit: contain;
    }

    .viewer-zoom__label {
      position: absolute;
      top: 16px;
      left: 16px;
      background-color: rgba(0, 0, 0, 0.8);
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 4px;
    }

    .viewer-debug {
      position: fixed;
      bottom: 32px;
      left: 0;
      right: 0;
      background-color: rgba(50, 50, 0, 0.9);
      border-top: 1px solid #666;
      padding: 8px 16px;
      font-size: 13px;
      font-family: monospace;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .viewer-debug__label {
      color: #888;
    }

    .viewer-debug__id {
      color: #fff;
      font-weight: bold;
    }

    .viewer-debug__tag {
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      text-transform: uppercase;
    }

    .viewer-debug__tag--normal {
      background-color: #0a5;
      color: #fff;
    }

    .viewer-debug__tag--abnormal {
      background-color: #d00;
      color: #fff;
    }

    .viewer-debug__tag--technical {
      background-color: #c80;
      color: #000;
    }

    .viewer-debug__tag--indeterminate {
      background-color: #666;
      color: #fff;
    }

    .viewer-debug__description {
      color: #ccc;
      flex: 1;
    }

    .viewer-debug__context {
      color: #888;
      font-size: 11px;
      margin-left: auto;
    }

    .viewer-debug__context-flag {
      display: inline-block;
      padding: 2px 6px;
      margin-left: 4px;
      border-radius: 3px;
      background-color: #444;
      color: #fff;
    }

    .viewer-debug__context-flag--active {
      background-color: #06c;
    }

    .viewer-additional-link {
      position: fixed;
      bottom: 40px;
      right: 16px;
      background-color: rgba(200, 100, 0, 0.9);
      color: #fff;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      z-index: 100;
    }

    .viewer-additional-link:hover {
      background-color: rgba(220, 120, 0, 1);
    }

    .viewer-additional-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.95);
      z-index: 9998;
      display: flex;
      flex-direction: column;
      padding: 16px;
    }

    .viewer-additional-modal__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-shrink: 0;
    }

    .viewer-additional-modal__title {
      font-size: 18px;
      font-weight: 600;
    }

    .viewer-additional-modal__close {
      background-color: #333;
      color: #fff;
      border: 1px solid #555;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
    }

    .viewer-additional-modal__close:hover {
      background-color: #444;
    }

    .viewer-additional-modal__content {
      flex: 1;
      overflow-y: auto;
    }

    .viewer-additional-modal__view {
      margin-bottom: 24px;
    }

    .viewer-additional-modal__view-label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #999;
    }

    .viewer-additional-modal__images {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .viewer-additional-modal__image-container {
      position: relative;
    }

    .viewer-additional-modal__image {
      max-height: 300px;
      max-width: 300px;
      object-fit: contain;
      border: 2px solid #333;
      border-radius: 4px;
      cursor: zoom-in;
    }

    .viewer-additional-modal__image:hover {
      border-color: #666;
    }

    .viewer-additional-modal__image--latest {
      border-color: #0a5;
    }

    .viewer-additional-modal__image-label {
      position: absolute;
      bottom: 4px;
      left: 4px;
      background-color: rgba(0, 0, 0, 0.8);
      padding: 2px 6px;
      font-size: 11px;
      border-radius: 2px;
    }

    .viewer-additional-modal__image-label--latest {
      background-color: rgba(0, 160, 80, 0.9);
    }
  </style>
</head>
<body>
  <header class="viewer-header" id="viewer-header" style="display: none;">
    <div class="viewer-header__info">
      <div class="viewer-header__name" id="participant-name"></div>
      <div class="viewer-header__details" id="participant-details">
      </div>
    </div>
    <div class="viewer-header__actions">
      <button class="viewer-button viewer-button--close" onclick="window.close()">
        Close viewer
      </button>
    </div>
  </header>

  <div class="viewer-grid" id="viewer-grid" style="display: none;">
    <div class="viewer-panel viewer-panel--right" id="panel-rcc">
      <span class="viewer-panel__label">RCC</span>
      <img class="viewer-panel__image" id="image-rcc" alt="Right craniocaudal view" data-view="RCC">
      <div class="viewer-panel__missing" id="missing-rcc" style="display: none;">
        <span>No image</span>
      </div>
    </div>
    <div class="viewer-panel viewer-panel--left" id="panel-lcc">
      <span class="viewer-panel__label viewer-panel__label--right">LCC</span>
      <img class="viewer-panel__image" id="image-lcc" alt="Left craniocaudal view" data-view="LCC">
      <div class="viewer-panel__missing" id="missing-lcc" style="display: none;">
        <span>No image</span>
      </div>
    </div>
    <div class="viewer-panel viewer-panel--right" id="panel-rmlo">
      <span class="viewer-panel__label">RMLO</span>
      <img class="viewer-panel__image" id="image-rmlo" alt="Right mediolateral oblique view" data-view="RMLO">
      <div class="viewer-panel__missing" id="missing-rmlo" style="display: none;">
        <span>No image</span>
      </div>
    </div>
    <div class="viewer-panel viewer-panel--left" id="panel-lmlo">
      <span class="viewer-panel__label viewer-panel__label--right">LMLO</span>
      <img class="viewer-panel__image" id="image-lmlo" alt="Left mediolateral oblique view" data-view="LMLO">
      <div class="viewer-panel__missing" id="missing-lmlo" style="display: none;">
        <span>No image</span>
      </div>
    </div>
  </div>

  <div class="viewer-placeholder" id="viewer-placeholder">
    <div class="viewer-placeholder__icon">ðŸ”¬</div>
    <div class="viewer-placeholder__text">Waiting for participant</div>
    <div class="viewer-placeholder__hint">Open a case in the reading workflow to view mammograms</div>
  </div>

  <button class="viewer-additional-link" id="additional-link" style="display: none;">
    View additional images
  </button>

  <footer class="viewer-status" id="viewer-status">
    Listening for updates...
  </footer>

  <div class="viewer-debug" id="viewer-debug" style="display: none;">
    <span class="viewer-debug__label">Set:</span>
    <span class="viewer-debug__id" id="debug-set-id"></span>
    <span class="viewer-debug__tag" id="debug-set-tag"></span>
    <span class="viewer-debug__description" id="debug-set-description"></span>
    <span class="viewer-debug__context" id="debug-context"></span>
  </div>

  <script>
    // Mammogram viewer - listens for BroadcastChannel messages
    const CHANNEL_NAME = "mammogram-viewer"

    let currentEventId = null
    let channel = null

    // DOM elements
    const headerEl = document.getElementById("viewer-header")
    const gridEl = document.getElementById("viewer-grid")
    const placeholderEl = document.getElementById("viewer-placeholder")
    const statusEl = document.getElementById("viewer-status")
    const nameEl = document.getElementById("participant-name")
    const detailsEl = document.getElementById("participant-details")
    const imageEls = {
      rcc: document.getElementById("image-rcc"),
      lcc: document.getElementById("image-lcc"),
      rmlo: document.getElementById("image-rmlo"),
      lmlo: document.getElementById("image-lmlo")
    }
    const missingEls = {
      rcc: document.getElementById("missing-rcc"),
      lcc: document.getElementById("missing-lcc"),
      rmlo: document.getElementById("missing-rmlo"),
      lmlo: document.getElementById("missing-lmlo")
    }

    // Debug elements
    const debugEl = document.getElementById("viewer-debug")
    const debugSetIdEl = document.getElementById("debug-set-id")
    const debugSetTagEl = document.getElementById("debug-set-tag")
    const debugSetDescEl = document.getElementById("debug-set-description")
    const debugContextEl = document.getElementById("debug-context")
    let debugVisible = false

    // Additional images elements
    const additionalLinkEl = document.getElementById("additional-link")
    let currentAllPaths = null

    // Current set info for debug display
    let currentSetInfo = null

    /**
     * Show modal with all additional images
     */
    const showAdditionalImages = () => {
      if (!currentAllPaths) return

      const viewLabels = {
        rcc: "Right CC",
        lcc: "Left CC",
        rmlo: "Right MLO",
        lmlo: "Left MLO"
      }

      // Build modal content
      let contentHtml = ""
      for (const view of ["rmlo", "lmlo", "rcc", "lcc"]) {
        const paths = currentAllPaths[view]
        if (!paths) continue

        const pathArray = Array.isArray(paths) ? paths : [paths]
        if (pathArray.length === 0) continue

        contentHtml += `<div class="viewer-additional-modal__view">
          <div class="viewer-additional-modal__view-label">${viewLabels[view]} (${pathArray.length} image${pathArray.length > 1 ? "s" : ""})</div>
          <div class="viewer-additional-modal__images">`

        pathArray.forEach((path, index) => {
          const isLatest = index === pathArray.length - 1
          const label = isLatest ? "Latest" : `Attempt ${index + 1}`
          const zoomLabel = `${viewLabels[view]} - ${label}`
          contentHtml += `<div class="viewer-additional-modal__image-container">
            <img class="viewer-additional-modal__image${isLatest ? " viewer-additional-modal__image--latest" : ""}" src="${path}" alt="${viewLabels[view]} attempt ${index + 1}" data-zoom-label="${zoomLabel}">
            <span class="viewer-additional-modal__image-label${isLatest ? " viewer-additional-modal__image-label--latest" : ""}">${label}</span>
          </div>`
        })

        contentHtml += `</div></div>`
      }

      // Create and show modal
      const modalEl = document.createElement("div")
      modalEl.className = "viewer-additional-modal"
      modalEl.id = "additional-modal"
      modalEl.innerHTML = `
        <div class="viewer-additional-modal__header">
          <div class="viewer-additional-modal__title">All images (including retakes)</div>
          <button class="viewer-additional-modal__close" id="close-additional-modal">Close</button>
        </div>
        <div class="viewer-additional-modal__content">${contentHtml}</div>
      `

      document.body.appendChild(modalEl)

      // Add click handlers to images for zoom
      modalEl.querySelectorAll(".viewer-additional-modal__image").forEach((imgEl) => {
        imgEl.addEventListener("click", (e) => {
          e.stopPropagation()
          const zoomLabel = imgEl.getAttribute("data-zoom-label")
          showZoom(imgEl.src, zoomLabel)
        })
      })

      // Close button handler
      document.getElementById("close-additional-modal").addEventListener("click", () => {
        modalEl.remove()
      })

      // Close on escape
      const escHandler = (e) => {
        if (e.key === "Escape") {
          modalEl.remove()
          document.removeEventListener("keydown", escHandler)
        }
      }
      document.addEventListener("keydown", escHandler)
    }

    // Attach click handler to additional images link
    additionalLinkEl.addEventListener("click", showAdditionalImages)

    /**
     * Toggle debug info visibility (press 'd' to toggle)
     */
    const toggleDebug = () => {
      debugVisible = !debugVisible
      debugEl.style.display = debugVisible ? "flex" : "none"
      if (debugVisible && currentSetInfo) {
        updateDebugInfo(currentSetInfo)
      }
    }

    /**
     * Update the debug info display
     */
    const updateDebugInfo = (data) => {
      currentSetInfo = data
      if (!debugVisible) return

      debugSetIdEl.textContent = data.setId || "unknown"
      debugSetDescEl.textContent = data.setDescription || ""

      // Update tag with color coding
      const tag = data.setTag || "unknown"
      debugSetTagEl.textContent = tag
      debugSetTagEl.className = `viewer-debug__tag viewer-debug__tag--${tag}`

      // Update context flags
      const context = data.context || {}
      const flags = []
      if (context.hasSymptoms) {
        const sides = context.symptomSides?.length > 0 ? ` (${context.symptomSides.join(", ")})` : ""
        flags.push(`<span class="viewer-debug__context-flag viewer-debug__context-flag--active">symptoms${sides}</span>`)
      }
      if (context.hasImplants) {
        flags.push(`<span class="viewer-debug__context-flag viewer-debug__context-flag--active">implants</span>`)
      }
      if (context.isImperfect) {
        flags.push(`<span class="viewer-debug__context-flag viewer-debug__context-flag--active">imperfect</span>`)
      }
      debugContextEl.innerHTML = flags.length > 0 ? flags.join("") : "<span style='color:#666'>no flags</span>"
    }

    // Listen for 'd' key to toggle debug
    document.addEventListener("keydown", (e) => {
      if (e.key === "d" || e.key === "D") {
        toggleDebug()
      }
    })

    /**
     * Show the placeholder (no participant loaded)
     */
    const showPlaceholder = () => {
      headerEl.style.display = "none"
      gridEl.style.display = "none"
      placeholderEl.style.display = "flex"
      additionalLinkEl.style.display = "none"
      currentEventId = null
      currentAllPaths = null
      updateStatus("Waiting for participant...")
    }

    /**
     * Update a single view panel - show image or missing placeholder
     */
    const updateViewPanel = (view, imagePath) => {
      const imageEl = imageEls[view]
      const missingEl = missingEls[view]

      if (imagePath) {
        imageEl.src = imagePath
        imageEl.style.display = "block"
        missingEl.style.display = "none"
      } else {
        imageEl.style.display = "none"
        imageEl.src = ""
        missingEl.style.display = "flex"
      }
    }

    /**
     * Render participant details in single line
     */
    const renderDetails = (data) => {
      const details = []
      
      if (data.nhsNumber) {
        details.push(`NHS: ${data.nhsNumber}`)
      }
      if (data.sxNumber) {
        details.push(`SX: ${data.sxNumber}`)
      }
      if (data.dateOfBirth) {
        details.push(`DOB: ${data.dateOfBirth}`)
      }
      
      detailsEl.innerHTML = details.map(d => `<span>${d}</span>`).join('')
    }

    /**
     * Show mammograms for a participant
     */
    const showMammograms = (data) => {
      // Log set info to console for debugging
      console.log('%c[Mammogram Set]', 'color: #0f0; font-weight: bold', {
        id: data.setId,
        tag: data.setTag,
        description: data.setDescription,
        context: data.context,
        hasAdditionalImages: data.hasAdditionalImages
      })

      // Update header
      nameEl.textContent = data.participantName || "Unknown"
      renderDetails(data)

      // Update images - show placeholder for missing views
      if (data.images) {
        updateViewPanel("rcc", data.images.rcc)
        updateViewPanel("lcc", data.images.lcc)
        updateViewPanel("rmlo", data.images.rmlo)
        updateViewPanel("lmlo", data.images.lmlo)
      }

      // Store all paths and show/hide additional images link
      currentAllPaths = data.allPaths
      if (data.hasAdditionalImages) {
        additionalLinkEl.style.display = "block"
      } else {
        additionalLinkEl.style.display = "none"
      }

      // Update debug info if visible
      updateDebugInfo(data)

      // Show viewer
      placeholderEl.style.display = "none"
      headerEl.style.display = "flex"
      gridEl.style.display = "grid"

      currentEventId = data.eventId
      updateStatus(`Viewing: ${data.participantName}`)
    }

    /**
     * Update status bar
     */
    const updateStatus = (text) => {
      statusEl.textContent = text
    }

    /**
     * Handle incoming messages
     */
    const handleMessage = (event) => {
      const data = event.data

      if (data.type === "ping") {
        // Respond to ping with pong so parent knows we're open
        channel.postMessage({ type: "pong", timestamp: Date.now() })
      } else if (data.type === "show") {
        // Ignore if same event already displayed
        if (data.eventId === currentEventId) {
          return
        }
        showMammograms(data)
      } else if (data.type === "clear") {
        showPlaceholder()
      }
    }

    /**
     * Show image in fullscreen zoom
     */
    const showZoom = (imageSrc, viewLabel) => {
      const zoomEl = document.createElement('div')
      zoomEl.className = 'viewer-zoom'
      zoomEl.innerHTML = `
        <div class="viewer-zoom__label">${viewLabel}</div>
        <img class="viewer-zoom__image" src="${imageSrc}" alt="${viewLabel}">
      `
      
      // Close on click
      zoomEl.addEventListener('click', () => {
        document.body.removeChild(zoomEl)
      })
      
      // Close on escape key
      const handleEscape = (e) => {
        if (e.key === 'Escape') {
          document.body.removeChild(zoomEl)
          document.removeEventListener('keydown', handleEscape)
        }
      }
      document.addEventListener('keydown', handleEscape)
      
      document.body.appendChild(zoomEl)
    }

    /**
     * Add click handlers to images for zoom
     */
    const setupZoomHandlers = () => {
      Object.entries(imageEls).forEach(([view, imgEl]) => {
        imgEl.addEventListener('click', (e) => {
          if (imgEl.src && imgEl.style.display !== 'none') {
            e.stopPropagation()
            const viewLabel = imgEl.getAttribute('data-view')
            showZoom(imgEl.src, viewLabel)
          }
        })
      })
    }

    /**
     * Initialise the viewer
     */
    const init = () => {
      if (typeof BroadcastChannel === "undefined") {
        updateStatus("Error: BroadcastChannel not supported in this browser")
        return
      }

      channel = new BroadcastChannel(CHANNEL_NAME)
      channel.addEventListener("message", handleMessage)

      // Request current participant data from any open parent pages
      channel.postMessage({
        type: "request-current",
        timestamp: Date.now()
      })

      // Setup zoom click handlers
      setupZoomHandlers()

      updateStatus("Listening for updates...")
    }

    // Start
    init()
  </script>
</body>
</html>
