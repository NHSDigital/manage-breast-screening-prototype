{# /app/views/reading/batch.html #}

{% extends 'layout-app.html' %}

{% set back = {
  href: "/reading",
  text: "Back to reading"
} %}

{% set pageHeading %}
  {{ batch.name }}
{% endset %}

{% set gridColumn = "none" %}

{% block pageContent %}
{{ batch | log("Batch")}}
<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-full">
    <div class="app-header-with-status">
      <span class="nhsuk-caption-l">Image reading batch</span>
      <h1 class="nhsuk-heading-l">
        {{ pageHeading }}
      </h1>
      <div class="app-header-with-status__status-tag">
        {{ readingStatus.status | formatWords | sentenceCase | toTag }}
      </div>
    </div>
  </div>
</div>
<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-full">
    <p>Created {{ batch.createdAt | formatRelativeDate }}</p>

    {# Reading progress #}
    {% set insetTextHtml %}
      <p>Reading status:</p>
      <ul class="nhsuk-list">
        <li>First read: {{ readingStatus.firstReadCount }} complete, {{ readingStatus.firstReadRemaining }} remaining</li>
        <li>Second read: {{ readingStatus.secondReadCount }} complete, {{ readingStatus.secondReadReady }} ready for 2nd read</li>
        {% if batch.skippedEvents | length > 0 %}
          <li>{{ batch.skippedEvents | length }} cases skipped</li>
        {% endif %}
        {% if readingStatus.arbitrationCount > 0 %}
          <li>{{ readingStatus.arbitrationCount }} cases need arbitration</li>
        {% endif %}
      </ul>
    {% endset %}

    {{ insetText({
      html: insetTextHtml
    }) }}

    {% if firstUserReadableEvent %}
      {% set currentUserHasRead = false %}
      {% for event in events %}
        {% set metadata = event.readingMetadata %}
        {% for read in metadata.reads %}
          {% if read.readerId === data.currentUser.id %}
            {% set currentUserHasRead = true %}
          {% endif %}
        {% endfor %}
      {% endfor %}

      <a href="/reading/batch/{{ batch.id }}/events/{{ firstUserReadableEvent.id }}" class="nhsuk-button">
        {{ "Resume reading" if currentUserHasRead else "Start reading" }}
      </a>
    {% else %}
      {% set notificationBannerHtml %}
        <h3 class="nhsuk-notification-banner__heading">
          All records in this batch have been reviewed
        </h3>
        <p class="nhsuk-body">You can revisit each record of the summary below or return to the <a href="/reading">reading task list</a></p>
      {% endset %}

      {{ appNotificationBanner({
        html: notificationBannerHtml,
        type: "success"
      }) }}
    {% endif %}

    {% set groupedEvents = events | groupby("readingMetadata.secondReadComplete") %}
    {% set eventsNeedingReading = groupedEvents["false"] %}
    {% set completedEvents = groupedEvents["true"] %}

    {# Default order is true, false, but we want to reverse it #}
    {% for completeState in ['false', 'true'] %}
      {% if groupedEvents[completeState] %}
        <h2>
          {% if completeState == 'false' %}
            Cases needing reading
          {% else %}
            Completely read cases
          {% endif %}
          ({{ groupedEvents[completeState] | length }})
        </h2>

        <table class="nhsuk-table">
          <thead>
            <tr>
              <th>Cases</th>
              <th>First read</th>
              <th>Second read</th>
              <th>Outcome</th>
            </tr>
          </thead>
          <tbody>
            {% for event in groupedEvents[completeState] %}
              {% set metadata = event.readingMetadata %}
              <tr>
                <td>
                  {% set readingHref -%}
                    /reading/batch/{{ batch.id }}/events/{{ event.id }}
                  {%- endset %}
                  <a href="{{ readingHref if metadata.readCount < 2 else '#' }}">{{ event.participant | getFullName }}</a>
                  {% if event.currentSymptoms | length %}
                  <br>
                    {{ tag({
                      text: "Has symptoms",
                      classes: "nhsuk-tag--yellow"
                    })}}
                  {% endif %}
                  {% if (data.settings.reading.showRepeatsTag | falsify) and event.mammogramData.metadata.hasRepeat %}
                  <br>
                    {{ tag({
                      text: "Has repeat",
                      classes: "nhsuk-tag--yellow"
                    })}}
                  {% endif %}
                </td>
                {# First read column #}
                <td>
                  {% set skipped = "Skipped" if batch.skippedEvents | includes(event.id) else false %}
                  {% set isBlind = data.settings.reading.blindReading | falsify %}
                  {% set isCurrentUserRead = false %}
                  {% if metadata.readCount >= 1 %}
                  {% set firstRead = metadata.reads[0] %}
                  {% set isCurrentUserRead = firstRead.readerId === data.currentUser.id %}

                    {% if isBlind and not isCurrentUserRead and metadata.readCount < 2 %}
                      {{ "Completed (blind)" | toTag({colour: "blue"}) }}
                    {% else %}
                      {% if metadata.readCount >= 2 %}
                        {{ firstRead.result | formatWords | sentenceCase | toTag({colour: "grey"}) }}
                      {% else %}
                        {{ firstRead.result | formatWords | sentenceCase | toTag }}
                      {% endif %}
                    {% endif %}

                    <br>
                    <span class="app-text-grey app-nowrap nhsuk-body-s">by {{ firstRead.readerId | getUsername({identifyCurrentUser: true}) }}</span>
                  {% elif skipped %}
                    {{ "Skipped" | toTag({color: "grey"}) }}
                  {% else %}
                    {{ "Not read" | toTag({color: "grey"}) }}
                  {% endif %}
                </td>
                {# Second read column #}
                <td>
                  {% set isBlind = data.settings.reading.blindReading | falsify %}
                  {% set isCurrentUserRead = false %}

                  {% if metadata.readCount >= 2 %}
                    {% set secondRead = metadata.reads[1] %}
                    {% set isCurrentUserRead = secondRead.readerId === data.currentUser.id %}

                    {{ secondRead.result | formatWords | sentenceCase | toTag({colour: "grey"}) }}

                    <br>
                    <span class="app-text-grey app-nowrap nhsuk-body-s">by {{ secondRead.readerId | getUsername({identifyCurrentUser: true}) }}</span>
                  {% elif metadata.readCount == 1 %}
                    {% if skipped %}
                      {{ "Skipped" | toTag({color: "grey"}) }}
                    {% else %}
                      {{ "Not read" | toTag({colour: "blue"}) }}
                    {% endif %}
                  {% else %}
                    {{ "Waiting for 1st read" | toTag({colour: "grey"}) }}
                  {% endif %}
                </td>
                {# Outcome column #}
                <td>
                  {% if metadata.readCount >= 2 %}
                    {% if metadata.hasDisagreement %}
                      {{ "Arbitration" | toTag({colour: "orange"}) }}
                    {% else %}
                      {% set result = metadata.reads[0].result %}
                      {% if result == "normal" %}
                        {{ "Normal" | toTag("green") }}
                      {% elif result == "technical_recall" %}
                        {{ "Technical recall" | toTag({colour: "orange"}) }}
                      {% elif result == "recall_for_assessment" %}
                        {{ "Recall for assessment" | toTag({colour: "red"}) }}
                      {% else %}
                        {{ result | formatWords | sentenceCase | toTag }}
                      {% endif %}
                    {% endif %}
                  {% elif metadata.readCount == 1 %}
                    {{ "Waiting for 2nd read" | toTag({colour: "grey"}) }}
                  {% else %}
                    {{ "Waiting for 1st read" | toTag({colour: "grey"}) }}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% endfor %}
  </div>
</div>
{% endblock %}