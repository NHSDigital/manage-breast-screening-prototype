{# /app/views/reading/batch.html #}

{% extends 'layout-app.html' %}

{% set back = {
  href: "/reading",
  text: "Back to reading"
} %}

{% set pageHeading %}
  {{ batch.name }}
{% endset %}

{% set gridColumn = "none" %}

{% block pageContent %}
<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-full">
    <div class="app-header-with-status">
      <span class="nhsuk-caption-l">Image reading batch</span>
      <h1 class="nhsuk-heading-l">
        {{ pageHeading }}
      </h1>
      {% set isClinicContext = batch.clinicId %}
      {% if isClinicContext %}
        <div class="app-header-with-status__status-tag">
          {{ readingStatus.status | formatWords | sentenceCase | toTag }}
        </div>
      {% endif %}
    </div>
  </div>
</div>
<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-full">

    {% set currentUserHasRead = false %}
    {% for event in events %}
      {% if event | userHasReadEvent(data.currentUser.id) %}
        {% set currentUserHasRead = true %}
      {% endif %}
    {% endfor %}

    {% if firstUserReadableEvent %}

      {# Reading progress #}
      {% set insetTextHtml %}
        <p>Reading status:</p>
        <ul class="nhsuk-list">
          <li>First read: {{ readingStatus.firstReadCount }} complete, {{ readingStatus.firstReadRemaining }} remaining</li>
          <li>Second read: {{ readingStatus.secondReadCount }} complete, {{ readingStatus.secondReadReady }} ready for 2nd read</li>
          {% if batch.skippedEvents | length > 0 %}
            <li>{{ batch.skippedEvents | length }} cases skipped</li>
          {% endif %}
          {% if readingStatus.arbitrationCount > 0 %}
            <li>{{ readingStatus.arbitrationCount }} cases need arbitration</li>
          {% endif %}
        </ul>
      {% endset %}

      {{ insetText({
        html: insetTextHtml
      }) }}

      <a href="/reading/batch/{{ batch.id }}/events/{{ firstUserReadableEvent.id }}" class="nhsuk-button">
        {{ "Resume reading" if currentUserHasRead else "Start reading" }}
      </a>
    {% else %}
      {% set notificationBannerHtml %}
        <h3 class="nhsuk-notification-banner__heading">
          {{ "All cases in this batch have been read" if not currentUserHasRead else "You have read all available cases" }}
        </h3>
      {% endset %}

      {{ appNotificationBanner({
        html: notificationBannerHtml,
        type: "success"
      }) }}
    {% endif %}

    {# Organize events into three categories #}
    {% set userCanReadEvents = [] %}
    {% set userHasReadEvents = [] %}
    {% set completelyReadEvents = [] %}

    {% for event in events %}
      {% set metadata = event.readingMetadata %}

      {# Categorize events #}
      {% if metadata.secondReadComplete %}
        {% set completelyReadEvents = completelyReadEvents | push(event) %}
      {% elif event | userHasReadEvent %}
        {% set userHasReadEvents = userHasReadEvents | push(event) %}
      {% elif event | canUserReadEvent %}
        {% set userCanReadEvents = userCanReadEvents | push(event) %}
      {% else %}
        {# Events the user can't read (other readers involved) #}
        {% if not metadata.secondReadComplete %}
          {% set userHasReadEvents = userHasReadEvents | push(event) %}
        {% endif %}
      {% endif %}
    {% endfor %}

    {# Display categories in the desired order #}
    {% set categories = [
      {
        title: "Cases you can read",
        events: userCanReadEvents,
        empty_message: "No cases available for you to read"
      },
      {
        title: "Your first reads",
        events: userHasReadEvents
      },
      {
        title: "Completed first and second reads",
        events: completelyReadEvents,
        empty_message: "No completely read cases yet"
      }
    ] %}

    {% for category in categories %}
      {% if category.events | length %}
        <h2>{{ category.title }} ({{ category.events | length }})</h2>
      {% endif %}


      {% if category.events | length > 0 %}
        <table class="nhsuk-table">
          <thead>
            <tr>
              <th>Case</th>
              <th>First read</th>
              <th>Second read</th>
              <th>Outcome</th>
            </tr>
          </thead>
          <tbody>
            {% for event in category.events %}
              {% set metadata = event.readingMetadata %}
              <tr>
                <td>
                  {% set readingHref -%}
                    /reading/batch/{{ batch.id }}/events/{{ event.id }}
                  {%- endset %}
                  <a href="{{ readingHref if metadata.readCount < 2 or category.title === 'Cases you can read' else '#' }}">{{ event.participant | getFullName }}</a>
                  <br>
                  <span class="app-text-grey app-nowrap nhsuk-body-s nhsuk-u-margin-bottom-2">
                    Screened {{ event.timing.startTime | formatRelativeDate }}
                  </span>
                  {% if event.currentSymptoms | length %}
                    {{ tag({
                      text: "Has symptoms",
                      classes: "nhsuk-tag--yellow"
                    })}}
                  {% endif %}
                  {% if (data.settings.reading.showRepeatsTag | falsify) and event.mammogramData.metadata.hasRepeat %}
                  <br>
                    {{ tag({
                      text: "Has repeat",
                      classes: "nhsuk-tag--yellow"
                    })}}
                  {% endif %}
                </td>
                {# First read column #}
                <td>
                  {% set skipped = "Skipped" if batch.skippedEvents | includes(event.id) else false %}
                  {% set isBlind = data.settings.reading.blindReading | falsify %}
                  {% set isCurrentUserRead = false %}
                  {% if metadata.readCount >= 1 %}
                    {% set firstRead = metadata.reads[0] %}
                    {% set isCurrentUserRead = firstRead.readerId === data.currentUser.id %}

                    {% if isBlind and not isCurrentUserRead and metadata.readCount < 2 %}
                      {{ "Completed (blind)" | toTag({colour: "blue"}) }}
                    {% else %}
                      {% if metadata.readCount >= 2 %}
                        {{ firstRead.result | formatWords | sentenceCase | toTag({colour: "grey"}) }}
                      {% else %}
                        {{ firstRead.result | formatWords | sentenceCase | toTag }}
                      {% endif %}
                    {% endif %}

                    <br>
                    <span class="app-text-grey app-nowrap nhsuk-body-s">by {{ firstRead.readerId | getUsername({identifyCurrentUser: true}) }}</span>
                  {% elif skipped %}
                    {{ "Skipped" | toTag({colour: "grey"}) }}
                  {% else %}
                    {{ "Not read" | toTag({colour: "grey"}) }}
                  {% endif %}
                </td>
                {# Second read column #}
                <td>
                  {% set isBlind = data.settings.reading.blindReading | falsify %}
                  {% set isCurrentUserRead = false %}

                  {% if metadata.readCount >= 2 %}
                    {% set secondRead = metadata.reads[1] %}
                    {% set isCurrentUserRead = secondRead.readerId === data.currentUser.id %}

                    {{ secondRead.result | formatWords | sentenceCase | toTag({colour: "grey"}) }}

                    <br>
                    <span class="app-text-grey app-nowrap nhsuk-body-s">by {{ secondRead.readerId | getUsername({identifyCurrentUser: true}) }}</span>
                  {% elif metadata.readCount == 1 %}
                    {% if skipped %}
                      {{ "Skipped" | toTag({colour: "grey"}) }}
                    {% else %}
                      {{ "Not read" | toTag({colour: "grey"}) }}
                    {% endif %}
                  {% else %}
                    {{ "Waiting for 1st read" | toTag({colour: "grey"}) }}
                  {% endif %}
                </td>
                {# Outcome column #}
                <td>
                  {% if metadata.readCount >= 2 %}
                    {% if metadata.hasDisagreement %}
                      {{ "Arbitration" | toTag({colour: "orange"}) }}
                    {% else %}
                      {% set result = metadata.reads[0].result %}
                      {% if result == "normal" %}
                        {{ "Normal" | toTag("green") }}
                      {% elif result == "technical_recall" %}
                        {{ "Technical recall" | toTag({colour: "orange"}) }}
                      {% elif result == "recall_for_assessment" %}
                        {{ "Recall for assessment" | toTag({colour: "red"}) }}
                      {% else %}
                        {{ result | formatWords | sentenceCase | toTag }}
                      {% endif %}
                    {% endif %}
                  {% elif metadata.readCount == 1 %}
                    {{ "Waiting for 2nd read" | toTag({colour: "grey"}) }}
                  {% else %}
                    {{ "Waiting for 1st read" | toTag({colour: "grey"}) }}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        {# <p>{{ category.empty_message }}</p> #}
      {% endif %}
    {% endfor %}
  </div>
</div>
{% endblock %}