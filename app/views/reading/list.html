{# /app/views/events/reading/list.html #}

{% extends 'layout-app.html' %}

{% set back = {
  href: "/reading",
  text: "Back to reading"
} %}

{% set clinicRiskType %}
  {% if clinic.riskLevels | length == 1 %}
    {{ clinic.riskLevels[0] }}
  {% else %}
    Mixed
  {% endif %}
{% endset %}

{% set pageHeading %}
  {{ clinicRiskType | sentenceCase }} risk {{ clinic.clinicType | lower }} clinic
{% endset %}

{% set gridColumn = "none" %}

{% block pageContent %}

<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-full">
    <div class="app-header-with-status">
      <span class="nhsuk-caption-l">Image reading</span>
      <h1 class="nhsuk-heading-l">
        {{ pageHeading }}
      </h1>
      <div class="app-header-with-status__status-tag">
        {{ readingStatus.status | formatWords | sentenceCase | toTag }}
      </div>
    </div>
  </div>
</div>
<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-full">
    <p>{{ clinic.date | formatDate }} ({{ clinic.date | formatRelativeDate | sentenceCase }})</p>

    {{ data.readingSession.skippedEvents | log("Progress") }}
    {{ readingStatus | log("Reading status") }}
    {{ events | log("Events") }}
    {{ clinic | log("Clinic")}}

    {# Check if there are events this user can read #}
    {% if readingStatus.userReadableCount > 0 or readingStatus.firstReadRemaining > 0 or readingStatus.secondReadReady > 0 %}
      {# Reading progress #}
      {% set insetTextHtml %}
        <p>Reading status:</p>
        <ul class="nhsuk-list">
          <li>First read: {{ readingStatus.firstReadCount }} complete, {{ readingStatus.firstReadRemaining }} remaining</li>
          <li>Second read: {{ readingStatus.secondReadCount }} complete, {{ readingStatus.secondReadReady }} ready for 2nd read</li>
          {% if data.readingSession.skippedEvents | length > 0 %}
            <li>{{ data.readingSession.skippedEvents | length }} cases skipped</li>
          {% endif %}
          {% if readingStatus.arbitrationCount > 0 %}
            <li>{{ readingStatus.arbitrationCount }} cases need arbitration</li>
          {% endif %}
        </ul>
      {% endset %}

      {{ insetText({
        html: insetTextHtml
      }) }}

      {% if firstUserReadableEvent %}
      {% set currentUserHasRead = false %}
      {% for event in events %}
        {% set metadata = event | getReadingMetadata %}
        {% for read in metadata.reads %}
          {% if read.readerId === data.currentUser.id %}
            {% set currentUserHasRead = true %}
          {% endif %}
        {% endfor %}
      {% endfor %}

      <a href="/reading/clinics/{{ clinicId }}/events/{{ firstUserReadableEvent.id }}" class="nhsuk-button">
        {{ "Resume reading" if currentUserHasRead else "Start reading" }}
      </a>
    {% endif %}

    {# All reading complete #}
    {% else %}
      {% set notificationBannerHtml %}
        <h3 class="nhsuk-notification-banner__heading">
          All records in this list have been reviewed
        </h3>
        <p class="nhsuk-body">You can revisit each record of the summary below or return to the <a href="/reading">reading task list</a></p>
      {% endset %}

      {{ appNotificationBanner({
        html: notificationBannerHtml,
        type: "success"
      }) }}
    {% endif %}

    <table class="nhsuk-table">
      <thead>
        <tr>
          <th>Cases</th>
          <th>First read</th>
          <th>Second read</th>
          <th>Outcome</th>
        </tr>
      </thead>
      <tbody>
        {% for event in events %}
          {% set metadata = event | getReadingMetadata %}
          <tr>
            <td>
              {% set readingHref -%}
                /reading/clinics/{{ clinicId }}/events/{{ event.id }}
              {%- endset %}
              <a href="{{ readingHref if metadata.readCount < 2 else '#' }}">{{ event.participant | getFullName }}</a>
              {% if event.currentSymptoms | length %}
              <br>
                {{ tag({
                  text: "Has symptoms",
                  classes: "nhsuk-tag--yellow"
                })}}
              {% endif %}
              {% if (data.settings.reading.showRepeatsTag | falsify) and event.mammogramData.metadata.hasRepeat %}
              <br>
                {{ tag({
                  text: "Has repeat",
                  classes: "nhsuk-tag--yellow"
                })}}
              {% endif %}
            </td>
            {# First read column #}
            <td>
              {% set skipped = "Skipped" if data.readingSession.skippedEvents | includes(event.id) else false %}
              {% set isBlind = data.settings.reading.blindReading | falsify %}
              {% set isCurrentUserRead = false %}
              {% if metadata.readCount >= 1 %}
              {% set firstRead = metadata.reads[0] %}
              {% set isCurrentUserRead = firstRead.readerId === data.currentUser.id %}

                {% if isBlind and not isCurrentUserRead and metadata.readCount < 2 %}
                  {{ "Completed (blind)" | toTag({colour: "blue"}) }}
                {% else %}
                  {% if metadata.readCount >= 2 %}
                    {{ firstRead.result | formatWords | sentenceCase | toTag({colour: "grey"}) }}
                  {% else %}
                    {{ firstRead.result | formatWords | sentenceCase | toTag }}
                  {% endif %}

                {% endif %}

                <br>
                <span class="app-text-grey app-nowrap nhsuk-body-s">by {{ firstRead.readerId | getUsername({identifyCurrentUser: true}) }}</span>
              {% elif skipped %}
                {{ "Skipped" | toTag({color: "grey"}) }}
              {% else %}
                {{ "Not read" | toTag({color: "grey"}) }}
              {% endif %}
            </td>
            {# Second read column #}
            <td>
              {% set isBlind = data.settings.reading.blindReading | falsify %}
              {% set isCurrentUserRead = false %}

              {% if metadata.readCount >= 2 %}
                {% set secondRead = metadata.reads[1] %}
                {% set isCurrentUserRead = secondRead.readerId === data.currentUser.id %}


                {{ secondRead.result | formatWords | sentenceCase | toTag({colour: "grey"}) }}


                <br>
                <span class="app-text-grey app-nowrap nhsuk-body-s">by {{ secondRead.readerId | getUsername({identifyCurrentUser: true}) }}</span>
              {% elif metadata.readCount == 1 %}
                {{ "Not read" | toTag({colour: "blue"}) }}
              {% else %}
                {{ "Waiting for 1st read" | toTag({colour: "grey"}) }}
              {% endif %}
            </td>
            {# Outcome column #}
            <td>
              {% if metadata.readCount >= 2 %}
                {% if metadata.hasDisagreement %}
                  {{ "Arbitration" | toTag({colour: "orange"}) }}
                {% else %}
                  {% set result = metadata.reads[0].result %}
                  {% if result == "normal" %}
                    {{ "Normal" | toTag("green") }}
                  {% elif result == "technical_recall" %}
                    {{ "Technical recall" | toTag({colour: "orange"}) }}
                  {% elif result == "recall_for_assessment" %}
                    {{ "Recall for assessment" | toTag({colour: "red"}) }}
                  {% else %}
                    {{ result | formatWords | sentenceCase | toTag }}
                  {% endif %}
                {% endif %}
              {% elif metadata.readCount == 1 %}
                {{ "Waiting for 2nd read" | toTag({colour: "grey"}) }}
              {% else %}
                {{ "Waiting for 1st read" | toTag({colour: "grey"}) }}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}